---
title: è®¡ç®—æœºä¸­çš„IO
date: 2019-04-20 12:16:10
tags: 
    - IO
categories: 
    - è®¡ç®—æœºåŸºç¡€
---

ğŸ’ 

- 1. [è®¡ç®—æœºä¸­çš„IO](#è®¡ç®—æœºä¸­çš„io)
    - 1.1. [IOæ¨¡å‹](#ioæ¨¡å‹)
        - 1.1.1. [Blocking IO](#blocking-io)
        - 1.1.2. [Nonblocking IO](#nonblocking-io)
        - 1.1.3. [IO multiplexing](#io-multiplexing)
        - 1.1.4. [Signal driven IO](#signal-driven-io)
        - 1.1.5. [Asynchronous IO](#asynchronous-io)
        - 1.1.6. [ç»å…¸æ¯”å–»](#ç»å…¸æ¯”å–»)
    - 1.2. [é˜»å¡å’Œéé˜»å¡](#é˜»å¡å’Œéé˜»å¡)
    - 1.3. [åŒæ­¥å’Œå¼‚æ­¥](#åŒæ­¥å’Œå¼‚æ­¥)
    - 1.4. [åŒå¼‚æ­¥å’Œé˜»å¡](#åŒå¼‚æ­¥å’Œé˜»å¡)
- 2. [å¤šè·¯å¤ç”¨](#å¤šè·¯å¤ç”¨)
    - 2.1. [å¤šè·¯å¤ç”¨æ¨¡å‹](#å¤šè·¯å¤ç”¨æ¨¡å‹)
        - 2.1.1. [Reactor](#reactor)
        - 2.1.2. [Proactor](#proactor)
        - 2.1.3. [å¿™è½®è¯¢](#å¿™è½®è¯¢)
        - 2.1.4. [æ— å·®åˆ«è½®è¯¢](#æ— å·®åˆ«è½®è¯¢)
        - 2.1.5. [æœ€å°è½®è¯¢](#æœ€å°è½®è¯¢)
    - 2.2. [IOå¤šè·¯å¤ç”¨å‡½æ•°](#ioå¤šè·¯å¤ç”¨å‡½æ•°)
        - 2.2.1. [select](#select)
        - 2.2.2. [poll](#poll)
        - 2.2.3. [epoll](#epoll)

ğŸ’  2024-06-16 16:40:46
****************************************
# è®¡ç®—æœºä¸­çš„IO
> [å‚è€ƒ: IO - åŒæ­¥ï¼Œå¼‚æ­¥ï¼Œé˜»å¡ï¼Œéé˜»å¡ ](https://blog.csdn.net/historyasamirror/article/details/5778378)  

IOåœ¨è®¡ç®—æœºä¸­æŒ‡ Input/Outputï¼Œä¹Ÿå°±æ˜¯è¾“å…¥å’Œè¾“å‡ºã€‚ç”±äºç¨‹åºå’Œè¿è¡Œæ—¶æ•°æ®æ˜¯åœ¨å†…å­˜ä¸­é©»ç•™ï¼Œç”±CPUè¿™ä¸ªè¶…å¿«çš„è®¡ç®—æ ¸å¿ƒæ¥æ‰§è¡Œï¼Œæ¶‰åŠåˆ°æ•°æ®äº¤æ¢çš„åœ°æ–¹ï¼Œé€šå¸¸æ˜¯ç£ç›˜ã€ç½‘ç»œç­‰ï¼Œå°±éœ€è¦IOæ¥å£ã€‚

> [Linux IO](/Linux/Base/LinuxFile.md#io)

## IOæ¨¡å‹

- Blocking IO
- Nonblocking IO
- IO multiplexing
- Signal driven IO
- Asynchronous IO

> [å‚è€ƒ: ä½¿ç”¨å¼‚æ­¥ I/O å¤§å¤§æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½](https://www.ibm.com/developerworks/cn/linux/l-async/)  

### Blocking IO
> Blocking IOçš„ç‰¹ç‚¹å°±æ˜¯åœ¨IOæ‰§è¡Œçš„ä¸¤ä¸ªé˜¶æ®µéƒ½è¢« blockäº†

### Nonblocking IO
> ç”¨æˆ·è¿›ç¨‹ä¸æ–­è¯¢é—®å†…æ ¸æ•°æ®æœ‰æ²¡æœ‰å¥½, ä¸€æ—¦kernelä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œå¹¶ä¸”åˆå†æ¬¡æ”¶åˆ°äº†ç”¨æˆ·è¿›ç¨‹çš„è¯¢é—®(system call)ï¼Œé‚£ä¹ˆå®ƒé©¬ä¸Šå°±å°†æ•°æ®æ‹·è´åˆ°äº†ç”¨æˆ·å†…å­˜ï¼Œç„¶åè¿”å›ã€‚

### IO multiplexing
> å½“ç”¨æˆ·è¿›ç¨‹è°ƒç”¨äº†selectï¼Œé‚£ä¹ˆæ•´ä¸ªè¿›ç¨‹ä¼šè¢«blockï¼Œè€ŒåŒæ—¶ï¼Œkernelä¼šâ€œç›‘è§†â€æ‰€æœ‰selectè´Ÿè´£çš„socketï¼Œå½“ä»»ä½•ä¸€ä¸ªsocketä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œselectå°±ä¼šè¿”å›ã€‚è¿™ä¸ªæ—¶å€™ç”¨æˆ·è¿›ç¨‹å†è°ƒç”¨readæ“ä½œï¼Œå°†æ•°æ®ä»kernelæ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ã€‚

åœ¨IO multiplexing Modelä¸­ï¼Œå®é™…ä¸­ï¼Œå¯¹äºæ¯ä¸€ä¸ªsocketï¼Œä¸€èˆ¬éƒ½è®¾ç½®æˆä¸ºnon-blockingï¼Œä½†æ˜¯ æ•´ä¸ªç”¨æˆ·çš„processå…¶å®æ˜¯ä¸€ç›´è¢«blockçš„ã€‚åªä¸è¿‡processæ˜¯è¢«selectè¿™ä¸ªå‡½æ•°blockï¼Œè€Œä¸æ˜¯è¢«socket IOè¢«blockã€‚

å¦‚æœå¤„ç†çš„è¿æ¥æ•°ä¸æ˜¯å¾ˆé«˜çš„è¯ï¼Œä½¿ç”¨select/epollçš„web serverä¸ä¸€å®šæ¯”ä½¿ç”¨multi-threading + blocking IOçš„web serveræ€§èƒ½æ›´å¥½ï¼Œå¯èƒ½å»¶è¿Ÿè¿˜æ›´å¤§ã€‚  
select/epollçš„ä¼˜åŠ¿`ä¸åœ¨äºå•ä¸ªè¿æ¥èƒ½å¤„ç†å¾—æ›´å¿«ï¼Œè€Œåœ¨äºèƒ½å¤„ç†æ›´å¤šçš„è¿æ¥`ã€‚

### Signal driven IO 
> ä½¿ç”¨è¾ƒå°‘

åœ¨ä¿¡å·é©±åŠ¨IOæ¨¡å‹ä¸­ï¼Œå½“ç”¨æˆ·çº¿ç¨‹å‘èµ·ä¸€ä¸ªIOè¯·æ±‚æ“ä½œï¼Œä¼šç»™å¯¹åº”çš„socketæ³¨å†Œä¸€ä¸ªä¿¡å·å‡½æ•°ï¼Œç„¶åç”¨æˆ·çº¿ç¨‹ä¼šç»§ç»­æ‰§è¡Œ  
å½“å†…æ ¸æ•°æ®å°±ç»ªæ—¶ä¼šå‘é€ä¸€ä¸ªä¿¡å·ç»™ç”¨æˆ·çº¿ç¨‹ï¼Œç”¨æˆ·çº¿ç¨‹æ¥æ”¶åˆ°ä¿¡å·ä¹‹åï¼Œä¾¿åœ¨ä¿¡å·å‡½æ•°ä¸­è°ƒç”¨IOè¯»å†™æ“ä½œæ¥è¿›è¡Œå®é™…çš„IOè¯·æ±‚æ“ä½œã€‚

### Asynchronous IO
> [å‚è€ƒ: å¼‚æ­¥AIOçš„ç ”ç©¶](http://rango.swoole.com/archives/282)  

ç”¨æˆ·è¿›ç¨‹å‘èµ·readæ“ä½œä¹‹åï¼Œç«‹åˆ»å°±å¯ä»¥å¼€å§‹å»åšå…¶å®ƒçš„äº‹ã€‚è€Œå¦ä¸€æ–¹é¢ï¼Œä»kernelçš„è§’åº¦ï¼Œå½“å®ƒå—åˆ°ä¸€ä¸ªasynchronous readä¹‹åï¼Œé¦–å…ˆå®ƒä¼šç«‹åˆ»è¿”å›ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹ç”¨æˆ·è¿›ç¨‹äº§ç”Ÿä»»ä½•blockã€‚  
ç„¶åkernelä¼šç­‰å¾…æ•°æ®å‡†å¤‡å®Œæˆï¼Œç„¶åå°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·å†…å­˜ï¼Œå½“è¿™ä¸€åˆ‡éƒ½å®Œæˆä¹‹åï¼Œkernelä¼šç»™ç”¨æˆ·è¿›ç¨‹å‘é€ä¸€ä¸ªsignalï¼Œå‘Šè¯‰å®ƒreadæ“ä½œå®Œæˆäº†ã€‚  

AIOé€‚ç”¨äº IOæ“ä½œé‡å¤§ï¼Œè¯»å†™è¿‡ç¨‹é•¿çš„åœºæ™¯ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯åº”ç”¨ç³»ç»Ÿå¤„ç†å¼‚æ­¥APIéº»çƒ¦ã€‚

### ç»å…¸æ¯”å–»
æœ‰ Aï¼ŒBï¼ŒCï¼ŒD å››ä¸ªäººåœ¨é’“é±¼ (BIO, NIO, IO multiplexing, AIO) : 
- A ç”¨çš„æ˜¯æœ€è€å¼çš„é±¼ç«¿ï¼ˆåªæœ‰çº¿å’Œç«¿ï¼‰ï¼Œæ‰€ä»¥å¾—ä¸€ç›´å®ˆç€ï¼Œç­‰åˆ°é±¼ä¸Šé’©äº†å†æ‹‰æ†ï¼›
- B ç”¨çš„é±¼ç«¿æœ‰æµ®æ¼‚ï¼ŒBå°±èƒ½æ—è¾¹æ³¡èŒ¶ï¼Œéš”ä¼šå†çœ‹çœ‹æœ‰æ²¡æœ‰é±¼ä¸Šé’©ï¼Œæœ‰çš„è¯å°±è¿…é€Ÿæ‹‰æ†ï¼›
- C ç”¨çš„é±¼ç«¿å’ŒBå·®ä¸å¤šï¼Œä½†ä»–æƒ³äº†ä¸€ä¸ªå¥½åŠæ³•ï¼Œ`å°±æ˜¯åŒæ—¶æ”¾å¥½å‡ æ ¹é±¼ç«¿`ï¼Œç„¶åå®ˆåœ¨æ—è¾¹ï¼Œä¸€æ—¦æç¤ºé±¼ä¸Šé’©äº†ï¼Œå®ƒå°±å°†å¯¹åº”çš„é±¼ç«¿æ‹‰èµ·æ¥ï¼› è¿™æ ·ä¸€ä¸ªäººå°±èƒ½å¤„ç†å¥½å¤šä¸ªé±¼ç«¿
- D æ˜¯ä¸ªæœ‰é’±äººï¼Œå¹²è„†é›‡äº†ä¸€ä¸ªäººå¸®ä»–é’“é±¼ï¼Œä¸€æ—¦é‚£ä¸ªäººæŠŠé±¼é’“ä¸Šæ¥äº†ï¼Œå°±ç»™Då‘ä¸ªçŸ­ä¿¡ã€‚

************************

## é˜»å¡å’Œéé˜»å¡
é˜»å¡å’Œéé˜»å¡å…³æ³¨çš„æ˜¯ç¨‹åºåœ¨ç­‰å¾…è°ƒç”¨ç»“æœï¼ˆæ¶ˆæ¯ï¼Œè¿”å›å€¼ï¼‰æ—¶çš„çŠ¶æ€.  

é˜»å¡è°ƒç”¨æ˜¯æŒ‡è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ã€‚è°ƒç”¨çº¿ç¨‹åªæœ‰åœ¨å¾—åˆ°ç»“æœä¹‹åæ‰ä¼šè¿”å›ã€‚  
éé˜»å¡è°ƒç”¨æŒ‡åœ¨ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥è°ƒç”¨ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚  

è°ƒç”¨ blocking IO ä¼šä¸€ç›´ block ä½å¯¹åº”çš„è¿›ç¨‹ç›´åˆ°æ“ä½œå®Œæˆ, è¯¥æ“ä½œå°±æ˜¯é˜»å¡çš„  
è€Œ non-blocking IO åœ¨ kernel è¿˜æœªå‡†å¤‡å¥½æ•°æ®çš„æƒ…å†µä¸‹ä¼šç«‹åˆ»è¿”å›, è¯¥æ“ä½œå°±æ˜¯éé˜»å¡çš„  

## åŒæ­¥å’Œå¼‚æ­¥
åŒæ­¥å’Œå¼‚æ­¥å…³æ³¨çš„æ˜¯æ¶ˆæ¯é€šä¿¡æœºåˆ¶ (synchronous communication/ asynchronous communication)

æ‰€è°“åŒæ­¥ï¼Œå°±æ˜¯åœ¨å‘å‡ºä¸€ä¸ª*è°ƒç”¨*æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥*è°ƒç”¨*å°±ä¸è¿”å›ã€‚ä½†æ˜¯ä¸€æ—¦è°ƒç”¨è¿”å›ï¼Œå°±å¾—åˆ°è¿”å›å€¼äº†ã€‚ æ¢å¥è¯è¯´ï¼Œå°±æ˜¯ç”±*è°ƒç”¨è€…*ä¸»åŠ¨ç­‰å¾…è¿™ä¸ª*è°ƒç”¨*çš„ç»“æœã€‚
å¼‚æ­¥åˆ™æ˜¯è°ƒç”¨è€…è°ƒç”¨å°±è¿”å›äº†ï¼Œç­‰æ“ä½œç³»ç»Ÿæ¥å®ŒæˆIOè¡Œä¸ºï¼Œå¹¶é€šçŸ¥è°ƒç”¨è€…ï¼ˆç”±äºåº”ç”¨åœºæ™¯å¤šå˜ï¼Œè¿™ç§æ–¹å¼ä¸‹ä¼šå—é™äºæ“ä½œç³»ç»Ÿçš„è°ƒåº¦ä¸å¯æ§ï¼Œæ‰€ä»¥ä¸€ç›´æ²¡æœ‰å¾—åˆ°å¹¿æ³›åº”ç”¨ï¼‰ã€‚

åœ¨è¯´æ˜synchronous IOå’Œasynchronous IOçš„åŒºåˆ«ä¹‹å‰ï¼Œéœ€è¦å…ˆç»™å‡ºä¸¤è€…çš„å®šä¹‰ã€‚Stevensç»™å‡ºçš„å®šä¹‰ï¼ˆå…¶å®æ˜¯POSIXçš„å®šä¹‰ï¼‰æ˜¯è¿™æ ·å­çš„ï¼š
```
    A synchronous I/O operation causes the requesting process to be blocked until that I/O operation completes;
    An asynchronous I/O operation does not cause the requesting process to be blocked;
```

ä¸¤è€…çš„åŒºåˆ«å°±åœ¨äº synchronous IO åš `IO operation` çš„æ—¶å€™ä¼šå°†åº”ç”¨çš„ process é˜»å¡ã€‚  
æŒ‰ç…§è¿™ä¸ªå®šä¹‰ï¼Œä¹‹å‰æ‰€è¿°çš„ blocking IOï¼Œnon-blocking IOï¼ŒIO multiplexing `éƒ½å±äº synchronous IO`ã€‚   
`åœ¨å¤„ç† IO çš„æ—¶å€™ï¼Œé˜»å¡å’Œéé˜»å¡éƒ½æ˜¯åŒæ­¥ IO`ï¼Œåªæœ‰ä½¿ç”¨ç‰¹å®šAPIæ‰æ˜¯å¼‚æ­¥ IOï¼š Linux aio, Windows IOCP   

æœ‰äººå¯èƒ½ä¼šè¯´ï¼Œnon-blocking IO å¹¶æ²¡æœ‰è¢« blockï¼Œ è¿™æ˜¯å› ä¸ºåœ¨ç¬¬ä¸€é˜¶æ®µ, æ•°æ®æ²¡æœ‰å‡†å¤‡å¥½å°±ç›´æ¥è¿”å›è¿™é‡Œæ²¡æœ‰é˜»å¡, ç­‰æ•°æ®å‡†å¤‡å¥½äº†å°±è¦æ‰§è¡Œç¬¬äºŒé˜¶æ®µ æ•°æ®å¤åˆ¶ çš„æ“ä½œ, è¿™ä¸ªæ“ä½œæ˜¯ä¼šé˜»å¡å¯¹åº”çš„è¿›ç¨‹  
è€Œ asynchronous IO åˆ™ä¸ä¸€æ ·ï¼Œå½“è¿›ç¨‹å‘èµ· IO æ“ä½œä¹‹åï¼Œå°±ç›´æ¥è¿”å›ï¼Œç›´åˆ° kernel å‘é€ä¸€ä¸ªä¿¡å·ï¼Œé€šçŸ¥åº”ç”¨è¿›ç¨‹è¯´IOå®Œæˆ `ä¹Ÿå°±æ˜¯æ•°æ®å¤åˆ¶å®Œæˆåæ‰é€šçŸ¥`  
åœ¨è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¿›ç¨‹å®Œå…¨æ²¡æœ‰è¢«blockã€‚  

************************
## åŒå¼‚æ­¥å’Œé˜»å¡
> [Linux AIO](https://oxnz.github.io/2016/10/13/linux-aio/)

|  | é˜»å¡ | éé˜»å¡ |
|:---|:---|:---|
| åŒæ­¥ | read/write | read/write<br/> (O_NONBLOCK) |
| å¼‚æ­¥ | I/O multiplexing <br/>(select/poll/epoll) | AIO |

é˜»å¡ï¼Œéé˜»å¡ï¼šè¿›ç¨‹/çº¿ç¨‹è¦è®¿é—®çš„æ•°æ®æ˜¯å¦å°±ç»ªï¼Œè¿›ç¨‹/çº¿ç¨‹æ˜¯å¦éœ€è¦ç­‰å¾…ï¼›  
åŒæ­¥ï¼Œå¼‚æ­¥ï¼šè®¿é—®æ•°æ®çš„æ–¹å¼ï¼ŒåŒæ­¥éœ€è¦ä¸»åŠ¨è¯»å†™æ•°æ®ï¼Œåœ¨è¯»å†™æ•°æ®çš„è¿‡ç¨‹ä¸­è¿˜æ˜¯ä¼šé˜»å¡ï¼›å¼‚æ­¥åªéœ€è¦I/Oæ“ä½œå®Œæˆçš„é€šçŸ¥ï¼Œå¹¶ä¸ä¸»åŠ¨è¯»å†™æ•°æ®ï¼Œç”±æ“ä½œç³»ç»Ÿå†…æ ¸å®Œæˆæ•°æ®çš„è¯»å†™ã€‚  

> [çŸ¥ä¹: é˜»å¡éé˜»å¡å’ŒåŒæ­¥å¼‚æ­¥çš„åŒºåˆ«](https://www.zhihu.com/question/19732473/answer/117012135)  

è®¨è®ºç©¶ç«Ÿæ˜¯å¼‚æ­¥è¿˜æ˜¯åŒæ­¥ï¼Œä¸€å®šè¦ä¸¥æ ¼è¯´æ˜è¯´çš„æ˜¯å“ªä¸€éƒ¨åˆ†ã€‚  
`éé˜»å¡æ˜¯åŒæ­¥è€Œä¸æ˜¯å¼‚æ­¥`ï¼Œè¿™æ¯«æ— ç–‘é—®æ˜¯æ­£ç¡®çš„ï¼Œç„¶è€Œè¯´æŸä¸ªæ¡†æ¶æ˜¯å¼‚æ­¥IOçš„æ¡†æ¶ï¼Œè¿™ä¹Ÿæ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºè¯´çš„å…¶å®æ˜¯æ¡†æ¶æä¾›ç»™ä¸šåŠ¡ä»£ç çš„æ¥å£æ˜¯å¼‚æ­¥çš„  
ä¸ç®¡æ˜¯å›è°ƒè¿˜æ˜¯åç¨‹ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥è¯´æŸä¸ªåº“æ˜¯å¼‚æ­¥çš„HTTPClientï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºè¯´çš„æ˜¯ç»™ä¸šåŠ¡ä»£ç çš„æ¥å£ã€‚

> [å‚è€ƒ](https://www.zhihu.com/question/19732473/answer/88599695)  

æˆ‘è®¤ä¸ºåŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡ï¼Œæ˜¯åˆ†3ä¸ªå±‚æ¬¡çš„ï¼šCPUå±‚æ¬¡ï¼›çº¿ç¨‹å±‚æ¬¡ï¼›ç¨‹åºå‘˜æ„ŸçŸ¥å±‚æ¬¡ã€‚ è¿™å‡ ä¸ªæ¦‚å¿µä¹‹æ‰€ä»¥å®¹æ˜“æ··æ·†ï¼Œæ˜¯å› ä¸ºæ²¡æœ‰åˆ†æ¸…æ¥šæ˜¯åœ¨å“ªä¸ªå±‚æ¬¡è¿›è¡Œè®¨è®ºã€‚

**CPUå±‚æ¬¡**

åœ¨CPUå±‚æ¬¡ï¼Œæˆ–è€…è¯´æ“ä½œç³»ç»Ÿè¿›è¡ŒIOå’Œä»»åŠ¡è°ƒåº¦çš„å±‚æ¬¡ï¼Œç°ä»£æ“ä½œç³»ç»Ÿé€šå¸¸ä½¿ç”¨å¼‚æ­¥éé˜»å¡æ–¹å¼è¿›è¡ŒIOï¼ˆæœ‰å°‘éƒ¨åˆ†IOå¯èƒ½ä¼šä½¿ç”¨åŒæ­¥éé˜»å¡è½®è¯¢ï¼‰ï¼Œå³å‘å‡ºIOè¯·æ±‚ä¹‹åï¼Œå¹¶ä¸ç­‰å¾…IOæ“ä½œå®Œæˆï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œä¸‹é¢çš„æŒ‡ä»¤ï¼ˆéé˜»å¡ï¼‰ï¼ŒIOæ“ä½œå’ŒCPUæŒ‡ä»¤äº’ä¸å¹²æ‰°ï¼ˆå¼‚æ­¥ï¼‰ï¼Œæœ€åé€šè¿‡ä¸­æ–­çš„æ–¹å¼æ¥é€šçŸ¥IOæ“ä½œå®Œæˆç»“æœã€‚

**çº¿ç¨‹å±‚æ¬¡**

åœ¨çº¿ç¨‹å±‚æ¬¡ï¼Œæˆ–è€…è¯´æ“ä½œç³»ç»Ÿè°ƒåº¦å•å…ƒçš„å±‚æ¬¡ï¼Œæ“ä½œç³»ç»Ÿä¸ºäº†å‡è½»ç¨‹åºå‘˜çš„æ€è€ƒè´Ÿæ‹…ï¼Œå°†åº•å±‚çš„å¼‚æ­¥éé˜»å¡çš„IOæ–¹å¼è¿›è¡Œå°è£…ï¼ŒæŠŠç›¸å…³ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚readï¼Œwriteç­‰ï¼‰ä»¥åŒæ­¥çš„æ–¹å¼å±•ç°å‡ºæ¥ã€‚ç„¶è€Œï¼ŒåŒæ­¥é˜»å¡çš„IOä¼šä½¿çº¿ç¨‹æŒ‚èµ·ï¼ŒåŒæ­¥éé˜»å¡çš„IOä¼šæ¶ˆè€—CPUèµ„æºåœ¨è½®è¯¢ä¸Šã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œå°±æœ‰3ç§æ€è·¯ï¼šå¤šçº¿ç¨‹ï¼ˆåŒæ­¥é˜»å¡ï¼‰ï¼›IOå¤šè·¯å¤ç”¨ï¼ˆselectï¼Œpollï¼Œepollï¼‰ï¼ˆåŒæ­¥éé˜»å¡ï¼Œä¸¥æ ¼åœ°æ¥è®²ï¼Œæ˜¯æŠŠé˜»å¡ç‚¹æ”¹å˜äº†ä½ç½®ï¼‰ï¼›ç›´æ¥æš´éœ²å‡ºå¼‚æ­¥çš„IOæ¥å£ï¼Œå¦‚kernel-aioå’ŒIOCPï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰ã€‚

**ç¨‹åºå‘˜æ„ŸçŸ¥å±‚æ¬¡**

åœ¨Linuxä¸­ï¼Œä¸Šé¢æåˆ°çš„ç¬¬2ç§æ€è·¯ç”¨å¾—æ¯”è¾ƒå¹¿æ³›ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒç†æƒ³çš„è§£å†³æ–¹æ¡ˆã€‚ç„¶è€Œï¼Œç›´æ¥ä½¿ç”¨selectä¹‹ç±»çš„æ¥å£ï¼Œä¾ç„¶æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥å„ç§åº“å’Œæ¡†æ¶ç™¾èŠ±é½æ”¾ï¼Œéƒ½è¯•å›¾å¯¹IOå¤šè·¯å¤ç”¨è¿›è¡Œå°è£…ã€‚æ­¤æ—¶ï¼Œåº“å’Œæ¡†æ¶æä¾›çš„APIåˆå¯ä»¥é€‰æ‹©æ˜¯ä»¥åŒæ­¥çš„æ–¹å¼è¿˜æ˜¯å¼‚æ­¥çš„æ–¹å¼æ¥å±•ç°ã€‚å¦‚pythonçš„asyncioåº“ä¸­ï¼Œå°±é€šè¿‡åç¨‹ï¼Œæä¾›äº†åŒæ­¥é˜»å¡å¼çš„APIï¼›å¦‚node.jsä¸­ï¼Œå°±é€šè¿‡å›è°ƒå‡½æ•°ï¼Œæä¾›äº†å¼‚æ­¥éé˜»å¡å¼çš„APIã€‚

æ€»ç»“å› æ­¤ï¼Œæˆ‘ä»¬åœ¨è®¨è®ºåŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡æ—¶ï¼Œå¿…é¡»å…ˆæ˜ç¡®æ˜¯åœ¨å“ªä¸ªå±‚æ¬¡è¿›è¡Œè®¨è®ºã€‚æ¯”å¦‚node.jsï¼Œæˆ‘ä»¬å¯ä»¥è¯´å¥¹åœ¨ç¨‹åºå‘˜æ„ŸçŸ¥å±‚æ¬¡æä¾›äº†å¼‚æ­¥éé˜»å¡çš„APIï¼Œä¹Ÿå¯ä»¥è¯´åœ¨Linuxä¸‹ï¼Œå¥¹åœ¨çº¿ç¨‹å±‚æ¬¡ä»¥åŒæ­¥éé˜»å¡çš„epollæ¥å®ç°ã€‚

************************

# å¤šè·¯å¤ç”¨
> [å‚è€ƒ: IOå¤šè·¯å¤ç”¨](https://blog.csdn.net/chewbee/article/details/78108223)   

## å¤šè·¯å¤ç”¨æ¨¡å‹
Reactor å’Œ Proactor: å‰è€… ä½¿ç”¨åŒæ­¥IO, åè€…ä½¿ç”¨å¼‚æ­¥IO

> [Comparing Two High-Performance I/O Design Patterns](https://www.artima.com/articles/io_design_patternsP.html)  

> [é«˜æ€§èƒ½ç½‘ç»œæ¨¡å¼ï¼šReactor å’Œ Proactor](https://www.xiaolincoding.com/os/8_network_system/reactor.html)

Reactor å¯ä»¥ç†è§£ä¸ºã€Œæ¥äº†äº‹ä»¶æ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨è¿›ç¨‹ï¼Œè®©åº”ç”¨è¿›ç¨‹æ¥å¤„ç†ã€ï¼Œè€Œ Proactor å¯ä»¥ç†è§£ä¸ºã€Œæ¥äº†äº‹ä»¶æ“ä½œç³»ç»Ÿæ¥å¤„ç†ï¼Œå¤„ç†å®Œå†é€šçŸ¥åº”ç”¨è¿›ç¨‹ã€ã€‚
å› æ­¤ï¼ŒçœŸæ­£çš„å¤§æ€å™¨è¿˜æ˜¯ Proactorï¼Œå®ƒæ˜¯é‡‡ç”¨å¼‚æ­¥ I/O å®ç°çš„å¼‚æ­¥ç½‘ç»œæ¨¡å‹ï¼Œæ„ŸçŸ¥çš„æ˜¯å·²å®Œæˆçš„è¯»å†™äº‹ä»¶ï¼Œè€Œä¸éœ€è¦åƒ Reactor æ„ŸçŸ¥åˆ°äº‹ä»¶åï¼Œè¿˜éœ€è¦è°ƒç”¨ read æ¥ä»å†…æ ¸ä¸­è·å–æ•°æ®ã€‚
ä¸è¿‡ï¼Œæ— è®ºæ˜¯ Reactorï¼Œè¿˜æ˜¯ Proactorï¼Œéƒ½æ˜¯ä¸€ç§åŸºäºã€Œäº‹ä»¶åˆ†å‘ã€çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼ï¼ŒåŒºåˆ«åœ¨äº Reactor æ¨¡å¼æ˜¯åŸºäºã€Œå¾…å®Œæˆã€çš„ I/O äº‹ä»¶ï¼Œè€Œ Proactor æ¨¡å¼åˆ™æ˜¯åŸºäºã€Œå·²å®Œæˆã€çš„ I/O äº‹ä»¶ã€‚

### Reactor
- Redisï¼šå• Reactor å•è¿›ç¨‹ 
- Netty & Memcache: ä¸»ä»å¤šReactor å¤šçº¿ç¨‹
- Nginxï¼š ä¸»ä»Reactor å¤šè¿›ç¨‹ *è¿›ç¨‹èŒè´£åšäº†è°ƒæ•´*

> [ã€Nettyã€‘æ¨¡å‹ç¯‡ä¸€ï¼šNetty çº¿ç¨‹æ¨¡å‹æ¶æ„ & å·¥ä½œåŸç† è§£è¯»](https://blog.csdn.net/qq_36389060/article/details/124232377)`åŒ…å«äº†Reactorå¤šç§æ¨¡å¼çš„å›¾`  

![](/Skills/CS/img/001-reactor-multiple.drawio.svg)

> [TCP Serverå¤„ç†å¤šClientè¯·æ±‚çš„æ–¹æ³•â€”éé˜»å¡acceptä¸select](http://velep.com/archives/1137.html)`å¯ä»¥çœ‹åˆ°ç³»ç»Ÿè°ƒç”¨å±‚é¢ä¹Ÿæ˜¯å…ˆè°ƒç”¨selectå‘ç°æ–°è¿æ¥åè°ƒç”¨acceptå’Œread write` [Github: Code](https://github.com/Kuangcp/LearnC/blob/master/network/tcp/nio-tcp.c)

### Proactor


### å¿™è½®è¯¢
å¿™è½®è¯¢æ–¹å¼æ˜¯é€šè¿‡ä¸åœçš„æŠŠæ‰€æœ‰çš„æµä»å¤´åˆ°å°¾è½®è¯¢ä¸€éï¼ŒæŸ¥è¯¢æ˜¯å¦æœ‰æµå·²ç»å‡†å¤‡å°±ç»ªï¼Œç„¶ååˆä»å¤´å¼€å§‹ã€‚å¦‚æœæ‰€æœ‰æµéƒ½æ²¡æœ‰å‡†å¤‡å°±ç»ªï¼Œé‚£ä¹ˆåªä¼šç™½ç™½æµªè´¹CPUæ—¶é—´ã€‚

### æ— å·®åˆ«è½®è¯¢
ä¸ºäº†é¿å…ç™½ç™½æµªè´¹CPUæ—¶é—´ï¼Œæˆ‘ä»¬é‡‡ç”¨å¦å¤–ä¸€ç§è½®è¯¢æ–¹å¼ï¼Œæ— å·®åˆ«çš„è½®è¯¢æ–¹å¼ã€‚å³é€šè¿‡å¼•è¿›ä¸€ä¸ªä»£ç†ï¼Œè¿™ä¸ªä»£ç†ä¸º select/poll ,è¿™ä¸ªä»£ç†å¯ä»¥åŒæ—¶è§‚å¯Ÿå¤šä¸ªæµçš„I/Oäº‹ä»¶ã€‚  
å½“æ‰€æœ‰çš„æµéƒ½æ²¡æœ‰å‡†å¤‡å°±ç»ªæ—¶ï¼Œä¼šæŠŠå½“å‰çº¿ç¨‹é˜»å¡æ‰ï¼›å½“æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæµçš„I/Oäº‹ä»¶å°±ç»ªæ—¶ï¼Œå°±ä»é˜»å¡çŠ¶æ€ä¸­é†’æ¥ï¼Œç„¶åè½®è¯¢ä¸€éæ‰€æœ‰çš„æµï¼Œå¤„ç†å·²ç»å‡†å¤‡å¥½çš„I/Oäº‹ä»¶ã€‚

å¦‚æœI/Oäº‹ä»¶å‡†å¤‡å°±ç»ªï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç¨‹åºå°±ä¼šé˜»å¡åœ¨selectå¤„ã€‚æˆ‘ä»¬é€šè¿‡selecté‚£é‡Œåªæ˜¯çŸ¥é“äº†æœ‰I/Oäº‹ä»¶å‡†å¤‡å¥½äº†ï¼Œä½†ä¸çŸ¥é“å…·ä½“æ˜¯å“ªå‡ ä¸ªæµï¼ˆå¯èƒ½æœ‰ä¸€ä¸ªï¼Œä¹Ÿå¯èƒ½æœ‰å¤šä¸ªï¼‰ï¼Œæ‰€ä»¥éœ€è¦æ— å·®åˆ«çš„è½®è¯¢æ‰€æœ‰çš„æµï¼Œæ‰¾å‡ºå·²ç»å‡†å¤‡å°±ç»ªçš„æµã€‚  
å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨selectæ—¶ï¼Œæˆ‘ä»¬éœ€è¦O(n)çš„æ—¶é—´å¤æ‚åº¦æ¥å¤„ç†æµï¼Œéœ€è¦å¤„ç†çš„æµè¶Šå¤šï¼Œæ¶ˆè€—çš„æ—¶é—´ä¹Ÿå°±è¶Šå¤šã€‚

### æœ€å°è½®è¯¢

é€šè¿‡epollæ–¹å¼æ¥è§‚å¯Ÿå¤šä¸ªæµï¼Œepoll`åªæŠŠå‘ç”Ÿäº†I/Oäº‹ä»¶çš„æµ`é€šçŸ¥æˆ‘ä»¬ï¼Œæˆ‘ä»¬å¯¹è¿™äº›æµçš„æ“ä½œéƒ½æ˜¯æœ‰æ„ä¹‰çš„ï¼Œæ—¶é—´å¤æ‚åº¦é™ä½åˆ°Oï¼ˆkï¼‰ï¼Œå…¶ä¸­kä¸ºäº§ç”ŸI/Oäº‹ä»¶çš„æµä¸ªæ•°ã€‚

## IOå¤šè·¯å¤ç”¨å‡½æ•°
> [å‚è€ƒ: IOå¤šè·¯å¤ç”¨ä¹‹selectã€pollã€epollè¯¦è§£](https://www.cnblogs.com/jeakeven/p/5435916.html)   
> [å‚è€ƒ: selectã€pollã€epollä¹‹é—´çš„åŒºåˆ«æ€»ç»“](https://www.cnblogs.com/Anker/p/3265058.html)  

IOå¤ç”¨æœºåˆ¶å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªæè¿°ç¬¦ï¼Œå½“æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆè¯»æˆ–å†™å°±ç»ªï¼‰ï¼Œåˆ™ç«‹å³é€šçŸ¥ç›¸åº”ç¨‹åºè¿›è¡Œè¯»æˆ–å†™æ“ä½œã€‚   
select/poll/epolléƒ½æ˜¯é‡‡ç”¨I/Oå¤šè·¯å¤ç”¨æœºåˆ¶çš„ï¼Œå…¶ä¸­select/pollæ˜¯é‡‡ç”¨æ— å·®åˆ«è½®è¯¢æ–¹å¼ï¼Œè€Œepollæ˜¯é‡‡ç”¨æœ€å°çš„è½®è¯¢æ–¹å¼ã€‚  
ä½† selectï¼Œpollï¼Œepollæœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥I/Oï¼Œ å› ä¸ºä»–ä»¬éƒ½éœ€è¦åœ¨è¯»å†™äº‹ä»¶å°±ç»ªå`è‡ªå·±`è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„    
æ‰€ä»¥ select poll epoll éƒ½æ˜¯ Reactor æ¨¡å‹

************************

### select

ç³»ç»Ÿæä¾›Selectå‡½æ•°æ¥å®ç°å¤šè·¯å¤ç”¨è¾“å…¥/è¾“å‡ºæ¨¡å‹ï¼ŒSelectç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨æ¥è®©æˆ‘ä»¬çš„ç¨‹åºç›‘è§†å¤šä¸ªæ–‡ä»¶å¥æŸ„çš„çŠ¶æ€å˜åŒ–ã€‚ç¨‹åºä¼šé˜»å¡åœ¨selectå‡½æ•°ä¸Šï¼Œç›´åˆ°è¢«ç›‘è§†çš„æ–‡ä»¶å¥æŸ„ä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå‘ç”Ÿäº†çŠ¶æ€å˜åŒ–ã€‚

`ç¼ºç‚¹`
1. æ¯æ¬¡è°ƒç”¨selectï¼Œéƒ½éœ€è¦æŠŠfdé›†åˆ(å­˜æ”¾æ‰€æœ‰fd)ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¼šå¾ˆå¤§
1. åŒæ—¶æ¯æ¬¡è°ƒç”¨select, éƒ½éœ€è¦åœ¨å†…æ ¸`éå†`ä¼ é€’è¿›æ¥çš„æ‰€æœ‰fdï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¹Ÿå¾ˆå¤§
1. selectæ”¯æŒçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¤ªå°äº†ï¼Œé»˜è®¤æ˜¯1024, ç”±FD_SETSIZEè®¾ç½®

************************

### poll
Pollçš„å¤„ç†æœºåˆ¶ä¸Selectç±»ä¼¼ï¼Œåªæ˜¯Pollé€‰æ‹©äº† pollfd ç»“æ„ä½“ è€Œä¸æ˜¯ select çš„ fd_set ç»“æ„æ¥å¤„ç†æ–‡ä»¶æè¿°ç¬¦çš„ç›¸å…³æ“ä½œ

ä½†æ˜¯å®ƒæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ï¼ŒåŸå› æ˜¯å®ƒæ˜¯`åŸºäºé“¾è¡¨`æ¥å­˜å‚¨çš„, ä½†æ˜¯åŒæ ·çš„éœ€è¦å°†æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦å¤åˆ¶æ¥å¤åˆ¶å»

pollè¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯â€œæ°´å¹³è§¦å‘â€ï¼Œå¦‚æœæŠ¥å‘Šäº†fdåï¼Œæ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆä¸‹æ¬¡pollæ—¶ä¼šå†æ¬¡æŠ¥å‘Šè¯¥fdã€‚

************************

### epoll
> [å‚è€ƒ: ä» linux æºç çœ‹ epoll](https://my.oschina.net/alchemystar/blog/3008840)  

epollæ˜¯åœ¨Linuxå†…æ ¸2.6å¼•è¿›çš„ï¼Œæ˜¯selectå’Œpollå‡½æ•°çš„å¢å¼ºç‰ˆã€‚ä¸selectç›¸æ¯”ï¼Œepollæ²¡æœ‰æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ã€‚  
epollä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç®¡ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå°†ç”¨æˆ·å…³å¿ƒçš„æ–‡ä»¶æè¿°ç¬¦äº‹ä»¶å­˜æ”¾åˆ°`å†…æ ¸çš„ä¸€ä¸ªäº‹ä»¶åˆ—è¡¨`ä¸­  
è¿™æ ·åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´`åªéœ€æ‹·è´ä¸€æ¬¡`, å› ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´å…±ç”¨ä¸€å—å†…å­˜

epollæä¾›äº†ä¸‰ä¸ªå‡½æ•°:
- epoll_createæ˜¯åˆ›å»ºä¸€ä¸ªepollå¥æŸ„ï¼›
- epoll_ctlæ˜¯æ³¨å†Œè¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼›
- epoll_waitåˆ™æ˜¯ç­‰å¾…äº‹ä»¶çš„äº§ç”Ÿã€‚

epollæ”¯æŒæ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘ï¼Œæœ€å¤§çš„ç‰¹ç‚¹åœ¨äºè¾¹ç¼˜è§¦å‘ï¼Œå®ƒåªå‘Šè¯‰è¿›ç¨‹å“ªäº›fdåˆšåˆšå˜ä¸ºå°±ç»ªæ€ï¼Œå¹¶ä¸”åªä¼šé€šçŸ¥ä¸€æ¬¡ã€‚
è¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯ï¼Œepollä½¿ç”¨â€œäº‹ä»¶â€çš„å°±ç»ªé€šçŸ¥æ–¹å¼ï¼Œé€šè¿‡epoll_ctlæ³¨å†Œfdï¼Œä¸€æ—¦è¯¥fdå°±ç»ªï¼Œå†…æ ¸å°±ä¼šé‡‡ç”¨ç±»ä¼¼callbackçš„å›è°ƒæœºåˆ¶æ¥æ¿€æ´»è¯¥fdï¼Œepoll_waitä¾¿å¯ä»¥æ”¶åˆ°é€šçŸ¥ã€‚

epollçš„ä¼˜ç‚¹ï¼š
1. æ²¡æœ‰æœ€å¤§å¹¶å‘è¿æ¥çš„é™åˆ¶ï¼Œèƒ½æ‰“å¼€çš„FDçš„ä¸Šé™è¿œå¤§äº1024ï¼ˆ1Gçš„å†…å­˜èƒ½ç›‘å¬çº¦10ä¸‡ä¸ªç«¯å£ï¼‰ã€‚
2. æ•ˆç‡æå‡ï¼Œä¸æ˜¯è½®è¯¢çš„æ–¹å¼ï¼Œä¸ä¼šéšç€FDæ•°ç›®çš„å¢åŠ æ•ˆç‡ä¸‹é™ã€‚åªæœ‰æ´»è·ƒå¯ç”¨çš„FDæ‰ä¼šè°ƒç”¨callbackå‡½æ•°ï¼›
    - å³Epollæœ€å¤§çš„ä¼˜ç‚¹å°±åœ¨äºå®ƒ`åªå¤„ç†â€œæ´»è·ƒâ€çš„è¿æ¥`ï¼Œè€Œè·Ÿè¿æ¥æ€»æ•°æ— å…³ï¼Œå› æ­¤åœ¨å®é™…çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œepoll çš„æ•ˆç‡å°±ä¼šè¿œè¿œé«˜äº selectå’Œpollã€‚
3. å†…å­˜æ‹·è´ï¼Œåˆ©ç”¨ mmap() æ–‡ä»¶æ˜ å°„å†…å­˜åŠ é€Ÿä¸å†…æ ¸ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’ï¼›å³ epoll ä½¿ç”¨ mmap å‡å°‘å¤åˆ¶å¼€é”€ã€‚

> å¦‚æœæ²¡æœ‰å¤§é‡çš„ idle-connection æˆ–è€… dead-connectionï¼Œepoll çš„æ•ˆç‡å¹¶ä¸ä¼šæ¯” select/poll é«˜å¾ˆå¤š  
> ä½†æ˜¯å½“é‡åˆ°å¤§é‡çš„ idle-connectionï¼Œå°±ä¼šå‘ç° epoll çš„æ•ˆç‡å¤§å¤§é«˜äº select/pollã€‚

> [ç™¾ä¸‡ Go TCP è¿æ¥çš„æ€è€ƒ2: ç™¾ä¸‡è¿æ¥çš„ååç‡å’Œå»¶è¿Ÿ ](https://colobu.com/2019/02/27/1m-go-tcp-connection-2/)


