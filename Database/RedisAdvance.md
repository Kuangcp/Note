---
title: Redisè¿›é˜¶
date: 2018-12-16 17:29:06
tags: 
    - Redis
    - Advanced
categories: 
    - æ•°æ®åº“
---

ğŸ’ 

- 1. [Redisåº•å±‚æ•°æ®ç»“æ„](#redisåº•å±‚æ•°æ®ç»“æ„)
    - 1.1. [SDS](#sds)
        - 1.1.1. [Rediså­˜å‚¨æ•°å€¼çš„æ–¹å¼](#rediså­˜å‚¨æ•°å€¼çš„æ–¹å¼)
    - 1.2. [é“¾è¡¨](#é“¾è¡¨)
        - 1.2.1. [æºç å®ç°](#æºç å®ç°)
        - 1.2.2. [å®ç°ç‰¹ç‚¹](#å®ç°ç‰¹ç‚¹)
        - 1.2.3. [Redisä¸­çš„ä½¿ç”¨åœºæ™¯](#redisä¸­çš„ä½¿ç”¨åœºæ™¯)
    - 1.3. [å­—å…¸](#å­—å…¸)
        - 1.3.1. [æºç å®ç°](#æºç å®ç°)
        - 1.3.2. [å®ç°ç‰¹ç‚¹](#å®ç°ç‰¹ç‚¹)
        - 1.3.3. [Redisä¸­çš„ä½¿ç”¨åœºæ™¯](#redisä¸­çš„ä½¿ç”¨åœºæ™¯)
    - 1.4. [è·³è¡¨](#è·³è¡¨)
    - 1.5. [æ•´æ•°é›†åˆ](#æ•´æ•°é›†åˆ)
        - 1.5.1. [æºç å®ç°](#æºç å®ç°)
        - 1.5.2. [å®ç°ç‰¹ç‚¹](#å®ç°ç‰¹ç‚¹)
        - 1.5.3. [å‡çº§è¿‡ç¨‹ç¤ºä¾‹](#å‡çº§è¿‡ç¨‹ç¤ºä¾‹)
        - 1.5.4. [Redisä¸­çš„ä½¿ç”¨åœºæ™¯](#redisä¸­çš„ä½¿ç”¨åœºæ™¯)
    - 1.6. [å‹ç¼©åˆ—è¡¨](#å‹ç¼©åˆ—è¡¨)
        - 1.6.1. [æºç å®ç°](#æºç å®ç°)
        - 1.6.2. [èŠ‚ç‚¹ç»“æ„ï¼ˆentryï¼‰](#èŠ‚ç‚¹ç»“æ„entry)
        - 1.6.3. [å®ç°ç‰¹ç‚¹](#å®ç°ç‰¹ç‚¹)
        - 1.6.4. [Redisä¸­çš„ä½¿ç”¨åœºæ™¯](#redisä¸­çš„ä½¿ç”¨åœºæ™¯)
    - 1.7. [å¯¹è±¡](#å¯¹è±¡)
        - 1.7.1. [æºç å®ç°](#æºç å®ç°)
        - 1.7.2. [å¯¹è±¡ç±»å‹ï¼ˆtypeï¼‰](#å¯¹è±¡ç±»å‹type)
        - 1.7.3. [ç¼–ç æ–¹å¼ï¼ˆencodingï¼‰](#ç¼–ç æ–¹å¼encoding)
            - 1.7.3.1. [Stringå¯¹è±¡çš„ç¼–ç ](#stringå¯¹è±¡çš„ç¼–ç )
            - 1.7.3.2. [Listå¯¹è±¡çš„ç¼–ç ](#listå¯¹è±¡çš„ç¼–ç )
            - 1.7.3.3. [Setå¯¹è±¡çš„ç¼–ç ](#setå¯¹è±¡çš„ç¼–ç )
            - 1.7.3.4. [Zsetå¯¹è±¡çš„ç¼–ç ](#zsetå¯¹è±¡çš„ç¼–ç )
            - 1.7.3.5. [Hashå¯¹è±¡çš„ç¼–ç ](#hashå¯¹è±¡çš„ç¼–ç )
        - 1.7.4. [å¤šæ€å®ç°](#å¤šæ€å®ç°)
        - 1.7.5. [å†…å­˜ç®¡ç†](#å†…å­˜ç®¡ç†)
        - 1.7.6. [Redisä¸­çš„ä½¿ç”¨åœºæ™¯](#redisä¸­çš„ä½¿ç”¨åœºæ™¯)
        - 1.7.7. [ç¼–ç é€‰æ‹©ç­–ç•¥](#ç¼–ç é€‰æ‹©ç­–ç•¥)
- 2. [Rediså¸¸ç”¨å‘½ä»¤](#rediså¸¸ç”¨å‘½ä»¤)
    - 2.1. [è¿‡æœŸ](#è¿‡æœŸ)
    - 2.2. [äº‹åŠ¡](#äº‹åŠ¡)
    - 2.3. [ACL](#acl)
    - 2.4. [æœåŠ¡å™¨](#æœåŠ¡å™¨)
- 3. [æ•°æ®å®‰å…¨å’Œæ€§èƒ½](#æ•°æ®å®‰å…¨å’Œæ€§èƒ½)
    - 3.1. [Latency](#latency)
    - 3.2. [big key](#big-key)
    - 3.3. [hot key](#hot-key)
    - 3.4. [Key eviction](#key-eviction)
- 4. [Lua](#lua)
    - 4.1. [FUNCTION](#function)
    - 4.2. [åº”ç”¨](#åº”ç”¨)
- 5. [Tip](#tip)
    - 5.1. [ç¦ç”¨ O(N) å‘½ä»¤](#ç¦ç”¨-on-å‘½ä»¤)
    - 5.2. [é”™è¯¯åˆ†æ](#é”™è¯¯åˆ†æ)
- 6. [éƒ¨ç½²æ–¹å¼](#éƒ¨ç½²æ–¹å¼)
    - 6.1. [Run Configuration](#run-configuration)
    - 6.2. [å•æœº](#å•æœº)
    - 6.3. [ä¸»ä»](#ä¸»ä»)
    - 6.4. [å“¨å…µ](#å“¨å…µ)
    - 6.5. [Cluster é›†ç¾¤](#cluster-é›†ç¾¤)
- 7. [Redis æŒä¹…åŒ–](#redis-æŒä¹…åŒ–)
- 8. [å‘½ä»¤å®ç°åŸç†](#å‘½ä»¤å®ç°åŸç†)
    - 8.1. [Scan](#scan)

ğŸ’  2026-01-16 15:35:48
****************************************
# Redisåº•å±‚æ•°æ®ç»“æ„
## SDS
> ç®€å•åŠ¨æ€å­—ç¬¦ä¸² [sds: Simple Dynamic Strings](https://github.com/antirez/sds)

### Rediså­˜å‚¨æ•°å€¼çš„æ–¹å¼

ä»¥ä¸‹åœºæ™¯å±•ç¤ºäº†åœ¨Javaå®¢æˆ·ç«¯ setä¸åŒå€¼æ—¶çš„å­˜å‚¨å·®å¼‚ï¼š

```
0           00110000                    (1å­—èŠ‚: 0x30 = ASCII '0')
(short 0)   0011000001010011            (2å­—èŠ‚: 0x30 0x53 = "0S")
0L          0011000001001100            (2å­—èŠ‚: 0x30 0x4C = "0L")
""          0010001000100010            (2å­—èŠ‚: 0x22 0x22 = ä¸¤ä¸ªåŒå¼•å·)
new byte[0] 011110000010011100100111    (3å­—èŠ‚: 0x78 0x30 0x30 = "x00")
```

ä¸ºä»€ä¹ˆå­˜å‚¨é•¿åº¦ä¸åŒï¼Ÿ

**æ ¸å¿ƒåŸå› ï¼šRedisçš„Stringç±»å‹å­˜å‚¨çš„æ˜¯å­—èŠ‚åºåˆ—ï¼Œè€Œä¸æ˜¯Javaçš„æ•°æ®ç±»å‹**

1. **`0` (1å­—èŠ‚)**
   - å­˜å‚¨çš„æ˜¯å­—ç¬¦ `'0'` çš„ASCIIç  (0x30)
   - å¦‚æœä½œä¸ºæ•´æ•°å­˜å‚¨ï¼ŒRedisä¼šä½¿ç”¨**æ•´æ•°ç¼–ç ï¼ˆintç¼–ç ï¼‰**ï¼Œå ç”¨æ›´å°‘ç©ºé—´
   - ä½†å¦‚æœä½œä¸ºå­—ç¬¦ä¸²å­—é¢é‡ `"0"` å­˜å‚¨ï¼Œå°±æ˜¯1ä¸ªå­—èŠ‚

2. **`(short 0)` (2å­—èŠ‚)**
   - å­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸² `"0S"` (0x30 '0' + 0x53 'S')
   - è¿™ä¸æ˜¯Javaçš„shortç±»å‹ï¼Œè€Œæ˜¯**å­—ç¬¦ä¸²å­—é¢é‡**ï¼ŒåŒ…å«ç±»å‹åç¼€å­—ç¬¦
   - Redisæ— æ³•è¯†åˆ«è¿™æ˜¯æ•°å€¼ç±»å‹ï¼Œåªèƒ½ä½œä¸ºæ™®é€šå­—ç¬¦ä¸²å­˜å‚¨

3. **`0L` (2å­—èŠ‚)**
   - å­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸² `"0L"` (0x30 '0' + 0x4C 'L')
   - åŒ…å«Javaçš„longç±»å‹åç¼€ `L`ï¼ŒRediså°†å…¶ä½œä¸ºå­—ç¬¦ä¸²å­˜å‚¨
   - æ¯”çº¯æ•°å­— `0` å¤š1ä¸ªå­—èŠ‚ï¼ˆç±»å‹åç¼€å­—ç¬¦ï¼‰

4. **`""` (2å­—èŠ‚)**
   - å­˜å‚¨çš„æ˜¯ä¸¤ä¸ªåŒå¼•å·å­—ç¬¦ `""` (0x22 0x22)
   - è¿™æ˜¯ç©ºå­—ç¬¦ä¸²çš„å¼•å·è¡¨ç¤ºï¼Œä¸æ˜¯çœŸæ­£çš„ç©ºå­—ç¬¦ä¸²
   - çœŸæ­£çš„ç©ºå­—ç¬¦ä¸²åœ¨Redisä¸­åªå ç”¨SDSå¤´éƒ¨ä¿¡æ¯

5. **`new byte[0]` (3å­—èŠ‚)**
   - å­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸² `"x00"` (0x78 'x' + 0x30 '0' + 0x30 '0')
   - è¿™æ˜¯Javaä»£ç çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œä¸æ˜¯å®é™…çš„byteæ•°ç»„
   - åŒ…å«äº†å®Œæ•´çš„å­—ç¬¦ä¸²å†…å®¹ï¼Œæ‰€ä»¥æœ€é•¿

Redisçš„ç¼–ç ä¼˜åŒ–

Redisä¼šå¯¹Stringç±»å‹è¿›è¡Œç¼–ç ä¼˜åŒ–ï¼š

- **intç¼–ç **ï¼šå½“å€¼å¯ä»¥è¡¨ç¤ºä¸ºæ•´æ•°ä¸”åœ¨èŒƒå›´å†…ï¼ˆ-2^63 åˆ° 2^63-1ï¼‰æ—¶ï¼Œä½¿ç”¨æ•´æ•°ç¼–ç ï¼Œåªå ç”¨8å­—èŠ‚ï¼ˆå­˜å‚¨longå€¼ï¼‰
- **embstrç¼–ç **ï¼šçŸ­å­—ç¬¦ä¸²ï¼ˆâ‰¤44å­—èŠ‚ï¼‰ä½¿ç”¨embstrï¼Œå­—ç¬¦ä¸²å’ŒSDSç»“æ„è¿ç»­å­˜å‚¨
- **rawç¼–ç **ï¼šé•¿å­—ç¬¦ä¸²ä½¿ç”¨rawç¼–ç ï¼ŒSDSç»“æ„å•ç‹¬åˆ†é…

**å…³é”®ç‚¹ï¼š**
- Rediså­˜å‚¨çš„æ˜¯**å­—ç¬¦ä¸²çš„å­—èŠ‚è¡¨ç¤º**ï¼Œä¸æ˜¯Javaçš„æ•°æ®ç±»å‹
- å¦‚æœå­—ç¬¦ä¸²åŒ…å«éæ•°å­—å­—ç¬¦ï¼ˆå¦‚ `L`ã€`S`ã€`x`ï¼‰ï¼ŒRedisæ— æ³•è¯†åˆ«ä¸ºæ•°å€¼ï¼Œåªèƒ½ä½œä¸ºå­—ç¬¦ä¸²å­˜å‚¨
- è¦ä½¿ç”¨Redisçš„æ•´æ•°ç¼–ç ä¼˜åŒ–ï¼Œéœ€è¦å­˜å‚¨çº¯æ•°å­—å­—ç¬¦ä¸²ï¼ˆå¦‚ `"0"`ï¼‰ï¼Œè€Œä¸æ˜¯å¸¦ç±»å‹åç¼€çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ `"0L"`ï¼‰

> å‚è€ƒï¼š
> - [Redis Stringç¼–ç ](https://redis.io/docs/data-types/strings/)

## é“¾è¡¨

Redisä½¿ç”¨**åŒå‘é“¾è¡¨ï¼ˆadlistï¼‰**ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ã€‚

### æºç å®ç°

```C
// é“¾è¡¨èŠ‚ç‚¹
typedef struct listNode {
    struct listNode *prev;  // å‰ç½®èŠ‚ç‚¹
    struct listNode *next;  // åç½®èŠ‚ç‚¹
    void *value;            // èŠ‚ç‚¹å€¼ï¼ˆvoid* æ”¯æŒå­˜å‚¨ä»»æ„ç±»å‹ï¼‰
} listNode;

// é“¾è¡¨ç»“æ„
typedef struct list {
    listNode *head;         // è¡¨å¤´èŠ‚ç‚¹
    listNode *tail;         // è¡¨å°¾èŠ‚ç‚¹
    unsigned long len;      // é“¾è¡¨é•¿åº¦
    void *(*dup)(void *ptr);           // èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•°
    void (*free)(void *ptr);           // èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•°
    int (*match)(void *ptr, void *key); // èŠ‚ç‚¹å€¼å¯¹æ¯”å‡½æ•°
} list;
```

### å®ç°ç‰¹ç‚¹

1. **åŒå‘é“¾è¡¨**ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰prevå’ŒnextæŒ‡é’ˆï¼Œæ”¯æŒåŒå‘éå†
2. **æ— ç¯**ï¼šè¡¨å¤´èŠ‚ç‚¹çš„prevå’Œè¡¨å°¾èŠ‚ç‚¹çš„nextéƒ½æŒ‡å‘NULL
3. **å¸¦è¡¨å¤´è¡¨å°¾æŒ‡é’ˆ**ï¼šO(1)æ—¶é—´å¤æ‚åº¦è®¿é—®å¤´å°¾èŠ‚ç‚¹
4. **å¸¦é•¿åº¦è®¡æ•°å™¨**ï¼šO(1)æ—¶é—´å¤æ‚åº¦è·å–é“¾è¡¨é•¿åº¦
5. **å¤šæ€**ï¼šä½¿ç”¨void*ä¿å­˜èŠ‚ç‚¹å€¼ï¼Œå¯ä»¥ä¿å­˜ä¸åŒç±»å‹çš„å€¼

### Redisä¸­çš„ä½¿ç”¨åœºæ™¯

1. **Listç±»å‹**ï¼ˆå…ƒç´ è¾ƒå¤šæ—¶ï¼‰
   - å½“Listçš„å…ƒç´ æ•°é‡è¾ƒå¤šæˆ–å…ƒç´ è¾ƒå¤§æ—¶ï¼Œä½¿ç”¨é“¾è¡¨ä½œä¸ºåº•å±‚å®ç°
   - æ”¯æŒLPUSHã€RPUSHã€LPOPã€RPOPç­‰æ“ä½œ
   - å°åˆ—è¡¨ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰ä¼˜åŒ–

2. **å‘å¸ƒè®¢é˜…ï¼ˆPub/Subï¼‰**
   - ç»´æŠ¤è®¢é˜…æŸä¸ªé¢‘é“çš„å®¢æˆ·ç«¯åˆ—è¡¨
   - ä½¿ç”¨é“¾è¡¨å­˜å‚¨è®¢é˜…è€…ä¿¡æ¯

3. **æ…¢æŸ¥è¯¢æ—¥å¿—**
   - ä½¿ç”¨é“¾è¡¨ä¿å­˜æ…¢æŸ¥è¯¢æ—¥å¿—è®°å½•

4. **ç›‘è§†å™¨ï¼ˆMonitorï¼‰**
   - ä¿å­˜æ‰€æœ‰ç›‘è§†Rediså‘½ä»¤æ‰§è¡Œçš„å®¢æˆ·ç«¯

5. **å…¶ä»–å†…éƒ¨ç”¨é€”**
   - ä¿å­˜å¤šä¸ªæ•°æ®åº“çš„é”®ç©ºé—´
   - ä¿å­˜å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒº

## å­—å…¸

Redisä½¿ç”¨**å“ˆå¸Œè¡¨ï¼ˆdictï¼‰**ä½œä¸ºå­—å…¸çš„åº•å±‚å®ç°ï¼Œç±»ä¼¼äºJavaçš„HashMapã€‚

### æºç å®ç°

```C
// å“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼ˆé”®å€¼å¯¹ï¼‰
typedef struct dictEntry {
    void *key;              // é”®
    union {
        void *val;          // å€¼ï¼ˆå¯ä»¥æ˜¯å„ç§ç±»å‹ï¼‰
        uint64_t u64;
        int64_t s64;
        double d;
    } v;
    struct dictEntry *next; // æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè§£å†³å“ˆå¸Œå†²çªï¼Œä½¿ç”¨é“¾åœ°å€æ³•ï¼‰
} dictEntry;

// å“ˆå¸Œè¡¨
typedef struct dictht {
    dictEntry **table;      // å“ˆå¸Œè¡¨æ•°ç»„
    unsigned long size;     // å“ˆå¸Œè¡¨å¤§å°ï¼ˆæ¡¶çš„æ•°é‡ï¼‰
    unsigned long sizemask; // å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼ï¼ˆsize-1ï¼‰
    unsigned long used;     // å·²æœ‰èŠ‚ç‚¹æ•°é‡
} dictht;

// å­—å…¸
typedef struct dict {
    dictType *type;         // ç±»å‹ç‰¹å®šå‡½æ•°ï¼ˆç”¨äºå¤šæ€ï¼‰
    void *privdata;         // ç§æœ‰æ•°æ®
    dictht ht[2];          // ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œç”¨äºæ¸è¿›å¼rehash
    long rehashidx;        // rehashç´¢å¼•ï¼Œ-1è¡¨ç¤ºæœªè¿›è¡Œrehash
    int16_t pauserehash;   // rehashæš‚åœæ ‡å¿—
} dict;
```

### å®ç°ç‰¹ç‚¹

1. **é“¾åœ°å€æ³•è§£å†³å†²çª**ï¼šä½¿ç”¨é“¾è¡¨è¿æ¥å“ˆå¸Œå€¼ç›¸åŒçš„é”®å€¼å¯¹
2. **æ¸è¿›å¼rehash**ï¼š
   - ä½¿ç”¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼ˆht[0]å’Œht[1]ï¼‰
   - åœ¨rehashè¿‡ç¨‹ä¸­ï¼Œæ–°æ•°æ®å†™å…¥ht[1]ï¼ŒæŸ¥è¯¢æ—¶åŒæ—¶æŸ¥æ‰¾ä¸¤ä¸ªè¡¨
   - é€æ­¥å°†ht[0]çš„æ•°æ®è¿ç§»åˆ°ht[1]
   - é¿å…ä¸€æ¬¡æ€§rehashé€ æˆæœåŠ¡é˜»å¡
3. **å“ˆå¸Œè¡¨æ‰©å®¹**ï¼šå½“è´Ÿè½½å› å­ï¼ˆused/sizeï¼‰â‰¥1æ—¶è§¦å‘æ‰©å®¹ï¼Œæ–°å¤§å°ä¸ºç¬¬ä¸€ä¸ªâ‰¥used*2çš„2çš„å¹‚
4. **å“ˆå¸Œè¡¨æ”¶ç¼©**ï¼šå½“è´Ÿè½½å› å­<0.1æ—¶è§¦å‘æ”¶ç¼©

### Redisä¸­çš„ä½¿ç”¨åœºæ™¯

1. **Hashç±»å‹**
   - Hashç±»å‹çš„åº•å±‚å®ç°
   - å­˜å‚¨å­—æ®µ-å€¼çš„æ˜ å°„å…³ç³»

2. **Setç±»å‹**ï¼ˆå…ƒç´ è¾ƒå¤šæ—¶ï¼‰
   - å½“Setå…ƒç´ è¾ƒå¤šæ—¶ï¼Œä½¿ç”¨å­—å…¸å­˜å‚¨
   - å­—å…¸çš„é”®å°±æ˜¯Setçš„å…ƒç´ ï¼Œå€¼ä¸ºNULL
   - å°é›†åˆä½¿ç”¨æ•´æ•°é›†åˆï¼ˆintsetï¼‰ä¼˜åŒ–

3. **Zsetç±»å‹**ï¼ˆå…ƒç´ è¾ƒå¤šæ—¶ï¼‰
   - ä½¿ç”¨å­—å…¸å­˜å‚¨memberåˆ°scoreçš„æ˜ å°„
   - é…åˆè·³è¡¨å®ç°æœ‰åºé›†åˆ
   - å°æœ‰åºé›†åˆä½¿ç”¨å‹ç¼©åˆ—è¡¨ä¼˜åŒ–

4. **æ•°æ®åº“çš„é”®ç©ºé—´ï¼ˆkeyspaceï¼‰**
   - Redisæ•°æ®åº“æœ¬èº«å°±æ˜¯ä¸€ä¸ªå­—å…¸
   - é”®ç©ºé—´å­˜å‚¨æ‰€æœ‰æ•°æ®åº“çš„é”®å€¼å¯¹
   - é”®æ˜¯æ•°æ®åº“çš„é”®ï¼Œå€¼æ˜¯æ•°æ®åº“çš„å€¼å¯¹è±¡

5. **è¿‡æœŸé”®å­—å…¸**
   - å­˜å‚¨æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®åŠå…¶è¿‡æœŸæ—¶é—´
   - é”®æ˜¯æ•°æ®åº“çš„é”®ï¼Œå€¼æ˜¯è¿‡æœŸæ—¶é—´æˆ³

6. **å…¶ä»–å†…éƒ¨ç”¨é€”**
   - ä¿å­˜å®¢æˆ·ç«¯çŠ¶æ€
   - ä¿å­˜å‘½ä»¤è¡¨ï¼ˆcommand tableï¼‰
   - ä¿å­˜Luaè„šæœ¬çš„ç¼“å­˜


## è·³è¡¨
> [è·³è¡¨åŸºç¡€](/Skills/CS/DS/LinearList.md)

> [Redisè®¾è®¡ä¸å®ç°: è·³è·ƒè¡¨çš„å®ç°](http://redisbook.com/preview/skiplist/datastruct.html)

Redis çš„è·³è·ƒè¡¨ç”± redis.h/zskiplistNode å’Œ redis.h/zskiplist ä¸¤ä¸ªç»“æ„å®šä¹‰ï¼Œ å…¶ä¸­ zskiplistNode ç»“æ„ç”¨äºè¡¨ç¤ºè·³è·ƒè¡¨èŠ‚ç‚¹  
è€Œ zskiplist ç»“æ„åˆ™ç”¨äºä¿å­˜è·³è·ƒè¡¨èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯ï¼Œ æ¯”å¦‚èŠ‚ç‚¹çš„æ•°é‡ï¼Œ ä»¥åŠæŒ‡å‘è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„æŒ‡é’ˆ ç­‰ç­‰ã€‚

```C
    typedef struct zskiplistNode 
    {
        // åé€€æŒ‡é’ˆ
        struct zskiplistNode *backward;
        // åˆ†å€¼
        double score;
        // æˆå‘˜å¯¹è±¡
        robj *obj;

        // å±‚
        struct zskiplistLevel {
            // å‰è¿›æŒ‡é’ˆ
            struct zskiplistNode *forward;
            // è·¨åº¦
            unsigned int span;
        } level[];
    } zskiplistNode;
```
## æ•´æ•°é›†åˆ

æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯Setç±»å‹çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œç”¨äºå­˜å‚¨**æœ‰åºã€æ— é‡å¤çš„æ•´æ•°é›†åˆ**ã€‚

### æºç å®ç°

```C
// æ•´æ•°é›†åˆ
typedef struct intset {
    uint32_t encoding;  // ç¼–ç æ–¹å¼ï¼šINTSET_ENC_INT16/INT32/INT64
    uint32_t length;    // é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡
    int8_t contents[];  // ä¿å­˜å…ƒç´ çš„æ•°ç»„ï¼ˆæŒ‰å€¼çš„å¤§å°æœ‰åºæ’åˆ—ï¼Œæ— é‡å¤ï¼‰
} intset;
```

### å®ç°ç‰¹ç‚¹

1. **æœ‰åºå­˜å‚¨**ï¼šcontentsæ•°ç»„ä¸­çš„å…ƒç´ æŒ‰å€¼çš„å¤§å°æœ‰åºæ’åˆ—
2. **æ— é‡å¤**ï¼šé›†åˆä¸­ä¸å­˜åœ¨é‡å¤çš„å…ƒç´ 
3. **åŠ¨æ€ç¼–ç å‡çº§**ï¼š
   - åˆå§‹ç¼–ç ä¸º`INTSET_ENC_INT16`ï¼ˆ16ä½æ•´æ•°ï¼‰
   - å½“æ·»åŠ çš„å…ƒç´ è¶…å‡ºå½“å‰ç¼–ç èŒƒå›´æ—¶ï¼Œè‡ªåŠ¨å‡çº§ç¼–ç 
   - å‡çº§è¿‡ç¨‹ï¼šINT16 â†’ INT32 â†’ INT64
   - **å‡çº§åä¸æ”¯æŒé™çº§**ï¼Œå³ä½¿åˆ é™¤å¤§å…ƒç´ ä¹Ÿä¸ä¼šé™çº§
4. **äºŒåˆ†æŸ¥æ‰¾**ï¼šç”±äºæœ‰åºï¼ŒæŸ¥æ‰¾æ“ä½œä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦O(log n)

### å‡çº§è¿‡ç¨‹ç¤ºä¾‹

```C
// åˆå§‹ï¼šINTSET_ENC_INT16ï¼Œå­˜å‚¨ [1, 2, 3]
// æ·»åŠ  32768ï¼ˆè¶…å‡ºint16èŒƒå›´ï¼‰
// 1. åˆ†é…æ–°ç©ºé—´ï¼ˆæ¯ä¸ªå…ƒç´ ä»2å­—èŠ‚æ‰©å±•åˆ°4å­—èŠ‚ï¼‰
// 2. å°†åŸæœ‰å…ƒç´ è½¬æ¢ä¸ºæ–°ç¼–ç å¹¶é‡æ–°æ’åˆ—
// 3. æ·»åŠ æ–°å…ƒç´ 
// ç»“æœï¼šINTSET_ENC_INT32ï¼Œå­˜å‚¨ [1, 2, 3, 32768]
```

### Redisä¸­çš„ä½¿ç”¨åœºæ™¯

1. **Setç±»å‹**ï¼ˆå…ƒç´ è¾ƒå°‘ä¸”éƒ½æ˜¯æ•´æ•°æ—¶ï¼‰
   - å½“Setæ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ä½¿ç”¨intsetï¼š
     - æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°
     - å…ƒç´ æ•°é‡ä¸è¶…è¿‡`set-max-intset-entries`é…ç½®ï¼ˆé»˜è®¤512ï¼‰
   - ä¸æ»¡è¶³æ¡ä»¶æ—¶è½¬æ¢ä¸ºå­—å…¸ï¼ˆdictï¼‰å®ç°

2. **ä¼˜åŠ¿**
   - å†…å­˜æ•ˆç‡é«˜ï¼šæ•´æ•°ç›´æ¥å­˜å‚¨ï¼Œä¸éœ€è¦é¢å¤–çš„æŒ‡é’ˆå’Œå¯¹è±¡å¤´
   - æŸ¥æ‰¾æ•ˆç‡é«˜ï¼šæœ‰åºæ•°ç»„+äºŒåˆ†æŸ¥æ‰¾

3. **é™åˆ¶**
   - åªèƒ½å­˜å‚¨æ•´æ•°
   - å…ƒç´ æ•°é‡æœ‰é™åˆ¶
   - å‡çº§åä¸æ”¯æŒé™çº§ï¼Œå¯èƒ½é€ æˆç©ºé—´æµªè´¹

## å‹ç¼©åˆ—è¡¨

å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰æ˜¯Redisä¸ºäº†**èŠ‚çœå†…å­˜**è€Œè®¾è®¡çš„é¡ºåºå‹æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨å°è§„æ¨¡çš„åˆ—è¡¨æˆ–å“ˆå¸Œè¡¨ã€‚

### æºç å®ç°

å‹ç¼©åˆ—è¡¨æ˜¯ä¸€å—**è¿ç»­çš„å†…å­˜ç©ºé—´**ï¼Œæ²¡æœ‰ä½¿ç”¨ç»“æ„ä½“ï¼Œè€Œæ˜¯é€šè¿‡ç‰¹æ®Šç¼–ç å®ç°ï¼š

```
<zlbytes> <zltail> <zllen> <entry> <entry> ... <entry> <zlend>
```

- **zlbytes**ï¼šuint32_tï¼Œæ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°
- **zltail**ï¼šuint32_tï¼Œåˆ°è¾¾è¡¨å°¾èŠ‚ç‚¹çš„åç§»é‡ï¼ˆç”¨äºå¿«é€Ÿå®šä½å°¾èŠ‚ç‚¹ï¼‰
- **zllen**ï¼šuint16_tï¼ŒèŠ‚ç‚¹æ•°é‡ï¼ˆå½“å€¼<65535æ—¶æœ‰æ•ˆï¼Œå¦åˆ™éœ€è¦éå†ï¼‰
- **entry**ï¼šåˆ—è¡¨èŠ‚ç‚¹ï¼Œé•¿åº¦å¯å˜
- **zlend**ï¼šuint8_tï¼Œç‰¹æ®Šå€¼0xFFï¼Œæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯

### èŠ‚ç‚¹ç»“æ„ï¼ˆentryï¼‰

æ¯ä¸ªèŠ‚ç‚¹ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

```
<prevlen> <encoding> <data>
```

- **prevlen**ï¼šå‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ï¼ˆç”¨äºåå‘éå†ï¼‰
  - å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹é•¿åº¦<254å­—èŠ‚ï¼Œä½¿ç”¨1å­—èŠ‚
  - å¦åˆ™ä½¿ç”¨5å­—èŠ‚ï¼ˆç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xFEï¼Œå4å­—èŠ‚å­˜å‚¨é•¿åº¦ï¼‰
- **encoding**ï¼šç¼–ç æ–¹å¼ï¼Œè®°å½•èŠ‚ç‚¹çš„æ•°æ®ç±»å‹å’Œé•¿åº¦
  - 1å­—èŠ‚ã€2å­—èŠ‚ã€5å­—èŠ‚çš„æ•´æ•°
  - å­—ç¬¦ä¸²ï¼ˆ1å­—èŠ‚ã€2å­—èŠ‚ã€5å­—èŠ‚é•¿åº¦å‰ç¼€ï¼‰
- **data**ï¼šèŠ‚ç‚¹çš„å®é™…æ•°æ®

### å®ç°ç‰¹ç‚¹

1. **å†…å­˜è¿ç»­**ï¼šæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ä¸€å—è¿ç»­å†…å­˜ä¸­ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡
2. **å˜é•¿ç¼–ç **ï¼šæ ¹æ®æ•°æ®å¤§å°é€‰æ‹©æœ€åˆé€‚çš„ç¼–ç æ–¹å¼
3. **è¿é”æ›´æ–°**ï¼šæ’å…¥æˆ–åˆ é™¤èŠ‚ç‚¹å¯èƒ½å¯¼è‡´åç»­èŠ‚ç‚¹çš„prevlenå­—æ®µéœ€è¦æ›´æ–°
   - æœ€åæƒ…å†µä¸‹æ—¶é—´å¤æ‚åº¦O(nÂ²)
   - ä½†å®é™…åœºæ™¯ä¸­å¾ˆå°‘å‘ç”Ÿï¼Œå› ä¸ºéœ€è¦è¿ç»­å¤šä¸ªèŠ‚ç‚¹é•¿åº¦åœ¨250-253å­—èŠ‚ä¹‹é—´

### Redisä¸­çš„ä½¿ç”¨åœºæ™¯

1. **Listç±»å‹**ï¼ˆå…ƒç´ è¾ƒå°‘ä¸”è¾ƒå°æ—¶ï¼‰
   - å½“Listæ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ä½¿ç”¨ziplistï¼š
     - æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ é•¿åº¦<`list-max-ziplist-value`ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰
     - å…ƒç´ æ•°é‡<`list-max-ziplist-entries`ï¼ˆé»˜è®¤512ï¼‰
   - ä¸æ»¡è¶³æ¡ä»¶æ—¶è½¬æ¢ä¸ºåŒå‘é“¾è¡¨ï¼ˆlinkedlistï¼‰å®ç°

2. **Hashç±»å‹**ï¼ˆå­—æ®µè¾ƒå°‘ä¸”è¾ƒå°æ—¶ï¼‰
   - å½“Hashæ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ä½¿ç”¨ziplistï¼š
     - æ‰€æœ‰é”®å€¼å¯¹çš„é”®å’Œå€¼é•¿åº¦<`hash-max-ziplist-value`ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰
     - é”®å€¼å¯¹æ•°é‡<`hash-max-ziplist-entries`ï¼ˆé»˜è®¤512ï¼‰
   - ä¸æ»¡è¶³æ¡ä»¶æ—¶è½¬æ¢ä¸ºå­—å…¸ï¼ˆdictï¼‰å®ç°

3. **Zsetç±»å‹**ï¼ˆå…ƒç´ è¾ƒå°‘ä¸”è¾ƒå°æ—¶ï¼‰
   - å½“Zsetæ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ä½¿ç”¨ziplistï¼š
     - æ‰€æœ‰å…ƒç´ é•¿åº¦<`zset-max-ziplist-value`ï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰
     - å…ƒç´ æ•°é‡<`zset-max-ziplist-entries`ï¼ˆé»˜è®¤128ï¼‰
   - ä¸æ»¡è¶³æ¡ä»¶æ—¶è½¬æ¢ä¸ºè·³è¡¨+å­—å…¸å®ç°

4. **ä¼˜åŠ¿**
   - å†…å­˜å ç”¨å°ï¼šç´§å‡‘å­˜å‚¨ï¼Œæ— é¢å¤–æŒ‡é’ˆå¼€é”€
   - é€‚åˆå°æ•°æ®ï¼šå°åˆ—è¡¨/å“ˆå¸Œè¡¨çš„å†…å­˜æ•ˆç‡é«˜

5. **åŠ£åŠ¿**
   - æŸ¥æ‰¾æ•ˆç‡ä½ï¼šéœ€è¦éå†ï¼Œæ—¶é—´å¤æ‚åº¦O(n)
   - ä¿®æ”¹æ•ˆç‡ä½ï¼šæ’å…¥/åˆ é™¤å¯èƒ½è§¦å‘è¿é”æ›´æ–°

## å¯¹è±¡

Redisä½¿ç”¨**å¯¹è±¡ç³»ç»Ÿ**æ¥ç»Ÿä¸€ç®¡ç†ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œæ‰€æœ‰é”®å€¼å¯¹çš„å€¼éƒ½æ˜¯å¯¹è±¡ï¼ˆrobjï¼‰ã€‚

### æºç å®ç°

```C
// Rediså¯¹è±¡
typedef struct redisObject {
    unsigned type:4;        // å¯¹è±¡ç±»å‹ï¼ˆ4ä½ï¼‰ï¼šSTRING, LIST, SET, ZSET, HASHç­‰
    unsigned encoding:4;    // ç¼–ç æ–¹å¼ï¼ˆ4ä½ï¼‰ï¼šint, embstr, raw, ziplist, linkedlistç­‰
    unsigned lru:LRU_BITS; // LRUæ—¶é—´æˆ³æˆ–LFUè®¡æ•°å™¨ï¼ˆç”¨äºå†…å­˜æ·˜æ±°ï¼‰
    int refcount;           // å¼•ç”¨è®¡æ•°ï¼ˆç”¨äºå†…å­˜å›æ”¶ï¼‰
    void *ptr;              // æŒ‡å‘åº•å±‚æ•°æ®ç»“æ„çš„æŒ‡é’ˆ
} robj;
```

### å¯¹è±¡ç±»å‹ï¼ˆtypeï¼‰

- **REDIS_STRING**ï¼šå­—ç¬¦ä¸²å¯¹è±¡
- **REDIS_LIST**ï¼šåˆ—è¡¨å¯¹è±¡
- **REDIS_SET**ï¼šé›†åˆå¯¹è±¡
- **REDIS_ZSET**ï¼šæœ‰åºé›†åˆå¯¹è±¡
- **REDIS_HASH**ï¼šå“ˆå¸Œå¯¹è±¡

### ç¼–ç æ–¹å¼ï¼ˆencodingï¼‰

ä¸åŒå¯¹è±¡ç±»å‹å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç¼–ç æ–¹å¼ï¼š

#### Stringå¯¹è±¡çš„ç¼–ç 

1. **intç¼–ç **ï¼šæ•´æ•°å€¼ï¼Œç›´æ¥å­˜å‚¨åœ¨pträ¸­ï¼ˆpträ¸å†æ˜¯æŒ‡é’ˆï¼Œè€Œæ˜¯æ•´æ•°å€¼ï¼‰
2. **embstrç¼–ç **ï¼šçŸ­å­—ç¬¦ä¸²ï¼ˆâ‰¤44å­—èŠ‚ï¼‰ï¼ŒSDSå’ŒredisObjectè¿ç»­å­˜å‚¨
3. **rawç¼–ç **ï¼šé•¿å­—ç¬¦ä¸²ï¼ŒSDSå•ç‹¬åˆ†é…å†…å­˜

#### Listå¯¹è±¡çš„ç¼–ç 

1. **ziplistç¼–ç **ï¼šå‹ç¼©åˆ—è¡¨å®ç°ï¼ˆå°åˆ—è¡¨ï¼‰
2. **linkedlistç¼–ç **ï¼šåŒå‘é“¾è¡¨å®ç°ï¼ˆå¤§åˆ—è¡¨ï¼‰
3. **quicklistç¼–ç **ï¼ˆRedis 3.2+ï¼‰ï¼šåŒå‘é“¾è¡¨+å‹ç¼©åˆ—è¡¨çš„ç»„åˆ

#### Setå¯¹è±¡çš„ç¼–ç 

1. **intsetç¼–ç **ï¼šæ•´æ•°é›†åˆå®ç°ï¼ˆå°é›†åˆï¼Œä¸”éƒ½æ˜¯æ•´æ•°ï¼‰
2. **hashtableç¼–ç **ï¼šå­—å…¸å®ç°ï¼ˆå¤§é›†åˆæˆ–åŒ…å«éæ•´æ•°ï¼‰

#### Zsetå¯¹è±¡çš„ç¼–ç 

1. **ziplistç¼–ç **ï¼šå‹ç¼©åˆ—è¡¨å®ç°ï¼ˆå°æœ‰åºé›†åˆï¼‰
2. **skiplistç¼–ç **ï¼šè·³è¡¨+å­—å…¸å®ç°ï¼ˆå¤§æœ‰åºé›†åˆï¼‰
   - è·³è¡¨ï¼šæŒ‰scoreæ’åºï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢
   - å­—å…¸ï¼šmemberåˆ°scoreçš„æ˜ å°„ï¼ŒO(1)æŸ¥æ‰¾score

#### Hashå¯¹è±¡çš„ç¼–ç 

1. **ziplistç¼–ç **ï¼šå‹ç¼©åˆ—è¡¨å®ç°ï¼ˆå°å“ˆå¸Œè¡¨ï¼‰
2. **hashtableç¼–ç **ï¼šå­—å…¸å®ç°ï¼ˆå¤§å“ˆå¸Œè¡¨ï¼‰

### å¤šæ€å®ç°

é€šè¿‡typeå’Œencodingçš„ç»„åˆï¼ŒRediså®ç°äº†å¤šæ€ï¼š

```C
// åŒä¸€ä¸ªå‘½ä»¤å¯ä»¥å¤„ç†ä¸åŒç±»å‹çš„å¯¹è±¡
// ä¾‹å¦‚ï¼šDELå‘½ä»¤å¯ä»¥åˆ é™¤ä»»ä½•ç±»å‹çš„å¯¹è±¡
void delCommand(redisClient *c) {
    delGenericCommand(c, server.lazyfree_lazy_user_del);
}
```

### å†…å­˜ç®¡ç†

1. **å¼•ç”¨è®¡æ•°**ï¼šé€šè¿‡refcountå®ç°å¯¹è±¡å…±äº«å’Œå†…å­˜å›æ”¶
   - åˆ›å»ºå¯¹è±¡æ—¶refcount=1
   - å¯¹è±¡è¢«å¼•ç”¨æ—¶refcount++
   - å¯¹è±¡ä¸å†è¢«å¼•ç”¨æ—¶refcount--
   - refcount=0æ—¶é‡Šæ”¾å¯¹è±¡

2. **LRU/LFU**ï¼šé€šè¿‡lruå­—æ®µå®ç°å†…å­˜æ·˜æ±°ç­–ç•¥
   - LRUï¼šè®°å½•æœ€åè®¿é—®æ—¶é—´
   - LFUï¼šè®°å½•è®¿é—®é¢‘ç‡

### Redisä¸­çš„ä½¿ç”¨åœºæ™¯

1. **æ‰€æœ‰é”®å€¼å¯¹çš„å€¼éƒ½æ˜¯å¯¹è±¡**
   - æ•°æ®åº“çš„é”®ç©ºé—´å­˜å‚¨çš„æ˜¯`robj*`æŒ‡é’ˆ
   - æ‰€æœ‰å‘½ä»¤æ“ä½œçš„éƒ½æ˜¯å¯¹è±¡

2. **ç¼–ç è½¬æ¢**
   - æ ¹æ®æ•°æ®å¤§å°å’Œç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç¼–ç 
   - æ•°æ®å˜åŒ–æ—¶å¯èƒ½è§¦å‘ç¼–ç è½¬æ¢ï¼ˆå¦‚ziplistâ†’linkedlistï¼‰

3. **å¯¹è±¡å…±äº«**
   - 0-9999çš„æ•´æ•°å¯¹è±¡ä¼šè¢«å…±äº«ï¼ˆrefcount>1ï¼‰
   - å‡å°‘å†…å­˜å ç”¨

4. **ç±»å‹æ£€æŸ¥**
   - é€šè¿‡typeå­—æ®µæ£€æŸ¥å¯¹è±¡ç±»å‹
   - å‘½ä»¤æ‰§è¡Œå‰ä¼šæ£€æŸ¥ç±»å‹æ˜¯å¦åŒ¹é…

### ç¼–ç é€‰æ‹©ç­–ç•¥

Redisä¼šæ ¹æ®æ•°æ®ç‰¹å¾è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç¼–ç ï¼š

- **å°æ•°æ®**ï¼šä¼˜å…ˆä½¿ç”¨å†…å­˜ç´§å‡‘çš„ç¼–ç ï¼ˆziplistã€intsetã€embstrï¼‰
- **å¤§æ•°æ®**ï¼šä¼˜å…ˆä½¿ç”¨æ€§èƒ½æ›´å¥½çš„ç¼–ç ï¼ˆlinkedlistã€hashtableã€skiplistã€rawï¼‰
- **åŠ¨æ€è½¬æ¢**ï¼šæ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨è½¬æ¢ç¼–ç 


************************

# Rediså¸¸ç”¨å‘½ä»¤
> [Commands | Docs](https://redis.io/docs/latest/commands/)  


- å…³é—­æ•°æ®åº“ `shutdown` è¯¥å‘½ä»¤ä¼šåœ¨å…³é—­æ•°æ®åº“å‰ä¿å­˜æ•°æ®
- ä¿å­˜å†…å­˜ä¸­æ•°æ®åˆ°æ–‡ä»¶ `save`
- è®¤è¯ `auth å£ä»¤` 
- æµ‹è¯•è”é€šæ€§ `ping` è¿æ¥æˆåŠŸä¼šè¿”å›pong

- æ¨¡ç³Šåˆ é™¤ 
    - åˆ é™¤ 2 æ•°æ®åº“ä¸­`detail-2018-07-0*`æ¨¡å¼çš„æ•°æ®: `./redis-cli -p 6666 -n 2 keys "detail-2018-07-0*" | xargs  ./redis-cli -p 6666 -n 2 del`

> [redis-stat](https://github.com/junegunn/redis-stat)

## è¿‡æœŸ
- `expire key seconds` è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´
- `PTTL/TTL key ` æŸ¥çœ‹é”®å‰©ä½™è¿‡æœŸæ—¶é—´ï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰ ms/s
    -  -1 è¡¨ç¤ºæ°¸ä¹… -2 è¡¨ç¤ºæ²¡æœ‰è¯¥key

## äº‹åŠ¡

- `DISCARD` å–æ¶ˆäº‹åŠ¡ï¼Œæ”¾å¼ƒæ‰§è¡Œäº‹åŠ¡å—å†…çš„æ‰€æœ‰å‘½ä»¤ã€‚
- `EXEC`
    - æ‰§è¡Œæ‰€æœ‰äº‹åŠ¡å—å†…çš„å‘½ä»¤ã€‚å‡å¦‚æŸä¸ª(æˆ–æŸäº›) key æ­£å¤„äº WATCH å‘½ä»¤çš„ç›‘è§†ä¹‹ä¸‹ï¼Œä¸”äº‹åŠ¡å—ä¸­æœ‰å’Œè¿™ä¸ª(æˆ–è¿™äº›) key ç›¸å…³çš„å‘½ä»¤ï¼Œ
    - é‚£ä¹ˆ EXEC å‘½ä»¤åªåœ¨è¿™ä¸ª(æˆ–è¿™äº›) key æ²¡æœ‰è¢«å…¶ä»–å‘½ä»¤æ‰€æ”¹åŠ¨çš„æƒ…å†µä¸‹æ‰§è¡Œå¹¶ç”Ÿæ•ˆï¼Œå¦åˆ™è¯¥äº‹åŠ¡è¢«æ‰“æ–­(abort)ã€‚
- `MULTI` æ ‡è®°ä¸€ä¸ªäº‹åŠ¡å—çš„å¼€å§‹ã€‚äº‹åŠ¡å—å†…çš„å¤šæ¡å‘½ä»¤ä¼šæŒ‰ç…§å…ˆåé¡ºåºè¢«æ”¾è¿›ä¸€ä¸ªé˜Ÿåˆ—å½“ä¸­ï¼Œæœ€åç”± EXEC å‘½ä»¤åŸå­æ€§(atomic)åœ°æ‰§è¡Œã€‚
- `UNWATCH` 
    - å–æ¶ˆ WATCH å‘½ä»¤å¯¹æ‰€æœ‰ key çš„ç›‘è§†ã€‚å¦‚æœåœ¨æ‰§è¡Œ WATCH å‘½ä»¤ä¹‹åï¼Œ EXEC å‘½ä»¤æˆ– DISCARD å‘½ä»¤å…ˆè¢«æ‰§è¡Œäº†çš„è¯ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å†æ‰§è¡Œ UNWATCH äº†ã€‚
    - å› ä¸º EXEC å‘½ä»¤ä¼šæ‰§è¡Œäº‹åŠ¡ï¼Œå› æ­¤ WATCH å‘½ä»¤çš„æ•ˆæœå·²ç»äº§ç”Ÿäº†ï¼›è€Œ DISCARD å‘½ä»¤åœ¨å–æ¶ˆäº‹åŠ¡çš„åŒæ—¶ä¹Ÿä¼šå–æ¶ˆæ‰€æœ‰å¯¹ key çš„ç›‘è§†ï¼Œå› æ­¤è¿™ä¸¤ä¸ªå‘½ä»¤æ‰§è¡Œä¹‹åï¼Œå°±æ²¡æœ‰å¿…è¦æ‰§è¡Œ UNWATCH äº†ã€‚
- `WATCH key [key ...]`
    - ç›‘è§†ä¸€ä¸ª(æˆ–å¤šä¸ª) key ï¼Œå¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¿™ä¸ª(æˆ–è¿™äº›) key è¢«å…¶ä»–å‘½ä»¤æ‰€æ”¹åŠ¨ï¼Œé‚£ä¹ˆäº‹åŠ¡å°†è¢«æ‰“æ–­ã€‚

## ACL
> [ACL | Docs](https://redis.io/docs/latest/operate/oss_and_stack/management/security/acl/)`Redis6å¼€å§‹æ”¯æŒç”¨æˆ·æƒé™æ§åˆ¶`  

- ACL LIST
    - æ–°å»ºçš„Redisèƒ½çœ‹åˆ°ä»¥ä¸‹è¾“å‡º `user default on nopass ~* +@all` é»˜è®¤ç”¨æˆ· æ— å¯†ç ï¼Œæ“ä½œæ‰€æœ‰keyï¼Œæ‹¥æœ‰æ‰€æœ‰å‘½ä»¤æƒé™
- ACL SETUSER æ–°å»ºå’Œä¿®æ”¹ç”¨æˆ·
    - ç”¨æˆ·aliceå¯¹cachedå‰ç¼€keyåªæœ‰getå‘½ä»¤æƒé™ï¼š ` ACL SETUSER alice on >p1pp0 ~cached:* +get `
    - cachedå‰ç¼€çš„keyæ‹¥æœ‰å…¨éƒ¨å‘½ä»¤æƒé™ï¼š` ACL SETUSER alice on >p1pp0 ~cached:* +@all `
    - æ³¨æ„åœ¨è„šæœ¬ä½¿ç”¨æ–¹é¢ `+@all` ä¹Ÿä¸æ˜¯å…¨éƒ¨æƒé™ï¼Œéœ€è¦é¢å¤–å£°æ˜ï¼Œä¾‹å¦‚Redissonä¸­çš„é”ä½¿ç”¨åˆ°çš„å‘½ä»¤ 
        - `ACL SETUSER <your_username> on >password +@all ~* &* +@scripting +@pubsub +EVAL +EVALSHA +PUBLISH +SUBSCRIBE +SCRIPT|EXISTS +SCRIPT|LOAD +SCRIPT|FLUSH`
- ACL whoami 


## æœåŠ¡å™¨

- CLIENT  
- CONFIG 
- BGREWRITEAOF
- SAVE
- BGSAVE
- FLUSHALL
- FLUSHDB
- INFO
    - [å‚è€ƒ: redis info å‘½ä»¤æŸ¥çœ‹redisä½¿ç”¨æƒ…å†µ](https://blog.csdn.net/kexiaoling/article/details/51810919)
    - info stats ä¸­ total_commands_processed æ˜¯å®é™…è¯·æ±‚, è¿˜æ˜¯è¯´redisè‡ªå·±æ‰§è¡Œçš„å‘½ä»¤ TODO 
- LASTSAVE
- [MONITOR](https://redis.io/docs/latest/commands/monitor/)
    - debugå‘½ä»¤ï¼Œå¯ä»¥å°†Redisæ‰§è¡Œçš„æ¯ä¸€æ¡æŒ‡ä»¤éƒ½å›ä¼ å¹¶è¾“å‡ºï¼Œå¯ä»¥ç”¨æ¥åšRedisæµé‡å¤åˆ¶ï¼Œæ³¨æ„å¯¹æ€§èƒ½å½±å“å¾ˆå¤§ï¼Œç”Ÿäº§æ…ç”¨ã€‚
    - [Redis æµé‡å¤åˆ¶ã€æµé‡å›æ”¾ã€æµé‡é•œåƒ](http://www.kailing.pub/article/index/arcid/342.html)
- PSYNC
- SHUTDOWN
- SLAVEOF
- SLOWLOG
- SYNC
- TIME

************************

# æ•°æ®å®‰å…¨å’Œæ€§èƒ½
## Latency
ç¼“å­˜æœ€é‡è¦çš„æ€§èƒ½æŒ‡æ ‡å°±æ˜¯å»¶è¿Ÿï¼Œä½†æ˜¯å»¶è¿Ÿä¼šå—åˆ°å¤šé¡¹ä¸šåŠ¡æˆ–åŠŸèƒ½å½±å“ã€‚[Redisä¸ºä»€ä¹ˆå˜æ…¢äº†ï¼Ÿä¸€æ–‡è®²é€å¦‚ä½•æ’æŸ¥Redisæ€§èƒ½é—®é¢˜ ](https://mp.weixin.qq.com/s?__biz=Mzg4Nzc3NjkzOA==&mid=2247486198&idx=1&sn=e4b34ef7889bb95260e3a636662a7192&chksm=cf847933f8f3f025a1b00fc965781a33024158a4275ebaf2da393c403500a86d9c04af16ce40#rd)

- 60 ç§’å†…çš„æœ€å¤§å“åº”å»¶è¿Ÿ `redis-cli -h 127.0.0.1 -p 6379 --intrinsic-latency 60`
- é—´éš” 1 ç§’ï¼Œé‡‡æ · Redis çš„å¹³å‡æ“ä½œè€—æ—¶ `redis-cli -h 127.0.0.1 -p 6379 --latency-history -i 1`

> SLOWLOG
- å‘½ä»¤æ‰§è¡Œè€—æ—¶è¶…è¿‡ 5 æ¯«ç§’ï¼Œè®°å½•æ…¢æ—¥å¿— `CONFIG SET slowlog-log-slower-than 5000`
- åªä¿ç•™æœ€è¿‘ 500 æ¡æ…¢æ—¥å¿— `CONFIG SET slowlog-max-len 500`
- æŸ¥çœ‹æœ€è¿‘5æ¡æ…¢æ—¥å¿— `SLOWLOG get 5`

## big key
bigkey åœ¨å¾ˆå¤šåœºæ™¯ä¸‹éƒ½ä¼šäº§ç”Ÿæ€§èƒ½é—®é¢˜ï¼Œå› æ­¤ä¸šåŠ¡åº”ç”¨å°½é‡é¿å…å†™å…¥ã€‚

ä¾‹å¦‚ï¼Œbigkey åœ¨åˆ†ç‰‡é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå¯¹äºæ•°æ®çš„è¿ç§»ä¹Ÿä¼šæœ‰æ€§èƒ½å½±å“ï¼Œä»¥åŠæˆ‘åé¢å³å°†è®²åˆ°çš„æ•°æ®è¿‡æœŸã€æ•°æ®æ·˜æ±°ã€é€æ˜å¤§é¡µï¼Œéƒ½ä¼šå—åˆ° bigkey çš„å½±å“ã€‚

- `redis-cli --bigkeys`
    - å¯¹çº¿ä¸Šå®ä¾‹è¿›è¡Œ bigkey æ‰«ææ—¶ï¼ŒRedis çš„ OPS ä¼šçªå¢ï¼Œä¸ºäº†é™ä½æ‰«æè¿‡ç¨‹ä¸­å¯¹ Redis çš„å½±å“ï¼Œæœ€å¥½æ§åˆ¶ä¸€ä¸‹æ‰«æçš„é¢‘ç‡ï¼ŒæŒ‡å®š -i å‚æ•°å³å¯ï¼Œå®ƒè¡¨ç¤ºæ‰«æè¿‡ç¨‹ä¸­æ¯æ¬¡æ‰«æåä¼‘æ¯çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’
    - æ‰«æç»“æœä¸­ï¼Œå¯¹äºå®¹å™¨ç±»å‹ï¼ˆListã€Hashã€Setã€ZSetï¼‰çš„ keyï¼Œåªèƒ½æ‰«æå‡ºå…ƒç´ æœ€å¤šçš„ keyã€‚ä½†ä¸€ä¸ª key çš„å…ƒç´ å¤šï¼Œä¸ä¸€å®šè¡¨ç¤ºå ç”¨å†…å­˜ä¹Ÿå¤šï¼Œä½ è¿˜éœ€è¦æ ¹æ®ä¸šåŠ¡æƒ…å†µï¼Œè¿›ä¸€æ­¥è¯„ä¼°å†…å­˜å ç”¨æƒ…å†µ
- `memory usage key` è¿”å›å­—èŠ‚æ•°
- `debug object key`
- `redis-memory-for-key -s localhost -p 6667 key`
    - pip install rdbtools

- å¦‚æœRedis æ˜¯ 4.0 ä»¥ä¸Šç‰ˆæœ¬ï¼Œç”¨ UNLINK å‘½ä»¤æ›¿ä»£ DELï¼Œæ­¤å‘½ä»¤å¯ä»¥æŠŠé‡Šæ”¾ key å†…å­˜çš„æ“ä½œï¼Œæ”¾åˆ°åå°çº¿ç¨‹ä¸­å»æ‰§è¡Œï¼Œä»è€Œé™ä½å¯¹ Redis çš„å½±å“
- å¦‚æœRedis æ˜¯ 6.0 ä»¥ä¸Šç‰ˆæœ¬ï¼Œå¯ä»¥å¼€å¯ lazy-free æœºåˆ¶ï¼ˆlazyfree-lazy-user-del = yesï¼‰ï¼Œåœ¨æ‰§è¡Œ DEL å‘½ä»¤æ—¶ï¼Œé‡Šæ”¾å†…å­˜ä¹Ÿä¼šæ”¾åˆ°åå°çº¿ç¨‹ä¸­æ‰§è¡Œ

## hot key

> [å¤§Key/çƒ­Keyåˆ†æ/è¿‡æœŸKeyæ‰«æ](https://support.huaweicloud.com/dcs_faq/dcs-faq-0805001.html)

************************

## Key eviction
> [Key eviction](https://redis.io/docs/latest/develop/reference/eviction/)  

å½“Redisä½¿ç”¨å†…å­˜è¾¾åˆ° maxmemory æ—¶ä¼šä¾æ®**é©±é€ç­–ç•¥**(LRUï¼ŒLFUç­‰)åˆ é™¤keyï¼Œå›æ”¶å†…å­˜ã€‚

> å‚è€ƒï¼š[Rediså®ä¾‹çš„æ•°æ®é€å‡ºç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ](https://support.huaweicloud.com/dcs_faq/dcs-faq-0427031.html)

************************

# Lua
> [Scripting with Lua](https://redis.io/docs/latest/develop/interact/programmability/eval-intro/)

- EVAL 
    - eval script keyNum key* arg* ï¼š keyNumæ˜¯æŒ‡keyçš„æ•°é‡ keyå’Œ arg éƒ½æ˜¯å¤šå€¼ï¼Œ å¯ä»¥æŠŠevalç†è§£ä¸ºlambdaå‡½æ•°ï¼Œå‡½æ•°æ“ä½œä¼ å…¥çš„keyå’Œå˜é‡
    - æ³¨æ„ç¬¬ä¸€æ¬¡æ‰§è¡Œåå°±ä¼šå°†è„šæœ¬ç¼“å­˜èµ·æ¥ï¼Œåç»­å¯ä»¥æ›¿æ¢ä¸º EVALSHA å‘½ä»¤æ‰§è¡Œäº†
    - å¯ä»¥çœ‹åˆ° spring-redis çš„ DefaultScriptExecutor#eval ä¼˜å…ˆä¼šæ‰§è¡Œevalshaï¼Œç”±è„šæœ¬å†…å®¹è®¡ç®—å‡ºsha1
- SCRIPT LOAD
    - æ³¨æ„ EVALæ‰§è¡Œçš„è„šæœ¬éƒ½ä¼šç¼“å­˜åœ¨Redisçš„ç¼“å­˜ä¸­ é€šè¿‡INFOæŸ¥çœ‹ used_memory_scripts_eval å’Œ number_of_cached_scriptsï¼Œ æ‰€ä»¥åŠ¨æ€æ‹¼æ¥çš„è„šæœ¬æ˜¯ä¸åˆç†çš„ï¼Œåº”è¯¥å°†å˜åŒ–éƒ½å°è£…æˆå‚æ•°
        - æ‰€ä»¥å°†è„šæœ¬å¤ç”¨ä¼šæ›´é«˜æ•ˆï¼ˆå¤ç”¨ç¼“å­˜ï¼Œé™ä½å‘½ä»¤é•¿åº¦ï¼‰ï¼ŒSCRIPT LOAD ä¼šè¿”å›ä¸€ä¸ªSHA1ä¿¡æ¯æ‘˜è¦ å¯ä»¥ç”¨sha1sumå‘½ä»¤éªŒè¯è¿”å›å€¼
    - æ³¨æ„ è¯¥è„šæœ¬ç¼“å­˜**æ˜¯ä¸å¯é çš„**ï¼ŒRedisé‡å¯ï¼ŒClusteræ¨¡å¼,ä¸»ä»åˆ‡æ¢ï¼Œæ•…éšœæ¢å¤ï¼ŒSCRIPT FLUSHå‘½ä»¤çš„æ‰§è¡Œï¼Œéƒ½ä¼šå¯¼è‡´è„šæœ¬ç¼“å­˜ä¸¢å¤±ï¼Œæ‰€ä»¥éœ€è¦åœ¨EVALSHAåšå®¹é”™ï¼Œç¼“å­˜ä¸¢å¤±åé‡æ–°LOAD
        - æ‰€ä»¥é€šç”¨çš„æ–¹æ¡ˆæ˜¯ æ­£å¸¸æ‰§è¡Œ EVALSHA å¦‚æœæŠ¥é”™äº†å°±å†Loadä¸€æ¬¡ï¼Œå†æ‰§è¡Œ EVALSHA
- EVALSHA
    - ä¸EVALç”¨æ³•ä¸€è‡´ï¼Œä½†æ˜¯è„šæœ¬å‚æ•°æ›¿æ¢ä¸ºäº† LOAD è¿”å›çš„ sha1
- SCRIPT FLUSH
- SCRIPT EXISTS SHA1 1å­˜åœ¨ 0ä¸å­˜åœ¨
- SCRIPT KILL åœæ­¢é•¿æ—¶é—´è¿è¡Œçš„è„šæœ¬
- SCRIPT DEBUG 

> æ³¨æ„

- Luaè„šæœ¬åœ¨Redisæ‰§è¡Œæ—¶æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥å¯ç”¨æ¥åšåˆ†å¸ƒå¼é”ç­‰å¼ºä¸€è‡´æ€§åœºæ™¯ [Why locks in Lua?](https://redis.io/ebook/part-3-next-steps/chapter-11-scripting-redis-with-lua/11-2-rewriting-locks-and-semaphores-with-lua/11-2-1-why-locks-in-lua/)
- [Redis functions](https://redis.io/docs/latest/develop/interact/programmability/functions-intro/) ä»Redis7å¼€å§‹æ”¯æŒé€šè¿‡Luaæ‰©å±•å‡ºè‡ªå®šä¹‰å‡½æ•° FCALL æ–¹å¼è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°
- å½“Redisæ˜¯Clusteræ¨¡å¼éƒ¨ç½²æ—¶ï¼Œluaè„šæœ¬æ“ä½œçš„æ‰€æœ‰keyéœ€è¦ä¿è¯åœ¨åŒä¸€ä¸ªslotä¸­ã€‚`CROSSSLOT Keys in request donâ€™t hash to the same slot`
    - [Redis Pipelineä¸­è°ƒç”¨Luaè„šæœ¬æŠ¥é”™JedisMoveDataExceptionçš„é—®é¢˜](https://blog.csdn.net/minghao0508/article/details/130827658)

## FUNCTION
> [Redis functions | Docs](https://redis.io/docs/latest/develop/interact/programmability/functions-intro/)`Redis7å¼€å§‹ä½¿ç”¨FUNCTIONç³»åˆ—å‘½ä»¤`  


## åº”ç”¨

> é™åˆ¶æ•°é‡çš„ä»¤ç‰Œæ¡¶é™æµæœºåˆ¶ Javaå®ç°
```java
    public static final String JUDGE_SCRIPT = "local cnt = redis.call('incr', KEYS[1]);" +
            "  if (tonumber(cnt) > tonumber(ARGV[1]) ) then redis.call('decr', KEYS[1]); return 0;" +
            " else return 1; end";

    public void acquireBlock(String key, int maxConcurrency) {
        while (!this.acquire(key, maxConcurrency)) {
            try {
                TimeUnit.MILLISECONDS.sleep(500);
            } catch (Exception e) {
                log.error("", e);
            }
        }
    }

    public int runCount(String key) {
        Object val = redisTemplate.opsForValue().get(key);
        if (Objects.isNull(val)) {
            return 0;
        }
        return Integer.parseInt(val.toString());
    }

    public boolean acquire(String key, int maxConcurrency) {
        // æŒ‡å®š lua è„šæœ¬ï¼Œå¹¶ä¸”æŒ‡å®šè¿”å›å€¼ç±»å‹
        DefaultRedisScript<Integer> redisScript = new DefaultRedisScript<>(JUDGE_SCRIPT, Integer.class);
        // å‚æ•°ä¸€ï¼šredisScriptï¼Œå‚æ•°äºŒï¼škeyåˆ—è¡¨ï¼Œå‚æ•°ä¸‰ï¼šargï¼ˆå¯å¤šä¸ªï¼‰
        Object lockB = redisTemplate.execute(redisScript, Collections.singletonList(key), maxConcurrency);
        if (Objects.isNull(lockB)) {
            return false;
        }
        return Integer.parseInt(lockB.toString()) > 0;
    }

    public Long release(String key) {
        return redisTemplate.opsForValue().decrement(key);
    }
```

************************

# Tip
## ç¦ç”¨ O(N) å‘½ä»¤
keys flushdb flushall
 
- Listï¼š lindexã€lsetã€linsert
- Hashï¼š hgetallã€hkeysã€hvals
- Setï¼š smembersã€sunionã€sunionstoreã€sinterã€sinterstoreã€sdiffã€sdiffstore
- Sorted Setï¼š zrangeã€zrevrangeã€zrangebyscoreã€zrevrangebyscoreã€zremrangebyrankã€zremrangebyscore

åœ¨ redis.conf ä¸­é€šè¿‡é…ç½® rename-command è¿›è¡Œç¦ç”¨

## é”™è¯¯åˆ†æ

1. `JedisConnectionException:  Could not get a resource from the pool` cause by `java.util.NoSuchElementException: Unable to validate object`
    - å¤šç§åŸå› , ç”±äºè®¾ç½®äº† testOnBorrow ä¸º true, é‚£ä¹ˆåœ¨æ¯æ¬¡è·å–æ•°æ®æ—¶, å°±ä¼šå…ˆæµ‹è¯•æ€§çš„è·å–ä¸€ä¸ªæ•°æ®, ç„¶åæ ¡éªŒèƒ½å¦æ­£å¸¸æ‹¿åˆ°è¯¥æ•°æ® å¦‚æœæ‹¿ä¸åˆ°å°±æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸, åŸå› å¯èƒ½æœ‰:
        1. æ ¹æœ¬æ²¡æœ‰è¿æ¥ä¸ŠRedis, é…ç½®æœ‰é—®é¢˜ ç«¯å£ bind ä»€ä¹ˆçš„
        1. Redis å­˜æ”¾æ•°æ®çš„ rdb æ–‡ä»¶æ‰€åœ¨ç›®å½• æ²¡æœ‰å­˜å‚¨ç©ºé—´äº†
        1. æ²¡æœ‰å†…å­˜ç©ºé—´äº†, ç”±äºæ‰§è¡Œsaveæ“ä½œæ—¶, ä¼šè¿›è¡Œforkå­è¿›ç¨‹ ç„¶åè¿›è¡ŒæŒä¹…åŒ– TODO éªŒè¯
1. `ERR 'EVAL' command keys must in same slot`
    - ç”±äºLuaè„šæœ¬æ‰§è¡Œåœ¨Clusteræ¨¡å¼ä¸‹éœ€è¦ä¿è¯æ“ä½œçš„keyåœ¨ç›¸åŒçš„slotä¸­ã€‚
    - è§£å†³æ–¹æ¡ˆ å¼ºåˆ¶åŠ å…¥èŠ±æ‹¬å· æŒ‡å®šè®¡ç®—slotçš„éƒ¨åˆ†ï¼Œä¿è¯keyä¼šåˆ†é…åˆ°ç›¸åŒçš„slotã€‚ä¾‹å¦‚ï¼š`{prefix}a` å’Œ `{prefix}b`

************************

# éƒ¨ç½²æ–¹å¼
> [å‚è€ƒ: rediså“¨å…µã€é›†ç¾¤](https://blog.csdn.net/u012129558/article/details/77146287)  

## Run Configuration	
- *slaveof*
    - `redis-server --port 9999 --slaveof 127.0.0.1 6379` å¯åŠ¨ä¸€ä¸ª9999ç«¯å£ä½œä¸º6379çš„ä»æœåŠ¡å™¨è¿›è¡ŒåŒæ­¥
    - æˆ–è€…æœåŠ¡å¯åŠ¨åæ‰§è¡Œ `slaveof host port`ï¼ˆå¦‚æœå·²ç»æ˜¯ä»æœåŠ¡å™¨ï¼Œå°±ä¸¢å»æ—§æœåŠ¡å™¨çš„æ•°æ®é›†ï¼Œè½¬è€Œå¯¹æ–°çš„ä¸»æœåŠ¡å™¨è¿›è¡ŒåŒæ­¥ï¼‰
    - ä»æœåŠ¡å˜æˆä¸»æœåŠ¡ `slaveof no one` (åŒæ­¥çš„æ•°æ®é›†ä¸ä¼šä¸¢å¤±ï¼Œè¿…é€Ÿæ›¿æ¢ä¸»æœåŠ¡å™¨)

- *loglevel*
    - `./redis-server /etc/redis/6379.conf --loglevel debug	`


## å•æœº
- ä¼˜ç‚¹ï¼š
    1. æ¶æ„ç®€å•ï¼Œéƒ¨ç½²æ–¹ä¾¿ï¼›
    1. é«˜æ€§ä»·æ¯”ï¼šç¼“å­˜ä½¿ç”¨æ—¶æ— éœ€å¤‡ç”¨èŠ‚ç‚¹ï¼ˆå•å®ä¾‹å¯ç”¨æ€§å¯ä»¥ç”¨supervisoræˆ–crontabä¿è¯ï¼‰ï¼Œå½“ç„¶ä¸ºäº†æ»¡è¶³ä¸šåŠ¡çš„é«˜å¯ç”¨æ€§ï¼Œä¹Ÿå¯ä»¥ç‰ºç‰²ä¸€ä¸ªå¤‡ç”¨èŠ‚ç‚¹ï¼Œä½†åŒæ—¶åˆ»åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹å¤–æä¾›æœåŠ¡ï¼›
    1. é«˜æ€§èƒ½ï¼Œå•çº¿ç¨‹å¤šè·¯å¤ç”¨ã€‚

- ç¼ºç‚¹ï¼š
    1. ä¸ä¿è¯æ•°æ®çš„å¯é æ€§ï¼›
    1. åœ¨ç¼“å­˜ä½¿ç”¨ï¼Œè¿›ç¨‹é‡å¯åï¼Œæ•°æ®ä¸¢å¤±ï¼Œå³ä½¿æœ‰å¤‡ç”¨çš„èŠ‚ç‚¹è§£å†³é«˜å¯ç”¨æ€§ï¼Œä½†æ˜¯ä»ç„¶ä¸èƒ½è§£å†³ç¼“å­˜é¢„çƒ­é—®é¢˜ï¼Œå› æ­¤ä¸é€‚ç”¨äºæ•°æ®å¯é æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡ï¼›
    1. é«˜æ€§èƒ½å—é™äºå•æ ¸CPUçš„å¤„ç†èƒ½åŠ›ï¼ˆRedisæ˜¯å•çº¿ç¨‹æœºåˆ¶ï¼‰ï¼ŒCPUä¸ºä¸»è¦ç“¶é¢ˆï¼Œæ‰€ä»¥é€‚åˆæ“ä½œå‘½ä»¤ç®€å•ï¼Œæ’åºã€è®¡ç®—è¾ƒå°‘çš„åœºæ™¯ã€‚ä¹Ÿå¯ä»¥è€ƒè™‘ç”¨Memcachedæ›¿ä»£ã€‚

## ä¸»ä»
Rediså¤šå‰¯æœ¬ï¼Œé‡‡ç”¨ä¸»ä»ï¼ˆreplicationï¼‰éƒ¨ç½²ç»“æ„ï¼Œç›¸è¾ƒäºå•å‰¯æœ¬è€Œè¨€æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ä¸»ä»å®ä¾‹é—´æ•°æ®å®æ—¶åŒæ­¥ï¼Œå¹¶ä¸”æä¾›æ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½ç­–ç•¥ã€‚
ä¸»ä»å®ä¾‹éƒ¨ç½²åœ¨ä¸åŒçš„ç‰©ç†æœåŠ¡å™¨ä¸Šï¼Œæ ¹æ®å…¬å¸çš„åŸºç¡€ç¯å¢ƒé…ç½®ï¼Œå¯ä»¥å®ç°åŒæ—¶å¯¹å¤–æä¾›æœåŠ¡å’Œè¯»å†™åˆ†ç¦»ç­–ç•¥ã€‚

- ä¼˜ç‚¹ï¼š
    1. é«˜å¯é æ€§ï¼šä¸€æ–¹é¢ï¼Œé‡‡ç”¨åŒæœºä¸»å¤‡æ¶æ„ï¼Œèƒ½å¤Ÿåœ¨ä¸»åº“å‡ºç°æ•…éšœæ—¶è‡ªåŠ¨è¿›è¡Œä¸»å¤‡åˆ‡æ¢ï¼Œä»åº“æå‡ä¸ºä¸»åº“æä¾›æœåŠ¡ï¼Œä¿è¯æœåŠ¡å¹³ç¨³è¿è¡Œï¼›å¦ä¸€æ–¹é¢ï¼Œå¼€å¯æ•°æ®æŒä¹…åŒ–åŠŸèƒ½å’Œé…ç½®åˆç†çš„å¤‡ä»½ç­–ç•¥ï¼Œèƒ½æœ‰æ•ˆçš„è§£å†³æ•°æ®è¯¯æ“ä½œå’Œæ•°æ®å¼‚å¸¸ä¸¢å¤±çš„é—®é¢˜ï¼›
    1. è¯»å†™åˆ†ç¦»ç­–ç•¥ï¼šä»èŠ‚ç‚¹å¯ä»¥æ‰©å±•ä¸»åº“èŠ‚ç‚¹çš„è¯»èƒ½åŠ›ï¼Œæœ‰æ•ˆåº”å¯¹å¤§å¹¶å‘é‡çš„è¯»æ“ä½œã€‚

- ç¼ºç‚¹ï¼š
    1. æ•…éšœæ¢å¤å¤æ‚ï¼Œå¦‚æœæ²¡æœ‰ Redis HA ç³»ç»Ÿï¼ˆéœ€è¦å¼€å‘ï¼‰ï¼Œå½“ä¸»åº“èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨å°†ä¸€ä¸ªä»èŠ‚ç‚¹æ™‹å‡ä¸ºä¸»èŠ‚ç‚¹ï¼ŒåŒæ—¶éœ€è¦é€šçŸ¥ä¸šåŠ¡æ–¹å˜æ›´é…ç½®ï¼Œå¹¶ä¸”éœ€è¦è®©å…¶å®ƒä»åº“èŠ‚ç‚¹å»å¤åˆ¶æ–°ä¸»åº“èŠ‚ç‚¹ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦äººä¸ºå¹²é¢„ï¼Œæ¯”è¾ƒç¹çï¼›
    1. ä¸»åº“çš„å†™èƒ½åŠ›å—åˆ°å•æœºçš„é™åˆ¶ï¼Œå¯ä»¥è€ƒè™‘åˆ†ç‰‡ï¼›
    1. ä¸»åº“çš„å­˜å‚¨èƒ½åŠ›å—åˆ°å•æœºçš„é™åˆ¶ï¼Œå¯ä»¥è€ƒè™‘Pikaï¼›
    1. åŸç”Ÿå¤åˆ¶çš„å¼Šç«¯åœ¨æ—©æœŸçš„ç‰ˆæœ¬ä¸­ä¹Ÿä¼šæ¯”è¾ƒçªå‡º
        - å¦‚ï¼šRediså¤åˆ¶ä¸­æ–­åï¼ŒSlaveä¼šå‘èµ·psyncï¼Œæ­¤æ—¶å¦‚æœåŒæ­¥ä¸æˆåŠŸï¼Œåˆ™ä¼šè¿›è¡Œå…¨é‡åŒæ­¥ï¼Œä¸»åº“æ‰§è¡Œå…¨é‡å¤‡ä»½çš„åŒæ—¶å¯èƒ½ä¼šé€ æˆæ¯«ç§’æˆ–ç§’çº§çš„å¡é¡¿ï¼›
        - åˆç”±äºCOWæœºåˆ¶ï¼Œå¯¼è‡´æç«¯æƒ…å†µä¸‹çš„ä¸»åº“å†…å­˜æº¢å‡ºï¼Œç¨‹åºå¼‚å¸¸é€€å‡ºæˆ–å®•æœºï¼›ä¸»åº“èŠ‚ç‚¹ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å¯¼è‡´æœåŠ¡å™¨ç£ç›˜IOå’ŒCPUï¼ˆå‹ç¼©ï¼‰èµ„æºæ¶ˆè€—ï¼›å‘é€æ•°GBå¤§å°çš„å¤‡ä»½æ–‡ä»¶å¯¼è‡´æœåŠ¡å™¨å‡ºå£å¸¦å®½æš´å¢ï¼Œé˜»å¡è¯·æ±‚ï¼Œå»ºè®®å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚

************************

## å“¨å…µ
 
Redis Sentinelæ˜¯ç¤¾åŒºç‰ˆæœ¬æ¨å‡ºçš„åŸç”Ÿé«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼Œå…¶éƒ¨ç½²æ¶æ„ä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šRedis Sentinelé›†ç¾¤å’ŒRedisæ•°æ®é›†ç¾¤ã€‚  
å…¶ä¸­Redis Sentinelé›†ç¾¤æ˜¯ç”±è‹¥å¹²SentinelèŠ‚ç‚¹ç»„æˆçš„åˆ†å¸ƒå¼é›†ç¾¤ï¼Œå¯ä»¥å®ç°æ•…éšœå‘ç°ã€æ•…éšœè‡ªåŠ¨è½¬ç§»ã€é…ç½®ä¸­å¿ƒå’Œå®¢æˆ·ç«¯é€šçŸ¥ã€‚  
Redis Sentinelçš„èŠ‚ç‚¹æ•°é‡ æ¨è 2n+1ï¼ˆn>=1ï¼‰çš„å¥‡æ•°ä¸ªã€‚[ä¸ºä»€ä¹ˆredisæ¨èå¥‡æ•°ä¸ªèŠ‚ç‚¹](https://blog.csdn.net/qq32933432/article/details/105785571) å…¶ä¸»è¦åŸå› è¿˜æ˜¯ä»æˆæœ¬ä¸Šè€ƒè™‘çš„ï¼Œå› ä¸ºå¥‡æ•°ä¸ªèŠ‚ç‚¹å’Œå¶æ•°ä¸ªèŠ‚ç‚¹å…è®¸å®•æœºçš„èŠ‚ç‚¹æ•°æ˜¯ä¸€æ ·çš„

- ä¼˜ç‚¹ï¼š
    1. Redis Sentinel é›†ç¾¤éƒ¨ç½²ç®€å•ï¼›
    1. èƒ½å¤Ÿè§£å†³Redisä¸»ä»æ¨¡å¼ä¸‹çš„é«˜å¯ç”¨åˆ‡æ¢é—®é¢˜ï¼›
    1. å¾ˆæ–¹ä¾¿å®ç°Redisæ•°æ®èŠ‚ç‚¹çš„çº¿å½¢æ‰©å±•ï¼Œè½»æ¾çªç ´Redisè‡ªèº«å•çº¿ç¨‹ç“¶é¢ˆï¼Œå¯æå¤§æ»¡è¶³Rediså¤§å®¹é‡æˆ–é«˜æ€§èƒ½çš„ä¸šåŠ¡éœ€æ±‚ï¼›
    1. å¯ä»¥å®ç°ä¸€å¥—Sentinelç›‘æ§ä¸€ç»„Redisæ•°æ®èŠ‚ç‚¹æˆ–å¤šç»„æ•°æ®èŠ‚ç‚¹ã€‚

- ç¼ºç‚¹ï¼š
    1. éƒ¨ç½²ç›¸å¯¹Redisä¸»ä»æ¨¡å¼è¦å¤æ‚ä¸€äº›ï¼ŒåŸç†ç†è§£æ›´ç¹çï¼›
    1. èµ„æºæµªè´¹ï¼ŒRedisæ•°æ®èŠ‚ç‚¹ä¸­slaveèŠ‚ç‚¹ä½œä¸ºå¤‡ä»½èŠ‚ç‚¹ä¸æä¾›æœåŠ¡ï¼›
    1. Redis Sentinelä¸»è¦æ˜¯é’ˆå¯¹Redisæ•°æ®èŠ‚ç‚¹ä¸­çš„ä¸»èŠ‚ç‚¹çš„é«˜å¯ç”¨åˆ‡æ¢ï¼Œå¯¹Redisçš„æ•°æ®èŠ‚ç‚¹åšå¤±è´¥åˆ¤å®šåˆ†ä¸ºä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿ä¸¤ç§ï¼Œå¯¹äºRedisçš„ä»èŠ‚ç‚¹æœ‰å¯¹èŠ‚ç‚¹åšä¸»è§‚ä¸‹çº¿æ“ä½œï¼Œå¹¶ä¸æ‰§è¡Œæ•…éšœè½¬ç§»ã€‚
    1. ä¸èƒ½è§£å†³è¯»å†™åˆ†ç¦»é—®é¢˜ï¼Œå®ç°èµ·æ¥ç›¸å¯¹å¤æ‚ã€‚

- æ³¨æ„
    1. éƒ¨ç½²çš„å„ä¸ªèŠ‚ç‚¹æœåŠ¡å™¨æ—¶é—´å°½é‡è¦åŒæ­¥ï¼Œå¦åˆ™æ—¥å¿—çš„æ—¶åºæ€§ä¼šæ··ä¹±ã€‚
    1. Rediså»ºè®®ä½¿ç”¨pipelineå’Œmulti-keysæ“ä½œï¼Œå‡å°‘RTTæ¬¡æ•°ï¼Œæé«˜è¯·æ±‚æ•ˆç‡ã€‚
    1. è‡ªè¡Œæå®šé…ç½®ä¸­å¿ƒï¼ˆzookeeperï¼‰ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯å¯¹å®ä¾‹çš„é“¾æ¥è®¿é—®ã€‚

************************

## Cluster é›†ç¾¤
> [cluster-tutorial](https://redis.io/docs/manual/scaling/) | [docker-compose éƒ¨ç½²](https://gitee.com/gin9/DockerfileList/tree/master/docker-compose/redis-cluster/third-nodes)

Redis Clusteræ˜¯ç¤¾åŒºç‰ˆæ¨å‡ºçš„Redisåˆ†å¸ƒå¼é›†ç¾¤è§£å†³æ–¹æ¡ˆï¼Œä¸»è¦è§£å†³Redisåˆ†å¸ƒå¼æ–¹é¢çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼Œå½“é‡åˆ°å•æœºå†…å­˜ï¼Œå¹¶å‘å’Œæµé‡ç­‰ç“¶é¢ˆçš„æ—¶å€™ï¼ŒRedis Clusterèƒ½èµ·åˆ°å¾ˆå¥½çš„è´Ÿè½½å‡è¡¡çš„ç›®çš„ã€‚  
Redis Clusteré›†ç¾¤èŠ‚ç‚¹æœ€å°é…ç½®6ä¸ªèŠ‚ç‚¹ä»¥ä¸Šï¼ˆ3ä¸»3ä»ï¼‰ï¼Œå…¶ä¸­ä¸»èŠ‚ç‚¹æä¾›è¯»å†™æ“ä½œï¼Œä»èŠ‚ç‚¹ä½œä¸ºå¤‡ç”¨èŠ‚ç‚¹ï¼Œä¸æä¾›è¯·æ±‚ï¼Œåªä½œä¸ºæ•…éšœè½¬ç§»ä½¿ç”¨ã€‚  
Redis Clusteré‡‡ç”¨è™šæ‹Ÿæ§½åˆ†åŒºï¼Œæ‰€æœ‰çš„é”®æ ¹æ®å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°0ï½16383ä¸ªæ•´æ•°æ§½å†…ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤ä¸€éƒ¨åˆ†æ§½ä»¥åŠæ§½æ‰€å°æ˜ å°„çš„é”®å€¼æ•°æ®ã€‚  


- ä¼˜ç‚¹ï¼š
    1. æ— ä¸­å¿ƒæ¶æ„ï¼›
    1. æ•°æ®æŒ‰ç…§slotå­˜å‚¨åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹é—´æ•°æ®å…±äº«ï¼Œå¯åŠ¨æ€è°ƒæ•´æ•°æ®åˆ†å¸ƒï¼›
    1. å¯æ‰©å±•æ€§ï¼šå¯çº¿æ€§æ‰©å±•åˆ°1000å¤šä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹å¯åŠ¨æ€æ·»åŠ æˆ–åˆ é™¤ï¼›
    1. é«˜å¯ç”¨æ€§ï¼šéƒ¨åˆ†èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œé›†ç¾¤ä»å¯ç”¨ã€‚é€šè¿‡å¢åŠ Slaveåšstandbyæ•°æ®å‰¯æœ¬ï¼Œèƒ½å¤Ÿå®ç°æ•…éšœè‡ªåŠ¨failoverï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šè¿‡**gossip**åè®®äº¤æ¢çŠ¶æ€ä¿¡æ¯ï¼Œç”¨æŠ•ç¥¨æœºåˆ¶å®ŒæˆSlaveåˆ°Masterçš„è§’è‰²æå‡ï¼›
    1. é™ä½è¿ç»´æˆæœ¬ï¼Œæé«˜ç³»ç»Ÿçš„æ‰©å±•æ€§å’Œå¯ç”¨æ€§ã€‚

- ç¼ºç‚¹ï¼š
    1. Clientå®ç°å¤æ‚ï¼Œé©±åŠ¨è¦æ±‚å®ç°Smart Clientï¼Œéœ€ç¼“å­˜slots mappingä¿¡æ¯å¹¶åŠæ—¶æ›´æ–°ï¼Œæé«˜äº†å¼€å‘éš¾åº¦ï¼Œå®¢æˆ·ç«¯çš„ä¸æˆç†Ÿå½±å“äº†ä¸šåŠ¡çš„ç¨³å®šæ€§ã€‚
    1. èŠ‚ç‚¹ä¼šå› ä¸ºæŸäº›åŸå› å‘ç”Ÿé˜»å¡ï¼ˆé˜»å¡æ—¶é—´å¤§äºclutser-node-timeoutï¼‰ï¼Œè¢«åˆ¤æ–­ä¸‹çº¿ï¼Œè¿™ç§failoveræ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚
    1. æ•°æ®é€šè¿‡å¼‚æ­¥å¤åˆ¶ï¼Œä¸ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚
    1. å¤šä¸ªä¸šåŠ¡ä½¿ç”¨åŒä¸€å¥—é›†ç¾¤æ—¶ï¼Œæ— æ³•æ ¹æ®ç»Ÿè®¡åŒºåˆ†å†·çƒ­æ•°æ®ï¼Œèµ„æºéš”ç¦»æ€§è¾ƒå·®ï¼Œå®¹æ˜“å‡ºç°ç›¸äº’å½±å“çš„æƒ…å†µã€‚
    1. Slaveåœ¨é›†ç¾¤ä¸­å……å½“â€œå†·å¤‡â€ï¼Œä¸èƒ½ç¼“è§£è¯»å‹åŠ›ï¼Œå½“ç„¶å¯ä»¥é€šè¿‡SDKçš„åˆç†è®¾è®¡æ¥æé«˜Slaveèµ„æºçš„åˆ©ç”¨ç‡ã€‚
    1. Keyæ‰¹é‡æ“ä½œé™åˆ¶ï¼Œå¦‚ä½¿ç”¨msetã€mgetç›®å‰åªæ”¯æŒå…·æœ‰ç›¸åŒslotå€¼çš„Keyæ‰§è¡Œæ‰¹é‡æ“ä½œã€‚å¯¹äºæ˜ å°„ä¸ºä¸åŒslotå€¼çš„Keyç”±äºKeys**ä¸æ”¯æŒè·¨slot**æŸ¥è¯¢ï¼Œæ‰€ä»¥æ‰§è¡Œmsetã€mgetã€sunionç­‰æ“ä½œæ”¯æŒä¸å‹å¥½ã€‚
    1. Keyäº‹åŠ¡æ“ä½œæ”¯æŒæœ‰é™ï¼Œåªæ”¯æŒå¤škeyåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šçš„äº‹åŠ¡æ“ä½œï¼Œå½“å¤šä¸ªKeyåˆ†å¸ƒäºä¸åŒçš„èŠ‚ç‚¹ä¸Šæ—¶æ— æ³•ä½¿ç”¨äº‹åŠ¡åŠŸèƒ½ã€‚
    1. Keyä½œä¸ºæ•°æ®åˆ†åŒºçš„æœ€å°ç²’åº¦ï¼Œä¸èƒ½å°†ä¸€ä¸ªå¾ˆå¤§çš„é”®å€¼å¯¹è±¡å¦‚hashã€listç­‰æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚
    1. ä¸æ”¯æŒå¤šæ•°æ®åº“ç©ºé—´ï¼Œå•æœºä¸‹çš„rediså¯ä»¥æ”¯æŒåˆ°16ä¸ªæ•°æ®åº“ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹åªèƒ½ä½¿ç”¨1ä¸ªæ•°æ®åº“ç©ºé—´ï¼Œå³db 0ã€‚
    1. å¤åˆ¶ç»“æ„åªæ”¯æŒä¸€å±‚ï¼Œä»èŠ‚ç‚¹åªèƒ½å¤åˆ¶ä¸»èŠ‚ç‚¹ï¼Œä¸æ”¯æŒåµŒå¥—æ ‘çŠ¶å¤åˆ¶ç»“æ„ã€‚
    1. é¿å…äº§ç”Ÿhot-keyï¼Œå¯¼è‡´ä¸»åº“èŠ‚ç‚¹æˆä¸ºç³»ç»Ÿçš„çŸ­æ¿ã€‚
    1. é¿å…äº§ç”Ÿbig-keyï¼Œå¯¼è‡´ç½‘å¡æ’‘çˆ†ã€æ…¢æŸ¥è¯¢ç­‰ã€‚
    1. é‡è¯•æ—¶é—´åº”è¯¥å¤§äºcluster-node-timeæ—¶é—´ã€‚
    1. Redis Clusterä¸å»ºè®®ä½¿ç”¨pipelineå’Œmulti-keysæ“ä½œï¼Œå‡å°‘max redirectäº§ç”Ÿçš„åœºæ™¯ã€‚

> ä¸šåŠ¡ä½¿ç”¨æ—¶æ³¨æ„äº‹é¡¹ï¼š æ“ä½œå¤škeyæ—¶ï¼Œéœ€è¦ä¿è¯å¤šä¸ªkeyè¦åœ¨ä¸€ä¸ªslotå†…ï¼ˆä¾‹å¦‚Luaè„šæœ¬å®ç°çš„ä¸€äº›å¤æ‚æ“ä½œï¼‰

cluster å‘½ä»¤ä½¿ç”¨ï¼š
- æŸ¥çœ‹keyçš„slot `cluster keyslot key`
- æŸ¥çœ‹slotå’ŒNodeå…³ç³» `cluster slots`

cluster info 
cluster nodes

Redis7.0+ è‡ªåŠ¨æ£€æµ‹ã€Œæ§½ä½åå·® > thresholdã€â†’ è‡ªåŠ¨ rebalance

************************

# Redis æŒä¹…åŒ–
[Redis persistence](https://redis.io/docs/management/persistence/)

ç”±äºRedisçš„æ•°æ®éƒ½å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœæ²¡æœ‰é…ç½®æŒä¹…åŒ–ï¼Œredisé‡å¯åæ•°æ®å°±å…¨ä¸¢å¤±äº†ï¼Œäºæ˜¯éœ€è¦å¼€å¯redisçš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œå°†æ•°æ®ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼Œå½“redisé‡å¯åï¼Œå¯ä»¥ä»ç£ç›˜ä¸­æ¢å¤æ•°æ®ã€‚
Redisæä¾›ä¸¤ç§æ–¹å¼è¿›è¡ŒæŒä¹…åŒ–
1. RDBï¼ˆåŸç†æ˜¯å°†Reidsåœ¨å†…å­˜ä¸­çš„æ•°æ®åº“è®°å½•å®šæ—¶dumpåˆ°ç£ç›˜ä¸Šçš„RDBæŒä¹…åŒ–ï¼‰
    - RDBæ˜¯æŒ‡åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…å°†å†…å­˜ä¸­çš„æ•°æ®é›†å¿«ç…§å†™å…¥ç£ç›˜ï¼Œå®é™…æ“ä½œè¿‡ç¨‹æ˜¯forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œå…ˆå°†æ•°æ®é›†å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œå†™å…¥æˆåŠŸåï¼Œå†æ›¿æ¢ä¹‹å‰çš„æ–‡ä»¶ï¼Œç”¨äºŒè¿›åˆ¶å‹ç¼©å­˜å‚¨ã€‚
1. AOFï¼ˆappend only fileï¼‰æŒä¹…åŒ–ï¼ˆåŸç†æ˜¯å°†Reidsçš„æ“ä½œæ—¥å¿—ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥æ–‡ä»¶ ç±»ä¼¼äº MySQL binlogï¼‰
    - AOFæŒä¹…åŒ–ä»¥æ—¥å¿—çš„å½¢å¼è®°å½•æœåŠ¡å™¨æ‰€å¤„ç†çš„æ¯ä¸€ä¸ªå†™ã€åˆ é™¤æ“ä½œï¼ŒæŸ¥è¯¢æ“ä½œä¸ä¼šè®°å½•ï¼Œä»¥æ–‡æœ¬çš„æ–¹å¼è®°å½•ï¼Œå¯ä»¥æ‰“å¼€æ–‡ä»¶çœ‹åˆ°è¯¦ç»†çš„æ“ä½œè®°å½•ã€‚
    - 

![](img/redis-store-rule.drawio.svg)

- RDBçš„ä¼˜åŠ¿
    1. ä¸€æ—¦é‡‡ç”¨è¯¥æ–¹å¼ï¼Œé‚£ä¹ˆä½ çš„æ•´ä¸ªRedisæ•°æ®åº“å°†åªåŒ…å«ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™å¯¹äºæ–‡ä»¶å¤‡ä»½è€Œè¨€æ˜¯éå¸¸å®Œç¾çš„ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½æ‰“ç®—æ¯ä¸ªå°æ—¶å½’æ¡£ä¸€æ¬¡æœ€è¿‘24å°æ—¶çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜è¦æ¯å¤©å½’æ¡£ä¸€æ¬¡æœ€è¿‘30å¤©çš„æ•°æ®ã€‚é€šè¿‡è¿™æ ·çš„å¤‡ä»½ç­–ç•¥ï¼Œä¸€æ—¦ç³»ç»Ÿå‡ºç°ç¾éš¾æ€§æ•…éšœï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸å®¹æ˜“çš„è¿›è¡Œæ¢å¤ã€‚
    1. å¯¹äºç¾éš¾æ¢å¤è€Œè¨€ï¼ŒRDBæ˜¯éå¸¸ä¸é”™çš„é€‰æ‹©ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥éå¸¸è½»æ¾çš„å°†ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å‹ç¼©åå†è½¬ç§»åˆ°å…¶å®ƒå­˜å‚¨ä»‹è´¨ä¸Šã€‚
    1. æ€§èƒ½æœ€å¤§åŒ–ã€‚å¯¹äºRedisçš„æœåŠ¡è¿›ç¨‹è€Œè¨€ï¼Œåœ¨å¼€å§‹æŒä¹…åŒ–æ—¶ï¼Œå®ƒå”¯ä¸€éœ€è¦åšçš„åªæ˜¯forkå‡ºå­è¿›ç¨‹ï¼Œä¹‹åå†ç”±å­è¿›ç¨‹å®Œæˆè¿™äº›æŒä¹…åŒ–çš„å·¥ä½œï¼Œè¿™æ ·å°±å¯ä»¥æå¤§çš„é¿å…æœåŠ¡è¿›ç¨‹æ‰§è¡ŒIOæ“ä½œäº†ã€‚
    1. ç›¸æ¯”äºAOFæœºåˆ¶ï¼Œå¦‚æœæ•°æ®é›†å¾ˆå¤§ï¼ŒRDBçš„å¯åŠ¨æ•ˆç‡ä¼šæ›´é«˜ã€‚

- RDBçš„åŠ£åŠ¿
    1. å¦‚æœä½ æƒ³ä¿è¯æ•°æ®çš„é«˜å¯ç”¨æ€§ï¼Œå³æœ€å¤§é™åº¦çš„é¿å…æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆRDBå°†ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚å› ä¸ºç³»ç»Ÿä¸€æ—¦åœ¨å®šæ—¶æŒä¹…åŒ–ä¹‹å‰å‡ºç°å®•æœºç°è±¡ï¼Œæ­¤å‰æ²¡æœ‰æ¥å¾—åŠå†™å…¥ç£ç›˜çš„æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚
    1. ç”±äºRDBæ˜¯é€šè¿‡forkå­è¿›ç¨‹æ¥ååŠ©å®Œæˆæ•°æ®æŒä¹…åŒ–å·¥ä½œçš„ï¼Œå› æ­¤ï¼Œå¦‚æœå½“æ•°æ®é›†è¾ƒå¤§æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡å™¨åœæ­¢æœåŠ¡å‡ ç™¾æ¯«ç§’ï¼Œç”šè‡³æ˜¯1ç§’é’Ÿã€‚

- AOFçš„ä¼˜åŠ¿
    1. è¯¥æœºåˆ¶å¯ä»¥å¸¦æ¥æ›´é«˜çš„æ•°æ®å®‰å…¨æ€§ï¼Œå³æ•°æ®æŒä¹…æ€§ã€‚Redisä¸­æä¾›äº†3ä¸­åŒæ­¥ç­–ç•¥ï¼Œå³æ¯ç§’åŒæ­¥ã€æ¯ä¿®æ”¹åŒæ­¥å’Œä¸åŒæ­¥ã€‚
        - äº‹å®ä¸Šï¼Œæ¯ç§’åŒæ­¥ä¹Ÿæ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œå…¶æ•ˆç‡ä¹Ÿæ˜¯éå¸¸é«˜çš„ï¼Œæ‰€å·®çš„æ˜¯ä¸€æ—¦ç³»ç»Ÿå‡ºç°å®•æœºç°è±¡ï¼Œé‚£ä¹ˆè¿™ä¸€ç§’é’Ÿä¹‹å†…ä¿®æ”¹çš„æ•°æ®å°†ä¼šä¸¢å¤±ã€‚
        - è€Œæ¯ä¿®æ”¹åŒæ­¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è§†ä¸ºåŒæ­¥æŒä¹…åŒ–ï¼Œå³æ¯æ¬¡å‘ç”Ÿçš„æ•°æ®å˜åŒ–éƒ½ä¼šè¢«ç«‹å³è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å¯ä»¥é¢„è§ï¼Œè¿™ç§æ–¹å¼åœ¨æ•ˆç‡ä¸Šæ˜¯æœ€ä½çš„ã€‚è‡³äºæ— åŒæ­¥ï¼Œæ— éœ€å¤šè¨€ï¼Œæˆ‘æƒ³å¤§å®¶éƒ½èƒ½æ­£ç¡®çš„ç†è§£å®ƒã€‚
    1. ç”±äºè¯¥æœºåˆ¶å¯¹æ—¥å¿—æ–‡ä»¶çš„å†™å…¥æ“ä½œé‡‡ç”¨çš„æ˜¯appendæ¨¡å¼ï¼Œå› æ­¤åœ¨å†™å…¥è¿‡ç¨‹ä¸­å³ä½¿å‡ºç°å®•æœºç°è±¡ï¼Œä¹Ÿä¸ä¼šç ´åæ—¥å¿—æ–‡ä»¶ä¸­å·²ç»å­˜åœ¨çš„å†…å®¹ã€‚
        - ç„¶è€Œå¦‚æœæˆ‘ä»¬æœ¬æ¬¡æ“ä½œåªæ˜¯å†™å…¥äº†ä¸€åŠæ•°æ®å°±å‡ºç°äº†ç³»ç»Ÿå´©æºƒé—®é¢˜ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œåœ¨Redisä¸‹ä¸€æ¬¡å¯åŠ¨ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡redis-check-aofå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬è§£å†³æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚
    1. å¦‚æœæ—¥å¿—è¿‡å¤§ï¼ŒRediså¯ä»¥è‡ªåŠ¨å¯ç”¨rewriteæœºåˆ¶ã€‚å³Redisä»¥appendæ¨¡å¼ä¸æ–­çš„å°†ä¿®æ”¹æ•°æ®å†™å…¥åˆ°è€çš„ç£ç›˜æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶Redisè¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç”¨äºè®°å½•æ­¤æœŸé—´æœ‰å“ªäº›ä¿®æ”¹å‘½ä»¤è¢«æ‰§è¡Œã€‚å› æ­¤åœ¨è¿›è¡Œrewriteåˆ‡æ¢æ—¶å¯ä»¥æ›´å¥½çš„ä¿è¯æ•°æ®å®‰å…¨æ€§ã€‚
    1. AOFåŒ…å«ä¸€ä¸ªæ ¼å¼æ¸…æ™°ã€æ˜“äºç†è§£çš„æ—¥å¿—æ–‡ä»¶ç”¨äºè®°å½•æ‰€æœ‰çš„ä¿®æ”¹æ“ä½œã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¯¥æ–‡ä»¶å®Œæˆæ•°æ®çš„é‡å»ºã€‚

- AOFçš„åŠ£åŠ¿
    1. å¯¹äºç›¸åŒæ•°é‡çš„æ•°æ®é›†è€Œè¨€ï¼ŒAOFæ–‡ä»¶é€šå¸¸è¦å¤§äºRDBæ–‡ä»¶ã€‚RDB åœ¨æ¢å¤å¤§æ•°æ®é›†æ—¶çš„é€Ÿåº¦æ¯” AOF çš„æ¢å¤é€Ÿåº¦è¦å¿«ã€‚
    1. æ ¹æ®åŒæ­¥ç­–ç•¥çš„ä¸åŒï¼ŒAOFåœ¨è¿è¡Œæ•ˆç‡ä¸Šå¾€å¾€ä¼šæ…¢äºRDBã€‚æ€»ä¹‹ï¼Œæ¯ç§’åŒæ­¥ç­–ç•¥çš„æ•ˆç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼ŒåŒæ­¥ç¦ç”¨ç­–ç•¥çš„æ•ˆç‡å’ŒRDBä¸€æ ·é«˜æ•ˆã€‚

äºŒè€…é€‰æ‹©çš„æ ‡å‡†ï¼Œå°±æ˜¯çœ‹åº”ç”¨åœºæ™¯æ˜¯æ„¿æ„ç‰ºç‰²ä¸€äº›æ€§èƒ½ï¼Œæ¢å–æ›´é«˜çš„ç¼“å­˜ä¸€è‡´æ€§ï¼ˆaofï¼‰ï¼Œè¿˜æ˜¯æ„¿æ„å†™æ“ä½œé¢‘ç¹çš„æ—¶å€™ï¼Œä¸å¯ç”¨å¤‡ä»½æ¥æ¢å–æ›´é«˜çš„æ€§èƒ½ï¼Œå¾…æ‰‹åŠ¨è¿è¡Œsaveçš„æ—¶å€™ï¼Œå†åšå¤‡ä»½ï¼ˆrdbï¼‰ã€‚rdbè¿™ä¸ªå°±æ›´æœ‰äº› eventually consistent çš„æ„æ€äº†ã€‚


# å‘½ä»¤å®ç°åŸç†
## Scan
> [Doc: Scan](https://redis.io/commands/scan/) 

ç”±äº Redis æ˜¯å•çº¿ç¨‹å¤šè·¯å¤ç”¨æœºåˆ¶(Redis6å¼•å…¥å¤šçº¿ç¨‹)ï¼Œä½¿ç”¨ O(n) å¤æ‚åº¦çš„å‘½ä»¤å®¹æ˜“é˜»å¡è¿›ç¨‹ï¼Œå› æ­¤éœ€è¦ scan å‘½ä»¤æ¥å®ç°åˆ†æ‰¹æ‰§è¡Œ (`æ³¨æ„ scanå¦‚æœæ¨¡å¼åŒ¹é…çš„èŒƒå›´æ¯”è¾ƒå¤§ï¼ŒåŒæ ·æœ‰ keys ä¸€æ ·çš„å½±å“`)
