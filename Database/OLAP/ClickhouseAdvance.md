---
title: ClickhouseAdvance
date: 2024-04-26 01:17:19
tags: 
    - Clickhouse
    - OLAP
    - Advanced
categories: 
    - æ•°æ®åº“
---

ğŸ’ 

- 1. [Clickhouse](#clickhouse)
    - 1.1. [è®¾è®¡](#è®¾è®¡)
    - 1.2. [äº‹åŠ¡](#äº‹åŠ¡)
    - 1.3. [å­˜ç®—åˆ†ç¦»](#å­˜ç®—åˆ†ç¦»)
- 2. [ä½¿ç”¨å®è·µ](#ä½¿ç”¨å®è·µ)
    - 2.1. [å†™å…¥](#å†™å…¥)
        - 2.1.1. [åŒæ­¥å†™å…¥](#åŒæ­¥å†™å…¥)
    - 2.2. [æŸ¥è¯¢](#æŸ¥è¯¢)
    - 2.3. [ç›‘æ§](#ç›‘æ§)

ğŸ’  2025-07-01 20:46:45
****************************************
# Clickhouse

## è®¾è®¡
å®˜ç½‘çš„ä»‹ç»ä¸ºé¢å‘OLAPçš„é«˜æ€§èƒ½åˆ—å¼æ•°æ®åº“ã€‚

> å¤šä¸»æ¶æ„
- Ckä¸­æ•°æ®èŠ‚ç‚¹æ˜¯å¹³ç­‰çš„ï¼Œæ²¡æœ‰master/slaveä¹‹åˆ†ï¼Œ ç›¸è¾ƒäºGreenplumç­‰ç‰¹å®šä¸»å¤‡æ¶æ„å…·æœ‰æ›´é«˜çš„å¯ç”¨æ€§
    - æ“ä½œè¯·æ±‚ï¼ˆæŸ¥è¯¢å’ŒDDLï¼‰ä¼šç”±å®¢æˆ·ç«¯å†³å®šè´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹å‘é€æŒ‡ä»¤ï¼Œé€‰ä¸­çš„è¿™ä¸ªèŠ‚ç‚¹ä¼šæˆä¸ºä¸´æ—¶çš„ä¸šåŠ¡åè°ƒèŠ‚ç‚¹ï¼Œè´Ÿè´£ç®¡ç†æŒ‡ä»¤åœ¨é›†ç¾¤å†…çš„æ‰§è¡Œ
    - æ­£æ˜¯å¤šä¸»ç‰¹æ€§ï¼Œéƒ¨ç½²çš„ä¸»èŠ‚ç‚¹æ•°ç­‰äº1æ—¶å°±æ˜¯å•èŠ‚ç‚¹æ¨¡å¼ï¼ŒåŒæ ·å¯ä»¥é«˜æ€§èƒ½æä¾›æŸ¥è¯¢æœåŠ¡ï¼Œåªæ˜¯ä¸å…·å¤‡é«˜å¯ç”¨
- **é‡ä¾èµ–Zookeeper**ï¼Œæ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´æ€§å’Œåˆ†å¸ƒå¼è¡¨ï¼Œå¤åˆ¶è¡¨æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåˆ†ç‰‡çš„æ¸¸æ ‡éƒ½éœ€è¦ä¾èµ–zookeeperç®¡ç†
    - å½“ä¸€ä¸ªé›†ç¾¤å†…åˆ›å»ºäº†å¤§é‡çš„åˆ†å¸ƒå¼è¡¨ï¼Œå¤åˆ¶è¡¨æ—¶ï¼ˆç›®å‰ä½¿ç”¨ä¸­å‘ç°åˆ°äº†4000+æ—¶ï¼‰ï¼Œå¦‚æœæœ‰é«˜é¢‘ç‡çš„å»ºè¡¨/åˆ è¡¨DDLï¼Œåˆ†å¸ƒå¼è¡¨çš„æ•°æ®å†™å…¥ç­‰æ“ä½œä¼šå®¹æ˜“è¶…æ—¶ï¼Œæ­¤æ—¶çš„ç“¶é¢ˆæ˜¯å› ä¸ºZKçš„OP/Sä¸‹é™äº†ã€‚
    - å› æ­¤å®˜æ–¹åœ¨è®¡åˆ’è‡ªå»ºä¸€ä¸ª `clickhouse-keeper` æ›¿æ¢ZK

> åˆ—å¼å­˜å‚¨
- OLAPä¸šåŠ¡å…·æœ‰çš„ä¸€ä¸ªç‰¹æ€§æ˜¯åŸºäºå¤šç»´åº¦æŒ‡æ ‡çš„å¤§å®½è¡¨æ•°æ®ï¼Œèšåˆè®¡ç®—å‡ºæŸäº›ç»´åº¦æŒ‡æ ‡çš„ç»“æœï¼Œå¦‚æœæ˜¯è¡Œå­˜å‚¨ï¼Œioæˆæœ¬ä¼šé«˜äºåˆ—å­˜å‚¨ï¼ˆæŒ‰éœ€åŠ è½½åˆ—æ–‡ä»¶ï¼‰
- å…·æœ‰æ›´é«˜çš„å‹ç¼©ç‡ï¼ŒåŒåˆ—çš„æ•°æ®ç±»å‹æ˜¯ä¸€è‡´çš„ï¼Œå¯ä»¥åšæ›´æœ‰æ•ˆç‡çš„å‹ç¼©ï¼Œå‹ç¼©æ¯”ç‡é«˜äº†ä»¥åï¼Œå°±å¯ä»¥cacheæ›´å¤šçš„æ•°æ®åœ¨å†…å­˜ä¸­
    - [Compression in ClickHouse](https://altinity.com/blog/2017-11-21-compression-in-clickhouse)`æ”¯æŒLZ4ï¼ˆå¿«å¤§ï¼‰ Zstdï¼ˆæ…¢å°ï¼‰`
    - å¦‚æœIOæ˜¯ç“¶é¢ˆï¼ˆIOPSä¸å¤Ÿé«˜ï¼‰ Zstdæ›´åˆé€‚
    - å¦‚æœå‹ç¼©è§£å‹é€»è¾‘æ—¶CPUæ˜¯ç“¶é¢ˆ LZ4 æ›´åˆé€‚
    - å¦‚æœä¸å·®é’± IOå’ŒCPUéƒ½å¾ˆå¼ºï¼Œä¸å‹ç¼©æœ€åˆé€‚


> ç´¢å¼•
- ä¸€çº§ç´¢å¼•: æ’åºé”® ä¸»é”®  ç‰©ç†å­˜å‚¨, ç”¨ç´¢å¼•ç²’åº¦ index_granularrity è·³è¡¨ä¸€æ ·å»è¿æ¥å¤šä¸ªå—
- äºŒçº§ç´¢å¼•: å¼ºä¾èµ–ä¸€çº§ å‘½ä¸­ä¸€çº§æƒ…å†µä¸‹æ‰èƒ½ä¼˜åŒ–ä½¿ç”¨åˆ°äºŒçº§. ä¸åƒMySQLå¯ä»¥å•ç‹¬å‘½ä¸­äºŒçº§å›ä¸€çº§å†å›è¡¨æŸ¥
    - minmax è¡¨è¾¾å¼æŒ‰å—è®°å½•è¡¨è¾¾å¼çš„min maxå€¼, ç”¨äºåŠ é€Ÿæ‰«æè¡¨è¾¾å¼
    - set æ•°æ®å»é‡åå­˜å‚¨åˆ°ç´¢å¼•æ•°æ®å—ï¼ˆæœ‰å®¹é‡é™åˆ¶ï¼‰

æ³¨æ„ï¼šMergeTree ä¸»é”®ç´¢å¼• å…è®¸é‡å¤æ•°æ®

## äº‹åŠ¡
> [Transactional (ACID) support](https://clickhouse.com/docs/en/guides/developer/transactional)  


## å­˜ç®—åˆ†ç¦»

> [ClickHouse å­˜ç®—åˆ†ç¦»æ¶æ„æ¢ç´¢ - JuiceFS åšå®¢](https://juicefs.com/zh-cn/blog/solutions/clickhouse-disaggregated-storage-and-compute-practice)  

************************

# ä½¿ç”¨å®è·µ

> [Getting started with ClickHouse? Here are 13 "Deadly Sins" and how to avoid them](https://clickhouse.com/blog/common-getting-started-issues-with-clickhouse)  

## å†™å…¥
> [Bulk Inserts](https://clickhouse.com/docs/en/optimize/bulk-inserts)

- CKåº”å°½é‡é¿å…é«˜å¹¶å‘å°æ•°æ®é‡å†™å…¥, åº”ç”¨å±‚ä¸å¥½è°ƒæ•´çš„è¯ï¼Œå¯ä»¥å‰ç½®ä¸€å±‚Bufferå¼•æ“, å°†å°æ•°æ®é‡åˆå¹¶åå†å†™.
    - [ClickHouseè¿æ¥ZKé¢‘ç¹è¶…æ—¶å¤„ç†æ¡ˆä¾‹](https://www.modb.pro/db/159455)`æ•°æ®å°æ‰¹æ¬¡é¢‘ç¹å†™å…¥å¯¼è‡´partè¿‡å¤šï¼Œå¤§å¹…å½±å“zkçš„æ€§èƒ½`  
- åœ¨ä½¿ç”¨Dataxç­‰åŒæ­¥å·¥å…·åšæ•°æ®å†™å…¥æ—¶ï¼Œéœ€è¦æ³¨æ„å†™å…¥æ‰¹æ¬¡å‚æ•°`batchSize` è®¾ç½®10w-100wæ›´å¥½ï¼Œé¿å…CKåšå¤§é‡å°æ–‡ä»¶çš„åˆå¹¶ä»è€Œè§¦å‘æŠ¥é”™ `too many parts`
- æ•°æ®åŒæ­¥æ—¶ï¼Œç›´æ¥å¾€åˆ†å¸ƒå¼è¡¨å†™æ˜¯ç®€å•çš„åšæ³•
    - è¿›ä¸€æ­¥ä¼˜åŒ–æ˜¯ç›´æ¥å†™localï¼Œæ‰‹åŠ¨æŒ‰åˆ†ç‰‡é”®æ‹†åˆ†ä¸Šæ¸¸æ•°æ®ï¼Œå¾€ä¸åŒèŠ‚ç‚¹çš„localå†™ï¼Œéœ€è¦ä¿è¯æ•°æ®å‡è¡¡å’Œå®Œæ•´ 
    - ä¾‹å¦‚æ•´æ•°å­—æ®µæŒ‰èŠ‚ç‚¹æ•°å–ä½™ï¼Œå¦‚æœä¸èƒ½è¾¾åˆ°å‡åŒ€çš„åˆ†å¸ƒï¼Œå¯ä»¥ç»„åˆä¸šåŠ¡å­—æ®µhashåè½¬æ•´å‹å†æŒ‰èŠ‚ç‚¹æ•°å–ä½™
- æ•°æ®åŒæ­¥å†™å…¥åˆ†åŒºè¡¨æ—¶ï¼Œå°½é‡åœ¨å†™å…¥å‰åšå¥½æ‰‹åŠ¨åˆ†åŒº,**é¿å…å•æ¬¡æ•°æ®æ’å…¥åˆ°å¤šä¸ªåˆ†åŒº**ï¼Œæ‰‹åŠ¨è§„é¿æ•°æ®åˆ†å¸ƒå¼åˆ†å‘å¸¦æ¥çš„æ•ˆç‡å¼€é”€
    - å› æ­¤åœ¨ä¸€äº›å¹¶å‘åŒæ­¥çš„åœºæ™¯ä¸‹ï¼Œéœ€è¦è€ƒè™‘æ¯ä¸ªæ•°æ®ä»»åŠ¡æ˜¯å¦ä½¿ç”¨åˆ†ç‰‡é”®åšçš„æ‹†åˆ†ï¼Œå¦‚æœåˆ†ç‰‡é”®æ— æ³•ä¿è¯æ•°æ®çš„å‡åŒ€åˆ†å¸ƒè€Œé‡‡ç”¨å…¶ä»–å­—æ®µåšæ‹†åˆ†åˆ†ç‰‡æ—¶
        - æ³¨æ„CKç«¯å®¹æ˜“æœ‰å†™å…¥æŠ¥é”™ï¼Œå› ä¸ºæ­¤æ—¶æ¯ä¸ªä»»åŠ¡éƒ½ä¼šæ¶‰åŠåˆ°å¤šä¸ªåˆ†åŒºï¼Œzk ck è´Ÿè½½éƒ½ä¼šé«˜
        - Can't get data for node /clickhouse/table/02/tgysg/xxx/blocks/xxxx: node doesn't exist (No node). (KEEPER_EXCEPTION)
        - ZooKeeper session has been expired.. (NO_ZOOKEEPER) 
- Datax æ•°æ®åŒæ­¥å†™å…¥å¤åˆ¶è¡¨ï¼ŒZKè´Ÿè½½è¿‡å¤§å¼•å‘æŠ¥é”™
    - ç±»ä¼¼å°æ•°æ®é‡å†™å…¥çš„åšæ³• åœ¨å†™å…¥å¤åˆ¶è¡¨å‰ï¼Œå…ˆä»ä¸Šæ¸¸å†™å…¥åˆ°CKçš„éå¤åˆ¶è¡¨ä¸­å»ï¼Œç„¶åå†é€šè¿‡CKå†…éƒ¨çš„insert selectã€‚å®æµ‹æ•ˆç‡æå‡100%ï¼ŒåŸå› ç›®å‰æ¨æ–­ä¸ºCKå†…éƒ¨insertæœ‰åšä¼˜åŒ–
-  æ•°æ®æ–‡ä»¶æ–¹å¼åŒæ­¥ [ç™¾äº¿çº§æ•°æ®åŒæ­¥ï¼Œå¦‚ä½•åŸºäº SeaTunnel çš„ ClickHouse å®ç°ï¼Ÿ](https://seatunnel.apache.org/zh-CN/blog/2022/05/10/ClickHouse/)`åœ¨ä¸Šæ¸¸æ•°æ®ç«¯å°±ç”Ÿæˆckçš„æ•°æ®æ–‡ä»¶ï¼Œç„¶åä¼ è¾“æ–‡ä»¶ï¼ŒckæœåŠ¡ç«¯attachæŒ‚è½½è¯¥æ–‡ä»¶`  

Spark è§£æHDFSæ•°æ®ç”ŸæˆCK fileï¼ˆå•ä¸ªåˆ†åŒºåšä¸€ä¸ªgzå‹ç¼©åŒ…ï¼Œè§£å‹å…¥åº“ï¼‰å®Œæˆå†™å…¥Clickhouse

å‚è€ƒï¼š 

> [Clickhouseå†™å…¥é—®é¢˜æ±‡æ€»](https://www.cnblogs.com/yisany/p/14275785.html)  

> [How to configure ClickHouse for INSERT performance? ](https://dev.to/shiviyer/how-to-configure-clickhouse-for-insert-performance-4cof)`å¤§æ‰¹é‡å†™å…¥ï¼Œå¼‚æ­¥å†™å…¥ï¼ŒæŒ‰éœ€å–æ¶ˆå†™å…¥çº¦æŸï¼Œè¡¨å¼•æ“è°ƒä¼˜ï¼Œå‹ç¼©ç®—æ³•æ›¿æ¢ï¼Œç»“åˆç›‘æ§æ•°æ®å¯»æ‰¾å‡ºæœ€åˆé€‚ä¸šåŠ¡æ•°æ®çš„ä¸€å¥—é…ç½®`  
> [Essential Monitoring Queries - part 1 - INSERT Queries](https://clickhouse.com/blog/monitoring-troubleshooting-insert-queries-clickhouse)  

### åŒæ­¥å†™å…¥
æ³¨æ„CKæ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œæ‰€ä»¥ä¿®æ”¹ä¸å…·å¤‡äº‹åŠ¡æ€§ï¼Œä½†æ˜¯åœ¨ç‰¹å®šä¸šåŠ¡åœºæ™¯å¦‚æœéœ€è¦ä¾èµ–æ•°æ®çš„æœ‰é™ä¸€è‡´æ€§ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ä¸€äº›å‚æ•°å€¼æ¥é æ‹¢

æ‰§è¡Œçš„insert SQLåè¿½åŠ  SETTINGS async_insert = 0;
ç”¨æˆ·çº§è®¾ç½® SETTINGS insert_quorum=2;
ä¼šè¯è®¾ç½®ï¼š
SET async_insert = 0;  -- å…³é—­å¼‚æ­¥å†™å…¥
SET wait_for_async_insert = 1;  -- ç­‰å¾…å†™å…¥å®Œæˆ
SET wait_for_insert_timeout = 10;  -- è®¾ç½®ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

ç¼ºç‚¹ï¼š
å†™å…¥å»¶è¿Ÿå¢åŠ ï¼Œå› ä¸ºéœ€è¦ç­‰å¾…æ•°æ®è½ç›˜
å†™å…¥ååé‡ä¸‹é™ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯
å¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½ï¼Œå› ä¸ºå†™å…¥æ“ä½œä¼šå ç”¨æ›´å¤šç³»ç»Ÿèµ„æº

æ›´é«˜çš„ CPU ä½¿ç”¨ç‡
æ›´å¤šçš„å†…å­˜å ç”¨
æ›´é¢‘ç¹çš„ç£ç›˜ I/O æ“ä½œ

## æŸ¥è¯¢
ä¸é€‚åˆæŸ¥å•è¡Œçš„ç‚¹æŸ¥è¯¢, æœ€å°æŸ¥è¯¢æ•°æ®é‡æ˜¯ç´¢å¼•ç²’åº¦(index_granularity)çš„è¡Œæ•°, å³ä½¿æŸ¥è¯¢ä¸€æ¡æ•°æ®ï¼ŒCKä¹Ÿä¼šæŒ‰ç´¢å¼•ç²’åº¦åŠ è½½æ•´å—æ•°æ®è¿›ç¼“å­˜


## ç›‘æ§
> [æŸ¥è¯¢æ—¥å¿— system.query_log](https://clickhouse.com/docs/zh/operations/system-tables/query_log)  

```sql
-- æŸ¥è¯¢SQLæ‰§è¡Œè®°å½•
select hostname() hostname
      ,type
      ,query_kind
      ,event_time
      ,databases
      ,user
      ,address 
      ,query_duration_ms
      ,query
      ,exception_code
      ,exception
from clusterAllReplicas('default_cluster', system.query_log) 
where event_date = toDate(now()) and event_time > (now() - toIntervalMinute(300))
    --and query_duration_ms > 40000
    --and user not in('default','industrial_cloud')
    --and has(databases,'linkedsee_new')
      and query like '%user_info_local%'
      and query_kind not in('Select')
order by event_date ,event_time desc
limit 1009
```
