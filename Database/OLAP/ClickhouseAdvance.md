---
title: ClickhouseAdvance
date: 2024-04-26 01:17:19
tags: 
categories: 
---

ðŸ’ 

- 1. [Clickhouse](#clickhouse)
    - 1.1. [è®¾è®¡](#è®¾è®¡)
    - 1.2. [äº‹åŠ¡](#äº‹åŠ¡)
- 2. [ä½¿ç”¨å®žè·µ](#ä½¿ç”¨å®žè·µ)
    - 2.1. [å†™å…¥](#å†™å…¥)
    - 2.2. [æŸ¥è¯¢](#æŸ¥è¯¢)
    - 2.3. [ç›‘æŽ§](#ç›‘æŽ§)

ðŸ’  2024-10-08 11:39:18
****************************************
# Clickhouse

## è®¾è®¡
å®˜ç½‘çš„ä»‹ç»ä¸ºé¢å‘OLAPçš„é«˜æ€§èƒ½åˆ—å¼æ•°æ®åº“ã€‚

> å¤šä¸»æž¶æž„
- Ckä¸­æ•°æ®èŠ‚ç‚¹æ˜¯å¹³ç­‰çš„ï¼Œæ²¡æœ‰master/slaveä¹‹åˆ†ï¼Œ ç›¸è¾ƒäºŽGreenplumç­‰ç‰¹å®šä¸»å¤‡æž¶æž„å…·æœ‰æ›´é«˜çš„å¯ç”¨æ€§
    - æ“ä½œè¯·æ±‚ï¼ˆæŸ¥è¯¢å’ŒDDLï¼‰ä¼šç”±å®¢æˆ·ç«¯å†³å®šè´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹å‘é€æŒ‡ä»¤ï¼Œé€‰ä¸­çš„è¿™ä¸ªèŠ‚ç‚¹ä¼šæˆä¸ºä¸´æ—¶çš„ä¸šåŠ¡åè°ƒèŠ‚ç‚¹ï¼Œè´Ÿè´£ç®¡ç†æŒ‡ä»¤åœ¨é›†ç¾¤å†…çš„æ‰§è¡Œ
    - æ­£æ˜¯å¤šä¸»ç‰¹æ€§ï¼Œéƒ¨ç½²çš„ä¸»èŠ‚ç‚¹æ•°ç­‰äºŽ1æ—¶å°±æ˜¯å•èŠ‚ç‚¹æ¨¡å¼ï¼ŒåŒæ ·å¯ä»¥é«˜æ€§èƒ½æä¾›æŸ¥è¯¢æœåŠ¡ï¼Œåªæ˜¯ä¸å…·å¤‡é«˜å¯ç”¨
- **é‡ä¾èµ–Zookeeper**ï¼Œæ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´æ€§å’Œåˆ†å¸ƒå¼è¡¨ï¼Œå¤åˆ¶è¡¨æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåˆ†ç‰‡çš„æ¸¸æ ‡éƒ½éœ€è¦ä¾èµ–zookeeperç®¡ç†
    - å½“ä¸€ä¸ªé›†ç¾¤å†…åˆ›å»ºäº†å¤§é‡çš„åˆ†å¸ƒå¼è¡¨ï¼Œå¤åˆ¶è¡¨æ—¶ï¼ˆç›®å‰ä½¿ç”¨ä¸­å‘çŽ°åˆ°äº†4000+æ—¶ï¼‰ï¼Œå¦‚æžœæœ‰é«˜é¢‘çŽ‡çš„å»ºè¡¨/åˆ è¡¨DDLï¼Œåˆ†å¸ƒå¼è¡¨çš„æ•°æ®å†™å…¥ç­‰æ“ä½œä¼šå®¹æ˜“è¶…æ—¶ï¼Œæ­¤æ—¶çš„ç“¶é¢ˆæ˜¯å› ä¸ºZKçš„OP/Sä¸‹é™äº†ã€‚
    - å› æ­¤å®˜æ–¹åœ¨è®¡åˆ’è‡ªå»ºä¸€ä¸ª `clickhouse-keeper` æ›¿æ¢ZK

> åˆ—å¼å­˜å‚¨
- OLAPä¸šåŠ¡å…·æœ‰çš„ä¸€ä¸ªç‰¹æ€§æ˜¯åŸºäºŽå¤šç»´åº¦æŒ‡æ ‡çš„å¤§å®½è¡¨æ•°æ®ï¼Œèšåˆè®¡ç®—å‡ºæŸäº›ç»´åº¦æŒ‡æ ‡çš„ç»“æžœï¼Œå¦‚æžœæ˜¯è¡Œå­˜å‚¨ï¼Œioæˆæœ¬ä¼šé«˜äºŽåˆ—å­˜å‚¨ï¼ˆæŒ‰éœ€åŠ è½½åˆ—æ–‡ä»¶ï¼‰
- å…·æœ‰æ›´é«˜çš„åŽ‹ç¼©çŽ‡ï¼ŒåŒåˆ—çš„æ•°æ®ç±»åž‹æ˜¯ä¸€è‡´çš„ï¼Œå¯ä»¥åšæ›´æœ‰æ•ˆçŽ‡çš„åŽ‹ç¼©ï¼ŒåŽ‹ç¼©æ¯”çŽ‡é«˜äº†ä»¥åŽï¼Œå°±å¯ä»¥cacheæ›´å¤šçš„æ•°æ®åœ¨å†…å­˜ä¸­
    - [Compression in ClickHouse](https://altinity.com/blog/2017-11-21-compression-in-clickhouse)`æ”¯æŒLZ4ï¼ˆå¿«å¤§ï¼‰ Zstdï¼ˆæ…¢å°ï¼‰`
    - å¦‚æžœIOæ˜¯ç“¶é¢ˆï¼ˆIOPSä¸å¤Ÿé«˜ï¼‰ Zstdæ›´åˆé€‚
    - å¦‚æžœåŽ‹ç¼©è§£åŽ‹é€»è¾‘æ—¶CPUæ˜¯ç“¶é¢ˆ LZ4 æ›´åˆé€‚
    - å¦‚æžœä¸å·®é’± IOå’ŒCPUéƒ½å¾ˆå¼ºï¼Œä¸åŽ‹ç¼©æœ€åˆé€‚


> ç´¢å¼•
- ä¸€çº§ç´¢å¼•: æŽ’åºé”® ä¸»é”®  ç‰©ç†å­˜å‚¨, ç”¨ç´¢å¼•ç²’åº¦ index_granularrity è·³è¡¨ä¸€æ ·åŽ»è¿žæŽ¥å¤šä¸ªå—
- äºŒçº§ç´¢å¼•: å¼ºä¾èµ–ä¸€çº§ å‘½ä¸­ä¸€çº§æƒ…å†µä¸‹æ‰èƒ½ä¼˜åŒ–ä½¿ç”¨åˆ°äºŒçº§. ä¸åƒMySQLå¯ä»¥å•ç‹¬å‘½ä¸­äºŒçº§å›žä¸€çº§å†å›žè¡¨æŸ¥
    - minmax è¡¨è¾¾å¼æŒ‰å—è®°å½•è¡¨è¾¾å¼çš„min maxå€¼, ç”¨äºŽåŠ é€Ÿæ‰«æè¡¨è¾¾å¼
    - set æ•°æ®åŽ»é‡åŽå­˜å‚¨åˆ°ç´¢å¼•æ•°æ®å—ï¼ˆæœ‰å®¹é‡é™åˆ¶ï¼‰

æ³¨æ„ï¼šMergeTree ä¸»é”®ç´¢å¼• å…è®¸é‡å¤æ•°æ®

## äº‹åŠ¡
> [Transactional (ACID) support](https://clickhouse.com/docs/en/guides/developer/transactional)  

************************

# ä½¿ç”¨å®žè·µ

> [Getting started with ClickHouse? Here are 13 "Deadly Sins" and how to avoid them](https://clickhouse.com/blog/common-getting-started-issues-with-clickhouse)  

## å†™å…¥
> [Bulk Inserts](https://clickhouse.com/docs/en/optimize/bulk-inserts)

- CKåº”å°½é‡é¿å…é«˜å¹¶å‘å°æ•°æ®é‡å†™å…¥, åº”ç”¨å±‚ä¸å¥½è°ƒæ•´çš„è¯ï¼Œå¯ä»¥å‰ç½®ä¸€å±‚Bufferå¼•æ“Ž, å°†å°æ•°æ®é‡åˆå¹¶åŽå†å†™.
- åœ¨ä½¿ç”¨Dataxç±»åŒæ­¥å·¥å…·åšæ•°æ®å†™å…¥æ—¶ï¼Œéœ€è¦æ³¨æ„å†™å…¥æ‰¹æ¬¡å‚æ•°`batchSize` è®¾ç½®10w-100wæ›´å¥½ï¼Œé¿å…CKåšå¤§é‡å°æ–‡ä»¶çš„åˆå¹¶ä»Žè€Œè§¦å‘æŠ¥é”™ `too many parts`
- æ•°æ®åŒæ­¥æ—¶ï¼Œç›´æŽ¥å¾€åˆ†å¸ƒå¼è¡¨å†™æ˜¯ç®€å•çš„åšæ³•
    - è¿›ä¸€æ­¥ä¼˜åŒ–æ˜¯ç›´æŽ¥å†™localï¼Œæ‰‹åŠ¨æŒ‰åˆ†ç‰‡é”®æ‹†åˆ†ä¸Šæ¸¸æ•°æ®ï¼Œå¾€ä¸åŒèŠ‚ç‚¹çš„localå†™ï¼Œéœ€è¦ä¿è¯æ•°æ®å‡è¡¡å’Œå®Œæ•´ 
    - ä¾‹å¦‚æ•´æ•°å­—æ®µæŒ‰èŠ‚ç‚¹æ•°å–ä½™ï¼Œå¦‚æžœä¸èƒ½è¾¾åˆ°å‡åŒ€çš„åˆ†å¸ƒï¼Œå¯ä»¥ç»„åˆä¸šåŠ¡å­—æ®µhashåŽè½¬æ•´åž‹å†æŒ‰èŠ‚ç‚¹æ•°å–ä½™
- æ•°æ®åŒæ­¥å†™å…¥åˆ†åŒºè¡¨æ—¶ï¼Œå°½é‡åœ¨å†™å…¥å‰åšå¥½æ‰‹åŠ¨åˆ†åŒº,é¿å…å•æ¬¡æ•°æ®æ’å…¥åˆ°å¤šä¸ªåˆ†åŒºï¼Œæ‰‹åŠ¨è§„é¿æ•°æ®åˆ†å¸ƒå¼åˆ†å‘å¸¦æ¥çš„æ•ˆçŽ‡å¼€é”€
    - å› æ­¤åœ¨ä¸€äº›å¹¶å‘åŒæ­¥çš„åœºæ™¯ä¸‹ï¼Œéœ€è¦è€ƒè™‘æ¯ä¸ªæ•°æ®ä»»åŠ¡æ˜¯å¦ä½¿ç”¨åˆ†ç‰‡é”®åšçš„æ‹†åˆ†ï¼Œå¦‚æžœåˆ†ç‰‡é”®æ— æ³•ä¿è¯æ•°æ®çš„å‡åŒ€åˆ†å¸ƒè€Œé‡‡ç”¨å…¶ä»–å­—æ®µåšæ‹†åˆ†åˆ†ç‰‡æ—¶
        - æ³¨æ„CKç«¯å®¹æ˜“æœ‰å†™å…¥æŠ¥é”™ï¼Œå› ä¸ºæ­¤æ—¶æ¯ä¸ªä»»åŠ¡éƒ½ä¼šæ¶‰åŠåˆ°å¤šä¸ªåˆ†åŒºï¼Œzk ck è´Ÿè½½éƒ½ä¼šé«˜
        - Can't get data for node /clickhouse/table/02/tgysg/xxx/blocks/xxxx: node doesn't exist (No node). (KEEPER_EXCEPTION)
        - ZooKeeper session has been expired.. (NO_ZOOKEEPER) 


> æ•°æ®æ–‡ä»¶æ–¹å¼åŒæ­¥ [ç™¾äº¿çº§æ•°æ®åŒæ­¥ï¼Œå¦‚ä½•åŸºäºŽ SeaTunnel çš„ ClickHouse å®žçŽ°ï¼Ÿ](https://seatunnel.apache.org/zh-CN/blog/2022/05/10/ClickHouse/)`åœ¨ä¸Šæ¸¸æ•°æ®ç«¯å°±ç”Ÿæˆckçš„æ•°æ®æ–‡ä»¶ï¼Œç„¶åŽä¼ è¾“æ–‡ä»¶ï¼ŒckæœåŠ¡ç«¯attachæŒ‚è½½è¯¥æ–‡ä»¶`  
> [Clickhouseå†™å…¥é—®é¢˜æ±‡æ€»](https://www.cnblogs.com/yisany/p/14275785.html)  

[ClickHouseè¿žæŽ¥ZKé¢‘ç¹è¶…æ—¶å¤„ç†æ¡ˆä¾‹](https://www.modb.pro/db/159455)`æ•°æ®å°æ‰¹æ¬¡é¢‘ç¹å†™å…¥å¯¼è‡´partè¿‡å¤šï¼Œå¤§å¹…å½±å“zkçš„æ€§èƒ½`  
> [How to configure ClickHouse for INSERT performance? ](https://dev.to/shiviyer/how-to-configure-clickhouse-for-insert-performance-4cof)`å¤§æ‰¹é‡å†™å…¥ï¼Œå¼‚æ­¥å†™å…¥ï¼ŒæŒ‰éœ€å–æ¶ˆå†™å…¥çº¦æŸï¼Œè¡¨å¼•æ“Žè°ƒä¼˜ï¼ŒåŽ‹ç¼©ç®—æ³•æ›¿æ¢ï¼Œç»“åˆç›‘æŽ§æ•°æ®å¯»æ‰¾å‡ºæœ€åˆé€‚ä¸šåŠ¡æ•°æ®çš„ä¸€å¥—é…ç½®`  
> [Essential Monitoring Queries - part 1 - INSERT Queries](https://clickhouse.com/blog/monitoring-troubleshooting-insert-queries-clickhouse)  

## æŸ¥è¯¢
ä¸é€‚åˆæŸ¥å•è¡Œçš„ç‚¹æŸ¥è¯¢, æœ€å°æŸ¥è¯¢æ•°æ®é‡æ˜¯ç´¢å¼•ç²’åº¦(index_granularity)çš„è¡Œæ•°, å³ä½¿æŸ¥è¯¢ä¸€æ¡æ•°æ®ï¼ŒCKä¹Ÿä¼šæŒ‰ç´¢å¼•ç²’åº¦åŠ è½½æ•´å—æ•°æ®è¿›ç¼“å­˜


## ç›‘æŽ§
> [æŸ¥è¯¢æ—¥å¿— system.query_log](https://clickhouse.com/docs/zh/operations/system-tables/query_log)  

