---
title: MySQL InnoDB
date: 2022-06-27 14:23:03
tags: 
categories: 
---

ðŸ’ 

- 1. [InnoDB](#innodb)
    - 1.1. [æ ¸å¿ƒå‚æ•°](#æ ¸å¿ƒå‚æ•°)
- 2. [é”è®¾è®¡ç»†èŠ‚](#é”è®¾è®¡ç»†èŠ‚)
    - 2.1. [å…±äº«/æŽ’ä»–é”(Shared and Exclusive Locks)](#å…±äº«æŽ’ä»–é”shared-and-exclusive-locks)
    - 2.2. [æ„å‘é”(Intention Locks)](#æ„å‘é”intention-locks)
    - 2.3. [è®°å½•é”(Record Locks)](#è®°å½•é”record-locks)
    - 2.4. [é—´éš™é”(Gap Locks)](#é—´éš™é”gap-locks)
    - 2.5. [ä¸´é”®é”(Next-key Locks)](#ä¸´é”®é”next-key-locks)
    - 2.6. [æ’å…¥æ„å‘é”(Insert Intention Locks)](#æ’å…¥æ„å‘é”insert-intention-locks)
    - 2.7. [è‡ªå¢žé”(Auto-inc Locks)](#è‡ªå¢žé”auto-inc-locks)
    - 2.8. [ç²—ç²’åº¦ é”ç±»åž‹](#ç²—ç²’åº¦-é”ç±»åž‹)
- 3. [MVCCæœºåˆ¶](#mvccæœºåˆ¶)
- 4. [è¡Œè®¾è®¡](#è¡Œè®¾è®¡)
- 5. [Buffer Pool](#buffer-pool)

ðŸ’  2024-06-21 10:47:46
****************************************
# InnoDB
> [Doc: InnoDB](https://dev.mysql.com/doc/refman/8.0/en/innodb-storage-engine.html)

## æ ¸å¿ƒå‚æ•°
- `show global variables like 'innodb_buffer_pool_%';`
- `show status like '%buffer_pool%';`

************************

# é”è®¾è®¡ç»†èŠ‚
> [InnoDB Locking and Transaction Model](https://dev.mysql.com/doc/refman/8.0/en/innodb-locking-transaction-model.html)
> [InnoDB Locking](https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html)  

## å…±äº«/æŽ’ä»–é”(Shared and Exclusive Locks)
> å…±äº«é”(S)å’ŒæŽ’ä»–é”(X)æ˜¯InnoDBå¼•æ“Žå®žçŽ°çš„`è¡Œçº§åˆ«é”`ã€‚ 

æ‹¿å…±äº«é”æ˜¯ä¸ºäº†è®©å½“å‰äº‹åŠ¡åŽ»è¯»æŸä¸€è¡Œæ•°æ®ï¼ŒæŽ’ä»–é”åˆ™æ˜¯ä¸ºäº†ä¿®æ”¹æˆ–åˆ é™¤æŸä¸€è¡Œæ•°æ®ã€‚

## æ„å‘é”(Intention Locks)
> æ„å‘é”å­˜åœ¨çš„æ„ä¹‰åœ¨äºŽï¼Œä½¿å¾—è¡Œé”å’Œè¡¨é”èƒ½å¤Ÿå…±å­˜ã€‚ `æ„å‘é”æ˜¯è¡¨çº§åˆ«é”`ï¼Œç”¨æ¥è¯´æ˜Žäº‹åŠ¡ç¨åŽä¼šå¯¹è¡¨ä¸­çš„æ•°æ®è¡ŒåŠ å“ªç§ç±»åž‹çš„é”(å…±äº«é”æˆ–ç‹¬å é”)ã€‚

å½“ä¸€ä¸ªäº‹åŠ¡Aå¯¹è¡¨åŠ äº†æ„å‘æŽ’ä»–é”(IX)æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡åœ¨åŠ é”å‰å°±ä¼šé€šè¿‡è¯¥è¡¨çš„æ„å‘æŽ’ä»–é”çŸ¥é“å‰é¢å·²ç»æœ‰äº‹åŠ¡åœ¨å¯¹è¯¥è¡¨è¿›è¡Œç‹¬å æ“ä½œï¼Œä»Žè€Œç­‰å¾…ã€‚

|   |  X  |   IX  |  S |  IS
|:---|:---|:---|:---|:---|
X 	| âŒ | âŒ | âŒ | âŒ
IX 	| âŒ |   | âŒ | 
S 	| âŒ | âŒ |   | 
IS 	| âŒ |   |   | 

## è®°å½•é”(Record Locks)
> `è®°å½•é”æ˜¯ç´¢å¼•è®°å½•ä¸Šçš„é”`

ä¾‹å¦‚ï¼šSELECT c1 FROM t WHERE c1 = 10 FOR UPDATE;ä¼šé˜»æ­¢å…¶ä»–äº‹åŠ¡å¯¹c1=10çš„æ•°æ®è¡Œè¿›è¡Œæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œã€‚

è®°å½•é”æ€»æ˜¯é”å®šç´¢å¼•è®°å½•ã€‚å¦‚æžœä¸€ä¸ªè¡¨æ²¡æœ‰å®šä¹‰ç´¢å¼•ï¼Œé‚£ä¹ˆå°±ä¼šåŽ»é”å®šéšå¼çš„â€œèšé›†ç´¢å¼•â€ã€‚

## é—´éš™é”(Gap Locks)
> é—´éš™é”æ˜¯ä¸€ä¸ªåœ¨ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ä¸Šçš„é”ã€‚

ä¸€ä¸ªé—´éš™å¯èƒ½è·¨è¶Šå•ä¸ªç´¢å¼•å€¼ã€å¤šä¸ªç´¢å¼•å€¼ï¼Œç”šè‡³ä¸ºç©ºã€‚

å¯¹äºŽä½¿ç”¨å”¯ä¸€ç´¢å¼• æ¥æœç´¢å”¯ä¸€è¡Œçš„è¯­å¥ï¼ŒåªåŠ è®°å½•é”ä¸åŠ é—´éš™é”(è¿™å¹¶ä¸åŒ…æ‹¬ç»„åˆå”¯ä¸€ç´¢å¼•ï¼‰ã€‚

## ä¸´é”®é”(Next-key Locks)
> Next-Key Locksæ˜¯è¡Œé”ä¸Žé—´éš™é”çš„ç»„åˆã€‚

å½“InnoDBæ‰«æç´¢å¼•è®°å½•çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆå¯¹é€‰ä¸­çš„ç´¢å¼•è®°å½•åŠ ä¸Šè®°å½•é”ï¼ˆRecord Lockï¼‰ï¼Œç„¶åŽå†å¯¹ç´¢å¼•è®°å½•ä¸¤è¾¹çš„é—´éš™åŠ ä¸Šé—´éš™é”ï¼ˆGap Lockï¼‰ã€‚

## æ’å…¥æ„å‘é”(Insert Intention Locks)
> æ’å…¥æ„å‘é”æ˜¯åœ¨æ•°æ®è¡Œæ’å…¥ä¹‹å‰ è®¾ç½®çš„é—´éš™é”å®šç±»åž‹ã€‚

å¦‚æžœå¤šä¸ªäº‹åŠ¡æ’å…¥åˆ°ç›¸åŒçš„ç´¢å¼•é—´éš™ä¸­ï¼Œå¹¶ä¸”å®ƒä»¬ä¸åœ¨é—´éš™ä¸­çš„ç›¸åŒä½ç½®æ’å…¥ï¼Œåˆ™æ— éœ€ç­‰å¾…å…¶ä»–äº‹åŠ¡ã€‚  
ä¾‹å¦‚ï¼šåœ¨4å’Œ7çš„ç´¢å¼•é—´éš™ä¹‹é—´ä¸¤ä¸ªäº‹åŠ¡åˆ†åˆ«æ’å…¥5å’Œ6ï¼Œåˆ™ä¸¤ä¸ªäº‹åŠ¡ä¸ä¼šå‘å†²çªé˜»å¡žã€‚ 

## è‡ªå¢žé”(Auto-inc Locks)
> è‡ªå¢žé”æ˜¯äº‹åŠ¡æ’å…¥åˆ°æœ‰è‡ªå¢žåˆ—çš„è¡¨ä¸­è€ŒèŽ·å¾—çš„ä¸€ç§ç‰¹æ®Šçš„`è¡¨çº§é”`ã€‚

å¦‚æžœä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å‘è¡¨ä¸­æ’å…¥å€¼ï¼Œé‚£ä¹ˆä»»ä½•å…¶ä»–äº‹åŠ¡éƒ½å¿…é¡»ç­‰å¾…ï¼Œä¿è¯ç¬¬ä¸€ä¸ªäº‹åŠ¡æ’å…¥çš„è¡Œæ˜¯è¿žç»­çš„è‡ªå¢žå€¼ã€‚

## ç²—ç²’åº¦ é”ç±»åž‹
> è¡¨é”ï¼Œé¡µé”ï¼Œè¡Œé”

- è¡¨çº§é”ï¼šå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºçŽ°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚çŽ‡æœ€é«˜,å¹¶å‘åº¦æœ€ä½Žã€‚
- è¡Œçº§é”ï¼šå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºçŽ°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚çŽ‡æœ€ä½Ž,å¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚
- é¡µé¢é”ï¼šå¼€é”€å’ŒåŠ é”æ—¶é—´ç•ŒäºŽè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼›ä¼šå‡ºçŽ°æ­»é”ï¼›é”å®šç²’åº¦ç•ŒäºŽè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œå¹¶å‘åº¦ä¸€èˆ¬

> [æ­»é”åŽŸå› å’Œæ–¹æ¡ˆ](https://zhuanlan.zhihu.com/p/267522634)

************************

# MVCCæœºåˆ¶
> [InnoDB Multi-Versioning](https://dev.mysql.com/doc/refman/8.0/en/innodb-multi-versioning.html)

> [MySQL InnoDB MVCCæœºåˆ¶](https://www.jianshu.com/p/d67f0329d3bf)
> [å‚è€ƒ: è½»æ¾ç†è§£MYSQL MVCC å®žçŽ°æœºåˆ¶](https://blog.csdn.net/whoamiyang/article/details/51901888#commentBox)  

é”å¼€é”€è¾ƒå¤§ï¼Œå› æ­¤å¼•å…¥MVCC(å¿«ç…§è¯»)ï¼š è¯»ä¸åŠ é”ï¼Œè¯»å†™ä¸å†²çªã€‚åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹æžå¤§çš„å¢žåŠ äº†ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚`åªåœ¨RCå’ŒRRä¸‹ç”Ÿæ•ˆ, å› ä¸ºè¯»æœªæäº¤ä¸éœ€è¦(å·²ç»ä¸åœ¨æ„ä¸€è‡´æ€§äº†)ï¼Œåºåˆ—åŒ–åŒæ ·ä¸éœ€è¦(ç»å¯¹ä¸ä¼šå‡ºçŽ°ä¸€è‡´æ€§é—®é¢˜)`

Innodb å†…éƒ¨åœ¨æ¯è¡Œæœ‰éšè—åˆ—ï¼š
| åç§° | å¤§å° | è¯´æ˜Ž |
|:---|:---|:---|
| DB_TRX_ID    | 6-byte | äº‹åŠ¡idï¼Œæ¯å¤„ç†ä¸€ä¸ªäº‹åŠ¡ï¼Œå€¼è‡ªåŠ¨åŠ ä¸€ã€‚ |
| DB_ROLL_PTR  | 7-byte | å›žæ»šæŒ‡é’ˆï¼Œ æŒ‡å‘ undo è®°å½• |
| DB_ROW_ID    | 6-byte | è¡Œidï¼Œ 2^48ï¼Œå¦‚æžœæ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ä¸»é”®ï¼ŒrowIdæº¢å‡ºæ—¶ä¼šå‘ç”Ÿæ•°æ®è¦†ç›–(rowIdå¾ªçŽ¯ä½¿ç”¨) |

> æ¯æ¡è®°å½•çš„å¤´ä¿¡æ¯ï¼ˆrecord headerï¼‰é‡Œéƒ½æœ‰ä¸€ä¸ªbitï¼ˆdeleted_flagï¼‰æ¥è¡¨ç¤ºå½“å‰è®°å½•æ˜¯å¦å·²ç»è¢«åˆ é™¤

åœ¨å¤šä¸ªäº‹åŠ¡å¹¶è¡Œæ“ä½œæŸè¡Œæ•°æ®çš„æƒ…å†µä¸‹ï¼Œä¸åŒäº‹åŠ¡å¯¹è¯¥è¡Œæ•°æ®çš„UPDATEä¼šäº§ç”Ÿå¤šä¸ªç‰ˆæœ¬ï¼Œæ•°æ®åº“é€šè¿‡DB_TRX_IDæ¥æ ‡è®°ç‰ˆæœ¬ï¼Œç„¶åŽç”¨DB_ROLL_PTå›žæ»šæŒ‡é’ˆå°†è¿™äº›ç‰ˆæœ¬ä»¥å…ˆåŽé¡ºåºè¿žæŽ¥æˆä¸€æ¡ Undo Log é“¾ã€‚

> [innodb-consistent-read](https://dev.mysql.com/doc/refman/8.0/en/innodb-consistent-read.html)
ä¸€è‡´æ€§è§†å›¾çš„ç”Ÿæˆ ReadView

åœ¨read committedçº§åˆ«ä¸‹ï¼Œreadviewä¼šåœ¨äº‹åŠ¡ä¸­çš„æ¯ä¸€ä¸ªSELECTè¯­å¥æŸ¥è¯¢å‘é€å‰ç”Ÿæˆï¼ˆä¹Ÿå¯ä»¥åœ¨å£°æ˜Žäº‹åŠ¡æ—¶æ˜¾å¼å£°æ˜ŽSTART TRANSACTION WITH CONSISTENT SNAPSHOTï¼‰ï¼Œå› æ­¤æ¯æ¬¡SELECTéƒ½å¯ä»¥èŽ·å–åˆ°å½“å‰å·²æäº¤äº‹åŠ¡å’Œè‡ªå·±ä¿®æ”¹çš„æœ€æ–°ç‰ˆæœ¬ã€‚è€Œåœ¨repeatable readçº§åˆ«ä¸‹ï¼Œæ¯ä¸ªäº‹åŠ¡åªä¼šåœ¨ç¬¬ä¸€ä¸ªSELECTè¯­å¥æŸ¥è¯¢å‘é€å‰æˆ–æ˜¾å¼å£°æ˜Žå¤„ç”Ÿæˆï¼Œå…¶ä»–æŸ¥è¯¢æ“ä½œéƒ½ä¼šåŸºäºŽè¿™ä¸ªReadViewï¼Œè¿™æ ·å°±ä¿è¯äº†ä¸€ä¸ªäº‹åŠ¡ä¸­çš„å¤šæ¬¡æŸ¥è¯¢ç»“æžœéƒ½æ˜¯ç›¸åŒçš„ï¼Œå› ä¸ºä»–ä»¬éƒ½æ˜¯åŸºäºŽåŒä¸€ä¸ªReadViewä¸‹è¿›è¡ŒMVCCæœºåˆ¶çš„æŸ¥è¯¢æ“ä½œã€‚

************************

# è¡Œè®¾è®¡
> [row size limits](https://dev.mysql.com/doc/refman/8.0/en/column-count-limit.html#row-size-limits)  
> [MySQL ä¸€è¡Œè®°å½•æ˜¯æ€Žä¹ˆå­˜å‚¨çš„ï¼Ÿ](https://xiaolincoding.com/mysql/base/row_format.html)  

************************

# Buffer Pool
> [Buffer Pool](https://dev.mysql.com/doc/refman/8.0/en/innodb-buffer-pool.html)

Insert Buffer
Double Write
