---
title: çº¿ç¨‹æ± 
date: 2019-04-19 12:42:09
tags: 
categories: 
---

ğŸ’ 

- 1. [çº¿ç¨‹æ± ](#çº¿ç¨‹æ± )
    - 1.1. [ExecutorService æ¥å£](#executorservice-æ¥å£)
    - 1.2. [Executors](#executors)
    - 1.3. [CompletionService æ¥å£](#completionservice-æ¥å£)
    - 1.4. [ScheduledThreadPoolExecutor STPE](#scheduledthreadpoolexecutor-stpe)
    - 1.5. [åˆ†æ”¯åˆå¹¶æ¡†æ¶ Fork/Join](#åˆ†æ”¯åˆå¹¶æ¡†æ¶-forkjoin)
- 2. [Spring](#spring)
    - 2.1. [ThreadPoolTaskExecutor](#threadpooltaskexecutor)
- 3. [å®è·µ](#å®è·µ)
    - 3.1. [çº¿ç¨‹æ±  å‚æ•°ä¼˜åŒ– ç›‘æ§](#çº¿ç¨‹æ± -å‚æ•°ä¼˜åŒ–-ç›‘æ§)
    - 3.2. [ä¸šåŠ¡çº¿ç¨‹æ± ](#ä¸šåŠ¡çº¿ç¨‹æ± )
    - 3.3. [åœæ­¢çº¿ç¨‹æ± ](#åœæ­¢çº¿ç¨‹æ± )

ğŸ’  2024-09-13 10:39:04
****************************************
# çº¿ç¨‹æ± 

> [Javaçº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µ](https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html)
> [çº¿ç¨‹æ±  BlockingQueue synchronized volatile](https://segmentfault.com/a/1190000012916473)
> [å‚è€ƒ: Java(Android)çº¿ç¨‹æ± ](http://www.trinea.cn/android/java-android-thread-pool/)
> [å‚è€ƒ: Java ThreadPoolExecutorçº¿ç¨‹æ± ä½¿ç”¨çš„ä¸€ä¸ªè¯¯åŒº](http://codefine.site/2941.html)
> [å‚è€ƒ: èŠèŠå¹¶å‘ï¼ˆä¸‰ï¼‰Javaçº¿ç¨‹æ± çš„åˆ†æå’Œä½¿ç”¨](http://ifeve.com/java-threadpool/)
> [å‚è€ƒ: çº¿ç¨‹æ± ](http://ifeve.com/thread-pools/)

> å¿«é€Ÿåˆ›å»ºå‘½åç­–ç•¥çš„çº¿ç¨‹æ±  `ä¾èµ–common-lang3`
```java
new ThreadPoolExecutor(5, 5, 0L, TimeUnit.MILLISECONDS,
        new LinkedBlockingQueue<>(), new BasicThreadFactory.Builder().namingPattern("test-%d").build());
```

## ExecutorService æ¥å£
> [Github Demo](https://github.com/Kuangcp/JavaBase/tree/master/concurrency/src/main/java/thread/pool)

- `execute`ï¼šç”¨äºå°†ä»»åŠ¡æäº¤ç»™æ‰§è¡Œå™¨æ‰§è¡Œ
    - å‚æ•°ä¸ºRunable
    - æ— è¿”å›ï¼Œå¯¹äºè°ƒç”¨æ–¹æ¥è¯´æ— æ³•æ„ŸçŸ¥å¼‚å¸¸ï¼Œä½†æ˜¯å¼‚å¸¸æ ˆä¼šè¢«è¾“å‡ºåˆ° System.err ï¼Œä¾ç„¶æœ‰è¿¹å¯æŸ¥
- `submit`ï¼šåŠŸèƒ½åŒ`execute`ï¼Œä½†è¯¥æ–¹æ³•å¯ä»¥è¿”å›å€¼æˆ–æŠ›å‡ºå¼‚å¸¸ Future å¯¹è±¡
    - å‚æ•°ä¸ºCallable
    - è¿”å›çš„Futureå¯¹è±¡å¦‚æœä¸è°ƒç”¨getæ–¹æ³•ï¼Œä»»åŠ¡çš„å¼‚å¸¸æ ˆåœ¨ç³»ç»Ÿä¸­**æ²¡æœ‰ä»»ä½•ç—•è¿¹**

- `shutdown()`ï¼šç”¨äºå…³é—­æ‰§è¡Œå™¨èµ„æºï¼Œæ‰§è¡Œå™¨ä¼šæ‹’ç»åé¢çš„ä»»åŠ¡æäº¤ï¼Œå¹¶ç­‰å¾…çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡ç»“æŸåå…³é—­èµ„æº
    - åº”ç”¨å…³é—­å‰å°½é‡æ˜¾å¼è°ƒç”¨è¯¥æ–¹æ³•å…³é—­æ‰€æœ‰çš„çº¿ç¨‹æ± ï¼Œé¿å…èµ„æºæ³„æ¼
- `shutdownNow()`ï¼šç«‹å³å…³é—­æ‰§è¡Œå™¨ï¼Œè¿”å›ç­‰å¾…é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å°†æ”¶åˆ°interuptä½†æ˜¯ä¸ä¸€å®šä¼šåœæ­¢
- `isShutdown()`ï¼šæ˜¯å¦è°ƒç”¨è¿‡`shutdown()`
- `awaitTermination(long timeout, TimeUnit unit)`ï¼šè¯¥æ–¹æ³•ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç­‰å¾…æ‰§è¡Œå™¨å†…ä»»åŠ¡å®Œæˆç›´åˆ°è¶…æ—¶

- `invokeAny(Collection<? extends Callable<T>> tasks)`ï¼šè¿”å› ä»»æ„çš„ç¬¬ä¸€ä¸ªå®Œæˆä»»åŠ¡çš„è¿”å›å€¼
- `invokeAll(Collection<? extends Callable<T>> tasks)`ï¼šè¿”å›æ‰€æœ‰ä»»åŠ¡å¯¹åº”çš„Futureå¯¹è±¡

> æ³¨æ„

ä¸Šè¿°çš„ execute å’Œ submit è¡Œä¸ºåªé’ˆå¯¹ `ThreadPoolExecutor`. å¯¹äº ScheduledThreadPoolExecutor æ¥è¯´ï¼Œexecuteè¡Œä¸ºä¸ä¸€æ ·ï¼Œ executeæäº¤çš„ä»»åŠ¡ æŠ›å‡ºå¼‚å¸¸æ—¶ä¹Ÿæ˜¯**æ²¡æœ‰ä»»ä½•ç—•è¿¹**  

## Executors
> è¯¥å¤„è®²è¿°çš„æ–¹æ³•éƒ½ä¸º`java.util.concurrent.Executors`çš„æ–¹æ³• (é™æ€å·¥å‚æ¨¡å¼)

- `newFixedThreadPool(int nThreads)`ï¼šç”¨äºåˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± 
    - ä¼ å…¥çš„å‚æ•°è¡¨ç¤ºä¸ºçº¿ç¨‹æ± ä¸­æœ€å¤§çš„çº¿ç¨‹æ•°
    - å½“å‘é€çš„ä»»åŠ¡å¤§äºè¯¥æ•°é‡æ—¶ï¼Œçº¿ç¨‹æ± ä¸­åªä¼šåˆ›å»ºè¯¥æ•°é‡çš„çº¿ç¨‹ï¼Œå‰©ä¸‹çš„ä»»åŠ¡å°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰ç©ºé—²çš„çº¿ç¨‹å¯ç”¨
    - åˆ›å»ºæ–¹å¼: `ExecutorService executor = Executors.newFixedThreadPool(3);`

- `newSingleThreadExecutor()`ï¼šç”¨äºåˆ›å»ºå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± 
    - åœ¨è¯¥çº¿ç¨‹æ± ä¸­åªæœ‰ä¸€ä¸ªå·¥ä½œçš„çº¿ç¨‹
    - è¯¥çº¿ç¨‹æ± å¯ä¿è¯`ä»»åŠ¡ä¼šæŒ‰ä»»åŠ¡çš„æäº¤é¡ºåºè¿›è¡Œ`
    - åˆ›å»ºæ–¹å¼: `ExecutorService executor = Executors.newSingleThreadExecutor();`

- `newCachedThreadPool()`ï¼šç”¨äºåˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹æ± 
    - è¯¥çº¿ç¨‹æ± çš„`å·¥ä½œçº¿ç¨‹çš„åˆ›å»ºæ•°é‡å‡ ä¹æ²¡æœ‰é™åˆ¶`
    - å½“çº¿ç¨‹æ± ä¸­æ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹æ—¶ï¼Œæ–°æ·»åŠ çš„ä»»åŠ¡å°†ä¼šå†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹è¿è¡Œ
    - è¿è¡Œå®Œçš„ä»»åŠ¡ï¼Œåœ¨ä»»åŠ¡è¿è¡Œå®Œçš„`60s`å†…ä¸ä¼šè¢«å›æ”¶ï¼Œå½“æœ‰æ–°ä»»åŠ¡æ—¶å°†ä¼šé‡ç”¨è¿™äº›æ²¡è¢«å›æ”¶çš„çº¿ç¨‹
    - åˆ›å»ºæ–¹å¼: `ExecutorService executor = Executors.newCachedThreadPool();`

- `newScheduledThreadPool(int corePoolSize)`ï¼šç”¨äºåˆ›å»ºä¸€ä¸ªå®šé•¿çš„ä¸”æ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§è¿è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± 
    - ä¼ å…¥çš„å‚æ•°è¡¨ç¤ºä¸ºçº¿ç¨‹æ± ä¸­æœ€å¤§çš„çº¿ç¨‹æ•°
    - åˆ›å»ºæ–¹æ³•: `ScheduledExecutorService executor = Executors.newScheduledThreadPool(3);`
    - ä½¿ç”¨`schedule(Runnable command, long delay, TimeUnit unit)`æ–¹æ³•æäº¤ä»»åŠ¡æ—¶ï¼Œå¯è®©ä»»åŠ¡å»¶è¿Ÿæ‰§è¡Œï¼Œå¦‚ä¸‹å»¶è¿Ÿ1åˆ†é’Ÿæ‰§è¡Œç¤ºä¾‹: 
        ```java
        // å®šä¹‰æ‰§è¡Œå™¨ï¼Œåˆ›å»ºä¸€ä¸ªç¼“å­˜çº¿ç¨‹æ± 
        ScheduledExecutorService executor = Executors.newScheduledThreadPool(3);
        // æäº¤ä»»åŠ¡
        executor.schedule(() -> System.out.println("hello: " + new Date()), 1, TimeUnit.SECONDS);
        // å…³é—­æ‰§è¡Œå™¨èµ„æº
        executor.shutdown();
        ```
    - ä½¿ç”¨`scheduleAtFixedRate(Runnable command, long initialDelay, long period, TimeUnit unit)`æ–¹æ³•æäº¤ä»»åŠ¡ï¼Œå¯è®©ä»»åŠ¡å»¶è¿Ÿå¹¶å‘¨æœŸæ€§æ‰§è¡Œï¼Œå¦‚ä¸‹è®©ä»»åŠ¡å»¶è¿Ÿä¸€ç§’åæ²¡3ç§’æ‰§è¡Œä¸€æ¬¡:
        ```java
        // å®šä¹‰æ‰§è¡Œå™¨ï¼Œåˆ›å»ºä¸€ä¸ªç¼“å­˜çº¿ç¨‹æ± 
        ScheduledExecutorService executor = Executors.newScheduledThreadPool(3);
        // æäº¤ä»»åŠ¡
        executor.scheduleAtFixedRate(() -> System.out.println("hello: " + new Date()), 1, 3, TimeUnit.SECONDS);
        // å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡æ—¶ä¸è¦å…³é—­æ‰§è¡Œå™¨ï¼Œå¦åˆ™ä¸ä¼šå‘¨æœŸæ€§æ‰§è¡Œ
        //executor.shutdown();
        ```

- `newSingleThreadScheduledExecutor()`ï¼šåŠŸèƒ½ä¸`newScheduledThreadPool(int corePoolSize)`æ–¹æ³•åˆ›å»ºçš„çº¿ç¨‹æ± ç±»ä¼¼ï¼Œåªæ˜¯è¯¥æ–¹æ³•åˆ›å»ºçš„æ˜¯å•ä¾‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå³åœ¨è¯¥çº¿ç¨‹æ± ä¸­åªæœ‰ä¸€ä¸ªå·¥ä½œçš„çº¿ç¨‹

- `newWorkStealingPool()`ï¼šå¯åˆ›å»ºä¸€ä¸ªæ‹¥æœ‰å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—çš„çº¿ç¨‹æ± 
    - è¯¥æ–¹æ³•å®åœ¨`Java1.8`å¢åŠ çš„æ–¹æ³•
    - å®ƒæ˜¯çº¿ç¨‹æ± ç±»`ForkJoinPool`çš„æ‰©å±•
    - è¯¥çº¿ç¨‹æ± èƒ½å¤Ÿåˆç†çš„ä½¿ç”¨CPUè¿›è¡Œå¯¹ä»»åŠ¡æ“ä½œï¼ˆå¹¶è¡Œæ“ä½œï¼‰ï¼Œæ‰€ä»¥é€‚åˆä½¿ç”¨åœ¨å¾ˆè€—æ—¶çš„ä»»åŠ¡ä¸­
    - åˆ›å»ºæ–¹å¼ï¼š`ExecutorService executor = Executors.newWorkStealingPool();`

## CompletionService æ¥å£
> å®ç°ç±» ExecutorCompletionService ç±»JavaDocä¸Šæœ‰ä½¿ç”¨ç¤ºä¾‹

- submit
- take
- poll

> [TimeoutExecPoolTest](https://github.com/Kuangcp/JavaBase/blob/master/concurrency/src/test/java/situation/timoutpool/TimeoutExecPoolTest.java)`é™æ—¶å¹¶è¡Œæ¶ˆè´¹ä»»åŠ¡è·å–ç»“æœï¼Œæ—¶é—´åˆ°æœŸåˆ™ä¸¢å¼ƒæ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡`  

## ScheduledThreadPoolExecutor STPE
- çº¿ç¨‹æ± çš„å¤§å°å¯ä»¥é¢„å®šä¹‰ï¼Œ ä¹Ÿå¯è‡ªé€‚åº”
- æ‰€å®‰æ’çš„ä»»åŠ¡å¯ä»¥å®šæœŸæ‰§è¡Œï¼Œä¹Ÿå¯åªè¿è¡Œä¸€æ¬¡
- STPE æ‰©å±•äº† ThreadPoolExecutor ç±»ï¼Œå¾ˆç›¸ä¼¼ä½†ä¸å…·å¤‡å®šæœŸè°ƒåº¦èƒ½åŠ›
    - STPE å’Œå¹¶å‘åŒ…é‡Œçš„ç±»ç»“åˆä½¿ç”¨æ˜¯å¸¸è§çš„æ¨¡å¼ä¹‹ä¸€

> æ ¸å¿ƒAPIï¼š æäº¤ä»»åŠ¡
- `schedule(Runnable command, long delay, TimeUnit unit)`
- `schedule(Callable<V> callable, long delay, TimeUnit unit)`
- `scheduleAtFixedRate(Runnable command, long initialDelay, long period, TimeUnit unit)`
    - ä¸ç®¡ä¸Šä¸€æ¬¡Runnableæ‰§è¡Œç»“æŸçš„æ—¶é—´ï¼Œæ€»æ˜¯ä»¥å›ºå®šå»¶è¿Ÿæ—¶é—´æ‰§è¡Œ å³ ä¸Šä¸€ä¸ªRunnableæ‰§è¡Œå¼€å§‹æ—¶å€™ + å»¶æ—¶æ—¶é—´ = ä¸‹ä¸€ä¸ªRunnableæ‰§è¡Œçš„æ—¶é—´ç‚¹
- `scheduleWithFixedDelay(Runnable command, long initialDelay, long delay, TimeUnit unit)`
    - å½“ä¸Šä¸€ä¸ªRunnableæ‰§è¡Œç»“æŸå+å›ºå®šå»¶è¿Ÿ = ä¸‹ä¸€ä¸ªRunnableæ‰§è¡Œçš„æ—¶é—´ç‚¹

> å¦‚ä½•å®ç°è°ƒåº¦: [ScheduledThreadPoolExecutorå®ç°åŸç†](https://juejin.cn/post/7035415187783942152) | [éªŒè¯å•å…ƒæµ‹è¯•](https://github.com/Kuangcp/JavaBase/blob/master/concurrency/src/test/java/thread/schdule/SchedulerPoolTest.java)
- æ ¸å¿ƒä¾èµ– DelayedWorkQueue å®ç°å»¶è¿Ÿè°ƒåº¦
    - å…¨éƒ¨çº¿ç¨‹ç¹å¿™æ—¶ï¼Œè°ƒåº¦ä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜ï¼Ÿ 

************************
## åˆ†æ”¯åˆå¹¶æ¡†æ¶ Fork/Join
> [Noteï¼š Fork Join](/Java/AdvancedLearning/Concurrency/ForkAndJoin.md)

************************

# Spring 
## ThreadPoolTaskExecutor
> Springçš„çº¿ç¨‹æ± å°è£…å®ç°

- setTaskDecorator: çº¿ç¨‹æ± è£…é¥°å™¨ï¼Œé€šå¸¸ç”¨æ¥ThreadLocalå€¼çš„ä¼ é€’ï¼Œä¾‹å¦‚ TraceIdï¼Œæˆæƒå¯¹è±¡
- setWaitForTasksToCompleteOnShutdown ç­‰å¾…çº¿ç¨‹æ­£å¸¸æ‰§è¡Œå®Œæ‰é€€å‡ºå…¨éƒ¨çº¿ç¨‹

************************
# å®è·µ
ç›®æ ‡ï¼š åˆç†åˆ©ç”¨èµ„æºï¼Œè®©çº¿ç¨‹æ± å®‰å…¨å¯æ§çš„æ¶ˆè´¹ä»»åŠ¡

> [About Pool Sizing](https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing) | [About Pool Sizing in distributed environments / microservices](https://github.com/brettwooldridge/HikariCP/issues/1023)`å¦‚ä½•è®¾ç½®æ•°æ®åº“è¿æ¥æ± çº¿ç¨‹æ•°`  

> [ åˆç†ä½¿ç”¨çº¿ç¨‹æ± ä»¥åŠçº¿ç¨‹å˜é‡ ](https://mp.weixin.qq.com/s/BdVqvm2wLNv05vMTieevMg)  
> [ExecutorService - 10 tips and tricks](https://nurkiewicz.com/2014/11/executorservice-10-tips-and-tricks.html)  
> [Tomcat çº¿ç¨‹æ± ](/Java/Tool/TomcatDesign.md#çº¿ç¨‹æ± )  

- å¢åŠ å…¨å±€å¼‚å¸¸å¤„ç† `Thread.setUncaughtExceptionHandler()`, æˆ–æ‰‹åŠ¨catchä»»åŠ¡å—å…¨éƒ¨ä»£ç  é¿å…å¼‚å¸¸è¢«å [æµ‹è¯•ä»£ç ](https://github.com/Kuangcp/JavaBase/blob/master/concurrency/src/test/java/thread/pool/PoolExceptionTest.java)
- é¿å…å±€éƒ¨çº¿ç¨‹æ± ï¼Œå®¹æ˜“é—å¿˜çº¿ç¨‹èµ„æºå›æ”¶ï¼Œæ³¨æ„çº¿ç¨‹æ˜¯GCRootå¯¹è±¡
- ä¾æ®ä¸šåŠ¡å’Œç›‘æ§åˆç†è®¾ç½®å‚æ•°ï¼ŒåŠ¨æ€è°ƒæ•´
    - ç›‘æ§æŒ‡æ ‡æ ¸å¿ƒè¯‰æ±‚æ˜¯ å¿™ä¸å¿™ï¼Œåœ¨å¿™ä»€ä¹ˆï¼Œè¿˜æœ‰å¤šå°‘è¦å¿™ã€‚
    - è®¾ç½®å‚æ•°å€¼ï¼ˆæ ¸å¿ƒï¼Œæœ€å¤§ï¼Œé˜Ÿåˆ—å¤§å°ç­‰ç­‰ï¼‰ï¼Œæ´»è·ƒçº¿ç¨‹æ•°ï¼Œä»»åŠ¡æ‰§è¡Œé‡ï¼Œç­‰å¾…é˜Ÿåˆ—å¤§å°ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥æ¬¡æ•°ã€‚
- ç®¡ç†å¥½ä¸Šä¸‹æ–‡å‚æ•°

## çº¿ç¨‹æ±  å‚æ•°ä¼˜åŒ– ç›‘æ§
ç›®çš„ï¼šè§‚æµ‹çº¿ç¨‹æ± è¿è¡Œæƒ…å†µï¼Œä¼˜åŒ–ååé‡å’Œå»¶è¿Ÿï¼Œè§„é¿èµ„æºåˆ†é…ä¸åˆç†å¯¼è‡´ç“¶é¢ˆç”šè‡³å®•æœº

```
    Ncpu = cpuçš„æ ¸å¿ƒæ•°
    Ucpu = cpuçš„åˆ©ç”¨ç‡
    W = çº¿ç¨‹ç­‰å¾…æ—¶é—´
    C = çº¿ç¨‹æ‰§è¡Œè®¡ç®—æ—¶é—´
```

> å…¬å¼1ï¼šNthreads = Ncpu * Ucpu * W/C
- æ­¤æ–¹æ¡ˆåç†è®ºåŒ–ï¼Œcpuçš„å®é™…åˆ©ç”¨ç‡ï¼ˆå³åˆ†é…å¤šå°‘cpuç»™çº¿ç¨‹æ± ä½¿ç”¨ï¼‰å’Œçº¿ç¨‹çš„è®¡ç®—ï¼Œç­‰å¾…æ—¶é—´éå¸¸éš¾è¯„ä¼°ï¼Œå¹¶ä¸”æœ€åè®¡ç®—å‡ºæ¥çš„ç»“æœä¹Ÿå¾ˆå®¹æ˜“åç¦»å®é™…åº”ç”¨åœºæ™¯ã€‚

> å…¬å¼2ï¼šcoreSize = 2 * Ncpu , maxSize = 25 * Ncpu
- å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸åŒçš„ä¸šåŠ¡å¯¹çº¿ç¨‹æ± çš„éœ€æ±‚ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ç»Ÿä¸€é‡‡ç”¨cpuæ ¸å¿ƒæ•°æ¥é…ç½®æ˜¾ç„¶ä¸å¤ªåˆç†

> å…¬å¼3ï¼šcoreSize = tps * C , maxSize = tps * C * (1.7~2)
- ä¾æ®tpså’Œè€—æ—¶æ¥è®¡ç®—æ—¶åˆ»å†…éœ€è¦å ç”¨å¤šå°‘çº¿ç¨‹ï¼Œè¿™ç§é€‚åˆèµ„æºå……è¶³æ—¶ä¸ºäº†å°½é‡é™ä½ç­‰å¾…æ—¶é—´

************************

[Javaçº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µ](https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html)
    - åœºæ™¯è®¾è®¡å…·æœ‰ä¸€å®šçš„å¼€æ‹“æ€§ï¼Œå°†æ— æ³•é¢„ä¼°çš„ä¸šåŠ¡è´Ÿè½½é€šè¿‡ç›‘æ§å’ŒåŠ¨æ€ä¼¸ç¼©æ¥åŠæ—¶å‘ç°å¼‚å¸¸åº”å¯¹å¼‚å¸¸ã€‚
    - [çº¿ç¨‹æ± åŠ¨æ€ç›‘æ§](https://github.com/dromara/dynamic-tp)`æ”¯æŒä¿®æ”¹å’Œç›‘æ§å‘Šè­¦`

[æ ¹æ®CPUæ ¸å¿ƒæ•°ç¡®å®šçº¿ç¨‹æ± å¹¶å‘çº¿ç¨‹æ•°](https://www.cnblogs.com/dennyzhangdd/p/6909771.html)  
[å¦‚ä½•è®¾ç½®çº¿ç¨‹æ± å‚æ•°ï¼Ÿ](https://www.cnblogs.com/thisiswhy/p/12690630.html)
[çº¿ç¨‹æ± å®æ—¶ç®¡ç†ä¸ç›‘æ§å·¥å…·çš„å®ç°ä¸æ€è€ƒ](https://www.jianshu.com/p/6f6e2bcb8128)

[çº¿ç¨‹æ± å¦‚ä½•ç›‘æ§ï¼Œæ‰èƒ½å¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½çº¿ä¸Šé”™è¯¯ï¼Ÿ](https://heapdump.cn/article/4012121)`å°†åŸºå‡†æ•°æ®é‡‡é›†åˆ°æ•°æ®åº“è¡¨é‡Œ`  

************************

## ä¸šåŠ¡çº¿ç¨‹æ± 
åœ¨å®é™…ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œå‡ºäºä¸åŒä¸šåŠ¡çš„ååé‡èƒ½åŠ›ï¼Œæ•…éšœå½±å“ï¼Œä¿éšœä¼˜å…ˆçº§ ç­‰æ–¹é¢çš„è€ƒè™‘ï¼Œé€šå¸¸ä¼šå¯¹ä¸åŒçš„ä¸šåŠ¡æ¨¡å—åˆ’åˆ†ä¸åŒçš„çº¿ç¨‹æ± ï¼Œå¹¶ä¾æ®å¯¹åº”çš„éœ€æ±‚è®¾ç½®ä¸åŒçš„å‚æ•°å’Œç­–ç•¥ã€‚  
ä¾‹å¦‚ï¼š HTTPå®¢æˆ·ç«¯çº¿ç¨‹æ± ï¼ŒWEBæœåŠ¡å™¨NIOçº¿ç¨‹æ± ï¼Œç¼“å­˜åŒæ­¥çº¿ç¨‹æ± ï¼ŒWebsocketæ¶ˆæ¯æ¨é€çº¿ç¨‹æ±  ç­‰ç­‰ã€‚  

åŸºäºä»¥ä¸Šçš„è®¾è®¡è€ƒé‡ï¼Œä¼šé‡åˆ°ä¸€äº›é—®é¢˜
1. å›ºå®šçš„çº¿ç¨‹å‚æ•°æ— æ³•åº”å¯¹åŠ¨æ€çš„ä¸šåŠ¡å˜åŒ–ã€‚ 
    - æ–¹æ¡ˆï¼š ä¸Šæ–‡çš„çº¿ç¨‹æ± ç›‘æ§å‘Šè­¦ä»¥åŠåŠ¨æ€å‚æ•°è°ƒæ•´ï¼Œéœ€è¦äººä¸ºå®ˆæŠ¤è°ƒæ•´ï¼Œæˆ–ä¾æ®å®é™…ä¸šåŠ¡åœºæ™¯å®ç°å›ºå®šçš„åŠ¨æ€æ‰©ç¼©å®¹ç­–ç•¥
1. ä¸åŒçº¿ç¨‹æ± ï¼Œä¸Šä¸‹æ–‡ä¼ é€’ä»¥åŠäº‹åŠ¡é—®é¢˜, ä»¥åŠå¼‚æ­¥äº¤é”™é—®é¢˜ã€‚ 
    - å¼‚æ­¥äº¤é”™é—®é¢˜ï¼š ä¾‹å¦‚ä¸€ä¸ªä¸šåŠ¡æ–¹æ³•éœ€è¦åšABCå…ˆåå®Œæˆï¼Œä½†æ˜¯ä¸‰ä»¶äº‹åœ¨ä¸åŒçš„çº¿ç¨‹æ± ä¸­ï¼Œç”±äºä¸åŒçº¿ç¨‹æ± çš„æ‰§è¡Œæ•ˆç‡ä¸åŒå¯¼è‡´æœªèƒ½æŒ‰æœŸæœ›é¡ºåºæ‰§è¡Œ
        - æ–¹æ¡ˆï¼š 1. é€šè¿‡ CompletableFuture å®ç°å¼‚æ­¥ä¹‹é—´çš„ä¾èµ–å’Œç»„åˆ
    - ä¸Šä¸‹æ–‡ä¼ é€’é—®é¢˜ï¼š å¯ä»¥ä½¿ç”¨TTLçº¿ç¨‹æ± ï¼Œæˆ–è€…åœ¨çº¿ç¨‹æ± ä½¿ç”¨è£…é¥°å™¨ï¼Œæ‰‹åŠ¨å¤åˆ¶éœ€è¦çš„ä¸Šä¸‹æ–‡
    - äº‹åŠ¡ä¼ é€’é—®é¢˜ï¼š TODO

1. éšç€ä¸šåŠ¡éœ€æ±‚çš„å˜åŒ–ï¼Œçº¿ç¨‹æ± è¾¹ç•Œä¼šæ¨¡ç³Šï¼Œå¯¼è‡´ååé‡å¤§çš„æœåŠ¡è¢«ä½å¹¶å‘å‚æ•°çš„çº¿ç¨‹æ± äº§ç”ŸçŸ­æ¿æ•ˆåº”ï¼Œååé‡ä½çš„æœåŠ¡è¢«é«˜å¹¶å‘å‚æ•°çš„çº¿ç¨‹æ± ä»»åŠ¡å¤±è´¥é‡çªå¢ç”šè‡³è¢«æ‰“å®ã€‚ 
    - ä¾‹å¦‚HTTPè¯·æ±‚ä»»åŠ¡è¢«æäº¤åˆ°äº†ç¼“å­˜åŒæ­¥çº¿ç¨‹æ± ï¼Œå¤§é‡çš„HTTPè¯·æ±‚ä»»åŠ¡å ç”¨äº†å¾ˆå¤šèµ„æºå¯¼è‡´ç³»ç»Ÿç¼“å­˜çš„å®æ—¶æ€§å¤§å¤§é™ä½ã€‚
    - æ–¹æ¡ˆï¼š TODO

************************

## åœæ­¢çº¿ç¨‹æ± 
> å¦‚ä½•å®ç°JVMåœæ­¢æ—¶ç­‰å¾…çº¿ç¨‹æ± ä¸­ä»»åŠ¡æ‰§è¡Œå®Œæˆ å³ ä¼˜é›…åœæœº

ä¸ºäº†å®ç°ä¼˜é›…åœæœºçš„ç›®æ ‡ï¼Œåº”å½“å…ˆè°ƒç”¨shutdownæ–¹æ³•ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¹Ÿå°±æ„å‘³ç€ï¼Œè¿™ä¸ªçº¿ç¨‹æ± ä¸ä¼šå†æ¥æ”¶ä»»ä½•æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯å·²ç»æäº¤çš„ä»»åŠ¡è¿˜ä¼šç»§ç»­æ‰§è¡Œã€‚
ä¹‹åè¿˜åº”å½“è°ƒç”¨awaitTerminationæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥è®¾å®šçº¿ç¨‹æ± åœ¨å…³é—­ä¹‹å‰çš„æœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨è¶…æ—¶æ—¶é—´ç»“æŸä¹‹å‰çº¿ç¨‹æ± èƒ½å¤Ÿæ­£å¸¸å…³é—­åˆ™ä¼šè¿”å›trueï¼Œå¦åˆ™ï¼Œè¶…æ—¶ä¼šè¿”å›falseã€‚
é€šå¸¸éœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯é¢„ä¼°ä¸€ä¸ªåˆç†çš„è¶…æ—¶æ—¶é—´ã€‚

å¦‚æœawaitTerminationæ–¹æ³•è¿”å›falseï¼Œä½†åˆå¸Œæœ›å°½å¯èƒ½åœ¨çº¿ç¨‹æ± å…³é—­ä¹‹åå†åšå…¶ä»–èµ„æºå›æ”¶å·¥ä½œï¼Œå¯ä»¥è€ƒè™‘å†è°ƒç”¨ä¸€æ¬¡shutdownNowæ–¹æ³•ï¼Œæ­¤æ—¶é˜Ÿåˆ—ä¸­æ‰€æœ‰å°šæœªè¢«å¤„ç†çš„ä»»åŠ¡éƒ½ä¼šè¢«ä¸¢å¼ƒï¼ŒåŒæ—¶ä¼šè®¾ç½®çº¿ç¨‹æ± ä¸­æ¯ä¸ªçº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ã€‚
shutdownNow **å¹¶ä¸ä¿è¯**ä¸€å®šä¼šè®©æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹åœæ­¢å·¥ä½œï¼Œé™¤éæäº¤ç»™çº¿ç¨‹çš„ä»»åŠ¡èƒ½å¤Ÿæ­£ç¡®å“åº”ä¸­æ–­ã€‚

> çº¿ç¨‹æ± åœæ­¢æ—¶ï¼Œå¦‚ä½•æ„ŸçŸ¥åˆ° è¢«ä¸­æ–­çš„ è¿è¡Œä¸­å’Œç­‰å¾…ä¸­çš„ä»»åŠ¡
- é»˜è®¤çš„shutdownæ¥å£è¿”å›çš„æ˜¯RunnableåŒ¿åå®ä¾‹ï¼Œæ— æ³•æ˜ç¡®è·å–ä¸šåŠ¡ç‰¹å¾
    - å¯ä»¥è‡ªå·±å®ç° Runnable é™„å¸¦ä¸šåŠ¡ä¿¡æ¯è¿›å»
    ```java
        public class Task implements Runnable {
            private String id;
            private Runnable task;
            public Task(String id, Runnable task) {
                this.id = id;
                this.task = task;
            }
            @Override
            public void run() {
                this.task.run();
            }
        }
    ```
