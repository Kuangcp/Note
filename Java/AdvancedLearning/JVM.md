---
title: JVM
date: 2019-04-02 10:56:52
tags: 
    - JVM
categories: 
    - Java
---

ğŸ’ 

- 1. [JVM](#jvm)
    - 1.1. [JVMå‚æ•°](#jvmå‚æ•°)
    - 1.2. [Unified JVM Logging](#unified-jvm-logging)
    - 1.3. [JVMå†…å­˜å‚æ•°](#jvmå†…å­˜å‚æ•°)
        - 1.3.1. [å®¹å™¨å†…çš„JVM](#å®¹å™¨å†…çš„jvm)
        - 1.3.2. [å†…å­˜å‚æ•°å®è·µ](#å†…å­˜å‚æ•°å®è·µ)
- 2. [JVM åŸºæœ¬ç»“æ„](#jvm-åŸºæœ¬ç»“æ„)
- 3. [å†…å­˜åŒºåŸŸ](#å†…å­˜åŒºåŸŸ)
    - 3.1. [è¿è¡Œæ—¶æ•°æ®åŒº](#è¿è¡Œæ—¶æ•°æ®åŒº)
        - 3.1.1. [ç¨‹åºè®¡æ•°å™¨](#ç¨‹åºè®¡æ•°å™¨)
        - 3.1.2. [Javaè™šæ‹Ÿæœºæ ˆ](#javaè™šæ‹Ÿæœºæ ˆ)
        - 3.1.3. [æœ¬åœ°æ–¹æ³•æ ˆ](#æœ¬åœ°æ–¹æ³•æ ˆ)
        - 3.1.4. [Heap å †](#heap-å †)
            - 3.1.4.1. [å †å†…å­˜åˆ†é…ç­–ç•¥](#å †å†…å­˜åˆ†é…ç­–ç•¥)
        - 3.1.5. [æ–¹æ³•åŒº](#æ–¹æ³•åŒº)
            - 3.1.5.1. [è¿è¡Œæ—¶å¸¸é‡æ± ](#è¿è¡Œæ—¶å¸¸é‡æ± )
        - 3.1.6. [Direct Memory ç›´æ¥å†…å­˜](#direct-memory-ç›´æ¥å†…å­˜)
        - 3.1.7. [Code Cache](#code-cache)
    - 3.2. [Metaspace å…ƒç©ºé—´](#metaspace-å…ƒç©ºé—´)
    - 3.3. [ç›´æ¥å†…å­˜](#ç›´æ¥å†…å­˜)
- 4. [JVMä¸åŒå®ç°](#jvmä¸åŒå®ç°)
    - 4.1. [Hotspot JVM](#hotspot-jvm)
    - 4.2. [OpenJ9](#openj9)
    - 4.3. [GraalVM](#graalvm)

ğŸ’  2024-08-06 11:01:51
****************************************
# JVM
> JVMç»“æ„åŠè®¾è®¡

Oracle JDK é»˜è®¤é‡‡ç”¨çš„æ˜¯ Hotspot JVM

> [Java Language and Virtual Machine Specifications](https://docs.oracle.com/javase/specs/)

> [Github:jvmå­¦ä¹ ä»“åº“](https://github.com/xwjie/jvm)
> [ä¸ªäººåšå®¢: JVMå½’ç±»](https://vinoit.me/tags/jvm/)
 
`ä¹¦ç±`
- ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹(å‘¨å¿—æ˜ ç¬¬äºŒç‰ˆ) å¤§éƒ¨åˆ†å†…å®¹æ¥æºäºæ­¤, ä½†æ˜¯éƒ¨åˆ†å†…å®¹æ˜¯ä¾æ®Java8æœ‰æ‰€æ”¹åŠ¨

`ç¤¾åŒº`
- [prefma](https://club.perfma.com/)

## JVMå‚æ•°
> [Command Reference for JDK8](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html) | [Command Reference for JDK17](https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html)  
> [Official: Java HotSpot VM Options](https://www.oracle.com/java/technologies/javase/vmoptions-jsp.html)  
> [Guide to the Most Important JVM Parameters](https://www.baeldung.com/jvm-parameters)  

- [è¿œç¨‹è°ƒè¯•](/Java/AdvancedLearning/JavaDebug.md#è¿œç¨‹è°ƒè¯•)
- `-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false`
    - å¼€å¯æ— éœ€è®¤è¯ éSSLçš„JMXç«¯å£: 9999

- `-XX:+TraceClassLoading -XX:+TraceClassUnloading` è¾“å‡ºç±»è£…è½½/å¸è½½æ—¥å¿—ï¼Œå¯ç”¨äºæ’æŸ¥ç±»ä»å“ªä¸ªjaråŠ è½½è¿›å…¥JVMçš„
    - Java9åŠä»¥åæ›¿ä»£ä¸ºï¼š `-Xlog:class+load=info`

> OOM 
- `-XX:+HeapDumpOnOutOfMemoryError `
- `-XX:HeapDumpPath=./java_pid<pid>.hprof` æ³¨æ„è·¯å¾„éœ€è¦å­˜åœ¨ï¼ŒJVMä¸ä¼šåˆ›å»ºä¸å­˜åœ¨çš„ç›®å½•
- `-XX:OnOutOfMemoryError="< cmd args >;< cmd args >" `
- `-XX:+UseGCOverheadLimit`

> å­—ç¬¦ä¸²
- -XX:+UseStringCache
- -XX:+UseCompressedStrings
- -XX:+OptimizeStringConcat
- -XX:+UseStringDeduplication


> ç¼–è¯‘ç±»å‚æ•°
- CICompilerCountæ˜¯JITè¿›è¡Œçƒ­ç‚¹ç¼–è¯‘çš„çº¿ç¨‹æ•°ï¼Œå’Œå¹¶å‘æ ‡è®°çº¿ç¨‹æ•°ä¸€æ ·ï¼Œçƒ­ç‚¹ç¼–è¯‘ä¹Ÿæ˜¯CPUå¯†é›†å‹ä»»åŠ¡ï¼Œé»˜è®¤å€¼ä¸º2ã€‚
åœ¨CICompilerCountPerCPUå¼€å¯çš„æ—¶å€™ï¼ˆJDK7é»˜è®¤å…³é—­ï¼ŒJDK8é»˜è®¤å¼€å¯ï¼‰ï¼Œæ‰‹åŠ¨æŒ‡å®šCICompilerCountæ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ï¼ŒJVMä¼šä½¿ç”¨ç³»ç»ŸCPUæ ¸æ•°è¿›è¡Œè®¡ç®—ã€‚
æ‰€ä»¥å½“ä½¿ç”¨JRE8å¹¶ä¸”ç‰ˆæœ¬å°äº1.8.0_131ï¼Œé‡‡ç”¨é»˜è®¤å‚æ•°æ—¶ï¼ŒCICompilerCountä¼šåœ¨20å·¦å³ï¼Œå¯¹ä¸šåŠ¡æ€§èƒ½å½±å“è¾ƒå¤§ï¼Œç‰¹åˆ«æ˜¯å¯åŠ¨é˜¶æ®µã€‚å»ºè®®å‡çº§Javaç‰ˆæœ¬ï¼Œç‰¹æ®Šæƒ…å†µè¦ä½¿ç”¨è€ç‰ˆæœ¬Java 8ï¼Œè¯·åŠ ä¸Š`-XX:CICompilerCount=[n]`, åŒæ—¶ä¸èƒ½æŒ‡å®š-XX:+CICompilerCountPerCPU ï¼Œä¸‹è¡¨ç»™å‡ºäº†ç”Ÿäº§ç¯å¢ƒä¸‹å¸¸è§è§„æ ¼çš„æ¨èå€¼ã€‚

| CPUæ ¸æ•° | 1 | 2 | 4 | 8 | 16 |
|:---|:---|:---|:---|:---|:---|
| æ¨èå€¼ | 2 | 2 | 3 | 3 | 8 | 

## Unified JVM Logging
> [JEP 158: Unified JVM Logging](https://openjdk.org/jeps/158)

Java9å¼€å§‹ï¼Œæ•´åˆäº†GCï¼Œç±»åŠ è½½ç­‰æ—¥å¿—é…ç½®æ–¹å¼ï¼Œæ—¥å¿—çº§åˆ«ï¼Œè¾“å‡ºæ–¹å¼ æ­£äº¤å¼å£°æ˜ä½¿ç”¨ï¼Œæ›´ç»Ÿä¸€åŠçµæ´»ã€‚

## JVMå†…å­˜å‚æ•°
> å †(è€å¹´ä»£ å¹´è½»ä»£)ï¼Œå †å¤–ï¼Œå…ƒç©ºé—´ï¼Œæ ˆ

å¿«é€Ÿç¡®è®¤è¿›ç¨‹å†…å­˜é…ç½® 
| å·¥å…· | å‘½ä»¤ |
|:----|:----|
| Arthas    | `jvm`                   |
| OpenJDK   | `jcmd pid GC.heap_info` |
| OracleJDK | `jmap -heap pid`        |

- `-XX:CompressedClassSpaceSize=500m` å‹ç¼©çš„ç±»å…ƒç©ºé—´å¤§å° é»˜è®¤æ˜¯1g
- `-XX:SurvivorRatio` é…ç½® Edgen å’Œ å•ä¸ªSurvivor çš„æ¯”ä¾‹, å¦‚æœé…ç½®ä¸º2 åˆ™æ˜¯ 2:1:1ã€‚ **é»˜è®¤æ˜¯8**
- `-XX:NewRatio`old/new å†…å­˜çš„æ¯”å€¼ **é»˜è®¤æ˜¯2**
- `-Xmn` MaxNewSize é»˜è®¤å€¼æ˜¯`Xmx`çš„1/3 å³æœ€å¤§å †å†…å­˜ MaxHeapSize çš„1/3
- `-Xss` è®¾ç½® ThreadStackSize çº¿ç¨‹çš„æ ˆå†…å­˜å¤§å° é»˜è®¤å€¼ 1024k

> java -XX:+PrintFlagsFinal -version
- `-XX:+PrintFlagsInitial` è¾“å‡ºåˆå§‹é»˜è®¤å€¼
- `-XX:+PrintFlagsFinal` è¾“å‡ºJVMæœ€ç»ˆå±æ€§å€¼
    - MaxHeapSize æœ€å¤§å †å†…å­˜
    - MaxRAMFraction é»˜è®¤æœ€å¤§å†…å­˜å ç‰©ç†æœºå†…å­˜çš„æ¯”ä¾‹ JDK6ï¼Œ7ï¼Œ8 éƒ½æ˜¯4 å³1/4
    - NUMA æœºåˆ¶
    - `java -XX:+PrintFlagsFinal -version | grep "Use.*GC"` æŸ¥çœ‹é»˜è®¤GCå®ç°
- `-XshowSettings:VM` å±•ç¤ºVMå’Œç³»ç»Ÿä¿¡æ¯

************************

éœ€è¦ç†è§£ï¼Œä½†æ˜¯ä¸ç”¨ï¼Œå°½é‡ä½¿ç”¨æ˜ç¡®çš„ Xmx Xms
> [JVM Parameters InitialRAMPercentage, MinRAMPercentage, and MaxRAMPercentage](https://www.baeldung.com/java-jvm-parameters-rampercentage)  
- MinRAMPercentage, MaxRAMPercentage å…¶å®éƒ½æ˜¯**è®¾ç½®å †é»˜è®¤æœ€å¤§å€¼**çš„ï¼Œ Max å’Œ Min æ¢æˆ Big Smallå¯èƒ½æ›´å¥½ç†è§£(å¤§å†…å­˜ç¯å¢ƒå’Œå°å†…å­˜ç¯å¢ƒ `200Måˆ’åˆ†`)
- `-XX:InitialRAMPercentage` åˆå§‹å †ä½¿ç”¨å€¼ é»˜è®¤1.5625ï¼Œ å½“é…ç½®äº† `-Xms` æ—¶ï¼Œè¯¥é…ç½®å°†è¢«å¿½ç•¥
- InitialRAMFraction MaxRAMFraction  MinRAMFraction DefaultMaxRAMFraction 4ç­‰åˆ†å€¼

************************

### å®¹å™¨å†…çš„JVM

å®¹å™¨æ— æ³•æ„ŸçŸ¥èµ„æºé™åˆ¶ï¼Œ 8U191/10b34 åŠä»¥ä¸Šç‰ˆæœ¬æ‰æ”¯æŒ

- å¿«é€Ÿå®éªŒæŸä¸ªJavaç‰ˆæœ¬çš„é»˜è®¤å‚æ•°å’Œé™åˆ¶ docker run -m 100MB openjdk:8 java -XX:MinRAMPercentage=80.0 -XshowSettings:VM -version
- [å‚è€ƒ: Javaå’ŒDockeré™åˆ¶çš„é‚£äº›äº‹å„¿](http://www.techug.com/post/java-and-docker-memory-limits.html)`å¤©å‘ï¼š ä½ç‰ˆæœ¬çš„Jvmæ— æ³•æ„ŸçŸ¥åˆ°Dockerçš„èµ„æºé™åˆ¶`
- [ ] ä½†æ˜¯æœ‰çš„Linuxç‰ˆæœ¬åœ¨åç»­çš„ç‰ˆæœ¬ä¹Ÿæ— æ³•æ„ŸçŸ¥ï¼Œä¾‹å¦‚ 1.8.0_342 10.0.2 ä»å–çš„ä¸»æœºå†…å­˜, Linux 5.15å†…æ ¸ Manjaro23.1 

1. [Java (prior to JDK8 update 131) applications running in docker container CPU / Memory issues?](https://stackoverflow.com/questions/64262912/java-prior-to-jdk8-update-131-applications-running-in-docker-container-cpu-m)  
1. [Best Practices: Java Memory Arguments for Containers](https://dzone.com/articles/best-practices-java-memory-arguments-for-container)

æ€»ç»“ï¼š **å°½é‡ä½¿ç”¨ Xms Xmx**ï¼Œè€Œä¸æ˜¯ RAMPercentage RAMFractioncå‚æ•°ï¼ˆè¿˜è¦ç»“åˆå®¹å™¨æˆ–å®¿ä¸»æœºè®¡ç®—å®é™…å€¼ï¼‰ï¼Œé™ä½ç»´æŠ¤å’Œç†è§£æˆæœ¬ï¼Œæ§åˆ¶æ›´çµæ´»ç²¾ç¡®ï¼Œä¸”æ”¯æŒæ‰€æœ‰ç‰ˆæœ¬JVMï¼Œä¸ç”¨è€ƒè™‘å…¼å®¹æ€§é—®é¢˜

å‚æ•°ï¼š
- -XX:ActiveProcessorCount=$CONTAINER_CORE_LIMIT å¼ºåˆ¶è®¾ç½®CPUé‡ ä»downawrd_apiè·å–
- -Xlog:os+container=logLevel JVMæŠ¥å‘Šå®¹å™¨ä¿¡æ¯
- -XX:-UseContainerSupport å…³é—­å®¹å™¨æ”¯æŒï¼Œé»˜è®¤å¼€å¯

************************

### å†…å­˜å‚æ•°å®è·µ
> [åˆå§‹å’Œæœ€å¤§å †å†…å­˜è®¾ç½®ä¸ºä¸€æ ·çš„å¥½å¤„](https://gceasy.ycrash.cn/gc-recommendations/benefits-of-setting-initial-and-maximum-memory-size.jsp) 
> [Benefits of setting initial and maximum memory size to the same value](https://blog.ycrash.io/benefits-of-setting-initial-and-maximum-memory-size-to-the-same-value/)
- é¿å…æ‰©å®¹çš„æš‚åœäº‹ä»¶ï¼Œæå‰è°ƒåº¦å……è¶³èµ„æºçš„å®¹å™¨é˜²æ­¢è¿è¡ŒæœŸæ‰©å®¹è€Œè¢«Linuxè¢«OOMKilleræ€æ‰


> [å‚è€ƒ: JVMå®ç”¨å‚æ•°ï¼ˆä¸€ï¼‰JVMç±»å‹ä»¥åŠç¼–è¯‘å™¨æ¨¡å¼](http://ifeve.com/useful-jvm-flags-part-1-jvm-types-and-compiler-modes-2/)  
> [xxfox](http://xxfox.perfma.com/)`Jvmå‚æ•°è¾…åŠ©å·¥å…·`  
> [å‚è€ƒ: JVMåŠ¨æ€åä¼˜åŒ–](https://blog.mythsman.com/post/5d2c12cc67f841464434a3ec/)   

************************

# JVM åŸºæœ¬ç»“æ„
![JVMåŸºæœ¬ç»“æ„](img/004-jvm-structure.drawio.svg)

- ç±»åŠ è½½å™¨å­ç³»ç»Ÿ
    - è´Ÿè´£ä»æ–‡ä»¶ç³»ç»Ÿæˆ–è€…ç½‘ç»œä¸­è®°è½½Classä¿¡æ¯ï¼ŒåŠ è½½çš„ç±»ä¿¡æ¯å­˜æ”¾äºä¸€å—ç§°ä¸ºæ–¹æ³•åŒºçš„å†…å­˜ç©ºé—´ã€‚é™¤äº†ç±»çš„ä¿¡æ¯å¤–ï¼Œæ–¹æ³•åŒºä¸­å¯èƒ½è¿˜ä¼šå­˜æ”¾è¿è¡Œæ—¶çš„å¸¸é‡æ± ä¿¡æ¯ï¼ŒåŒ…å«å­—ç¬¦ä¸²å­—é¢é‡å’Œæ•°å­—å¸¸é‡ï¼ˆè¿™éƒ¨åˆ†å¸¸é‡ä¿¡æ¯æ˜¯Classæ–‡ä»¶ä¸­å¸¸é‡æ± éƒ¨åˆ†çš„å†…å­˜æ˜ å°„ï¼‰
- Javaå †
    - åœ¨è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™å»ºç«‹ï¼Œä»–æ˜¯Javaç¨‹åºæœ€ä¸»è¦çš„å†…å­˜å·¥ä½œåŒºåŸŸã€‚å‡ ä¹æ‰€æœ‰Javaå¯¹è±¡å®ä¾‹éƒ½å­˜æ”¾äºJavaå †ä¸­ã€‚å †ç©ºé—´æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ï¼Œè¿™æ˜¯ä¸€å—ä¸Javaåº”ç”¨å¯†åˆ‡ç›¸å…³çš„å†…å­˜åŒºé—´
    - Javaçš„NIOåº“å…è®¸Javaç¨‹åºä½¿ç”¨ç›´æ¥å†…å­˜ã€‚ç›´æ¥å†…å­˜æ˜¯Javaå †å¤–çš„ã€ç›´æ¥å‘ç³»ç»Ÿç”³è¯·çš„å†…å­˜åŒºé—´ã€‚é€šå¸¸ï¼Œè®¿é—®ç›´æ¥å†…å­˜çš„é€Ÿåº¦ä¼˜äºJavaå †ã€‚å› æ­¤å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œè¯»å†™é¢‘ç¹çš„åœºåˆå¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨ç›´æ¥å†…å­˜ã€‚ç”±äºç›´æ¥å†…å­˜åœ¨Javaå †å¤–ï¼Œå› æ­¤ä»–çš„å¤§å°ä¸ä¼šç›´æ¥å—é™äºXmxæŒ‡å®šçš„æœ€å¤§å †å¤§å°ï¼Œä½†æ˜¯ç³»ç»Ÿå†…å­˜æ˜¯æœ‰é™çš„ï¼ŒJavaå †å’Œç›´æ¥å†…å­˜çš„æ€»å’Œä¾ç„¶å—é™äºæ“ä½œç³»ç»Ÿèƒ½ç»™å‡ºçš„æœ€å¤§å†…å­˜
- åƒåœ¾å›æ”¶ç³»ç»Ÿ
    - æ˜¯Javaè™šæ‹Ÿæœºçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œåƒåœ¾å›æ”¶å™¨å¯ä»¥å¯¹æ–¹æ³•åŒºã€Javaå †å’Œç›´æ¥å†…å­˜è¿›è¡Œå›æ”¶ã€‚å…¶ä¸­ï¼ŒJavaå †æ˜¯åƒåœ¾å›æ”¶å™¨çš„å·¥ä½œé‡ç‚¹ã€‚å’ŒC/C++ä¸åŒï¼ŒJavaä¸­æ‰€æœ‰çš„å¯¹è±¡ç©ºé—´é‡Šæ”¾éƒ½æ˜¯éšå¼çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJavaä¸­æ²¡æœ‰ç±»ä¼¼free()å’Œdelete()è¿™æ ·çš„å‡½æ•°é‡Šæ”¾æŒ‡å®šçš„å†…å­˜åŒºåŸŸï¼Œå¯¹äºä¸å†ä½¿ç”¨çš„åƒåœ¾å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶ç³»ç»Ÿä¼šåœ¨åå°é»˜é»˜å·¥ä½œï¼Œé»˜é»˜æŸ¥æ‰¾ã€æ ‡è¯†å¹¶é‡Šæ”¾åƒåœ¾å¯¹è±¡ï¼Œå®ŒæˆJavaå †ã€æ–¹æ³•åŒºå’Œç›´æ¥å†…å­˜ä¸­çš„å…¨è‡ªåŠ¨ç®¡ç†ã€‚
- Javaè™šæ‹Ÿæœºæ ˆ
    - æ¯ä¸€ä¸ªJavaè™šæ‹Ÿæœºçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„Javaæ ˆã€‚ä¸€ä¸ªçº¿ç¨‹çš„Javaæ ˆåœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™è¢«åˆ›å»ºã€‚Javaæ ˆä¸­ä¿å­˜ç€å¸§ä¿¡æ¯ï¼ŒJavaæ ˆä¸­ä¿å­˜ç€å±€éƒ¨å˜é‡ã€æ–¹æ³•å‚æ•°ï¼ŒåŒæ—¶å’ŒJavaæ–¹æ³•çš„è°ƒç”¨ã€è¿”å›å¯†åˆ‡ç›¸å…³ã€‚
- æœ¬åœ°æ–¹æ³•æ ˆ
    - å’ŒJavaæ ˆéå¸¸ç±»ä¼¼ï¼Œæœ€å¤§çš„ä¸åŒåœ¨äºJavaæ ˆç”¨äºJavaæ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ç”¨äºæœ¬åœ°æ–¹æ³•è°ƒç”¨ã€‚ä½œä¸ºJavaè™šæ‹Ÿæœºçš„é‡è¦æ‰©å±•ï¼ŒJavaè™šæ‹Ÿæœºå…è®¸Javaç›´æ¥è°ƒç”¨æœ¬åœ°æ–¹æ³•ã€‚
- PCå¯„å­˜å™¨
    - ä¹Ÿæ˜¯æ¯ä¸ªçº¿ç¨‹ç§æœ‰çš„ç©ºé—´ï¼ŒJavaè™šæ‹Ÿæœºä¼šä¸ºæ¯ä¸€ä¸ªJavaçº¿ç¨‹åˆ›å»ºPCå¯„å­˜å™¨ã€‚åœ¨ä»»æ„æ—¶åˆ»ï¼Œä¸€ä¸ªJavaçº¿ç¨‹æ€»æ˜¯åœ¨æ‰§è¡Œä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ­£åœ¨è¢«æ‰§è¡Œçš„æ–¹æ³•ç§°ä¸ºå½“å‰æ–¹æ³•ã€‚å¦‚æœå½“å‰æ–¹æ³•ä¸æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼ŒPCå¯„å­˜å™¨å°±ä¼šæŒ‡å‘å½“å‰æ­£åœ¨è¢«æ‰§è¡Œçš„æŒ‡ä»¤ã€‚å¦‚æœå½“å‰æ–¹æ³•æ˜¯æœ¬åœ°æ–¹æ³•ï¼Œé‚£ä¹ˆPCå¯„å­˜å™¨çš„å€¼å°±æ˜¯undefinedã€‚
- æ‰§è¡Œå¼•æ“
    - æ˜¯Javaè™šæ‹Ÿæœºçš„æœ€æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œå®ƒè´Ÿè´£æ‰§è¡Œè™šæ‹Ÿæœºçš„å­—èŠ‚ç ã€‚

************************

# å†…å­˜åŒºåŸŸ
> [è°ˆJVM xmx, xmsç­‰å†…å­˜ç›¸å…³å‚æ•°åˆç†æ€§è®¾ç½®](https://developer.jdcloud.com/article/2740)  

å†…å­˜å‚æ•°è®¾ç½®çš„è€ƒé‡ï¼š
- Xmx * 110% + MaxDirectMemorySize + ç³»ç»Ÿé¢„ç•™å†…å­˜ <= å®¹å™¨å†…å­˜
- Xmx * 110% ä¸­é¢å¤–çš„10%æ˜¯ç•™ç»™å…¶ä»–å †å¤–å†…å­˜çš„ï¼Œæ˜¯ä¸ªä¿å®ˆä¼°è®¡ï¼Œä¸ªåˆ«ä¸šåŠ¡è¿è¡Œæ—¶çº¿ç¨‹è¾ƒå¤šï¼Œéœ€è‡ªè¡Œåˆ¤æ–­ï¼Œä¸Šå¼ä¸­å·¦ä¾§è¿˜éœ€åŠ ä¸ŠXss * çº¿ç¨‹æ•°
- ç³»ç»Ÿé¢„ç•™å†…å­˜512Måˆ°1Gï¼Œè§†å®¹å™¨è§„æ ¼è€Œå®š
- I/Oè¾ƒå¤šçš„ä¸šåŠ¡é€‚å½“æé«˜MaxDirectMemorySizeæ¯”ä¾‹

## è¿è¡Œæ—¶æ•°æ®åŒº
![](img/001-jvm-runtime-memory.drawio.svg)

çº¿ç¨‹ç§æœ‰çš„å†…å­˜åŒºåŸŸ: ç¨‹åºè®¡æ•°å™¨ æœ¬åœ°æ–¹æ³•æ ˆ è™šæ‹Ÿæœºæ ˆ. ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ä¿æŒä¸€è‡´

### ç¨‹åºè®¡æ•°å™¨
å¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨, è¿™ä¸ªå†…å­˜åŒºåŸŸæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨JVMè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½• OutOfMemoryError çš„åŒºåŸŸ

### Javaè™šæ‹Ÿæœºæ ˆ
> HotSpot ä¸­ä¸åŒºåˆ†Javaè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆ, è™½ç„¶ -Xoss å­˜åœ¨(è®¾ç½®æœ¬åœ°æ–¹æ³•æ ˆå¤§å°)ä½†æ˜¯æ˜¯æ— æ•ˆçš„, åªèƒ½é€šè¿‡ -Xss è®¾ç½®

![](img/002-method-stack.drawio.svg)

- è™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹: æ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶, éƒ½ä¼šåˆ›å»ºä¸€ä¸ª`æ ˆå¸§`(Stack Frame)
    - ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨, æ“ä½œæ•°æ ˆ, åŠ¨æ€é“¾æ¥, æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯  
    - åœ¨ä¸€ä¸ªæ ˆå¸§ä¸­ï¼Œè‡³å°‘è¦åŒ…å«å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆå’Œå¸§æ•°æ®ã€‚
- æ¯ä¸ªæ–¹æ³•è°ƒç”¨åˆ°æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹, å°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹

- å±€éƒ¨å˜é‡è¡¨
    - å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§ åŸºæœ¬æ•°æ®ç±»å‹, å¯¹è±¡å¼•ç”¨, returnAddress ç±»å‹
        - å¯¹è±¡å¼•ç”¨: reference ç±»å‹, ä¸ç­‰åŒäºå¯¹è±¡æœ¬èº«, å¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡åœ°å€çš„å¼•ç”¨æŒ‡é’ˆ, å¯èƒ½æ˜¯ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„, (å¯èƒ½æ˜¯å…¶ä»–ä¸æ­¤å¯¹è±¡ç›¸å…³çš„ä½ç½®?)
        - returnAddress: æŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€
    - åªæœ‰ long double ç±»å‹ ä¼šå ç”¨ 2 ä¸ªå±€éƒ¨å˜é‡ç©ºé—´, å…¶ä»–ç±»å‹éƒ½åªå ç”¨ 1 ä¸ª
    - å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å†…å­˜ç©ºé—´åœ¨ç¼–è¯‘åå°±å·²ç»ç¡®å®šä¸‹æ¥, è¿è¡ŒæœŸæ˜¯ä¸ä¼šå˜çš„

- Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å¯¹è¯¥å†…å­˜åŒºåŸŸå®šä¹‰äº†ä¸¤ç§å¼‚å¸¸çŠ¶å†µ
    - å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦, å°†æŠ›å‡º StackOverFlowError 
    - å¦‚æœè™šæ‹Ÿæœºåœ¨æ‰©å±•æ ˆæ—¶, æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜, åˆ™æŠ›å‡º OutOfMemoryError å¼‚å¸¸

### æœ¬åœ°æ–¹æ³•æ ˆ
Native Method Stack, ä¸è™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨æ˜¯ç›¸ä¼¼çš„, åªä¸è¿‡è™šæ‹Ÿæœºæ ˆæ˜¯ä¸ºè™šæ‹Ÿæœºæ‰§è¡ŒJavaæ–¹æ³•æœåŠ¡, æœ¬åœ°æ–¹æ³•æ ˆæ˜¯ä¸ºäº†è™šæ‹Ÿæœºä½¿ç”¨ Native æ–¹æ³•æœåŠ¡

### Heap å †
> Javaè™šæ‹Ÿæœºè§„èŒƒä¸­çš„æè¿°æ˜¯ æ‰€æœ‰å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½æ˜¯åœ¨å †ä¸Šåˆ†é…, ä½†æ˜¯ç”±äº JITç¼–è¯‘å™¨ é€ƒé€¸åˆ†æ æ ˆä¸Šåˆ†é…, æ ‡é‡æ›¿æ¢ç­‰æŠ€æœ¯, å°±å˜å¾—æ²¡é‚£ä¹ˆç»å¯¹äº†

å †åˆ†ä¸º æ–°ç”Ÿä»£(åŒ…å«: Eden, Survivor from, Survivor to) è€å¹´ä»£   
ä»å †å’Œæ ˆçš„åŠŸèƒ½å’Œä½œç”¨æ¥é€šä¿—çš„æ¯”è¾ƒ,å †ä¸»è¦ç”¨æ¥å­˜æ”¾å¯¹è±¡çš„ï¼Œæ ˆä¸»è¦æ˜¯ç”¨æ¥æ‰§è¡Œç¨‹åºçš„.  
JVMæ˜¯åŸºäºå †æ ˆçš„è™šæ‹Ÿæœº.JVMä¸ºæ¯ä¸ªæ–°åˆ›å»ºçš„çº¿ç¨‹éƒ½åˆ†é…ä¸€ä¸ªå †æ ˆ.ä¹Ÿå°±æ˜¯è¯´,å¯¹äºä¸€ä¸ªJavaç¨‹åºæ¥è¯´ï¼Œå®ƒçš„è¿è¡Œå°±æ˜¯é€šè¿‡å¯¹å †æ ˆçš„æ“ä½œæ¥å®Œæˆçš„ã€‚  
å †æ ˆä»¥æ ˆå¸§ä¸ºå•ä½ä¿å­˜çº¿ç¨‹çš„çŠ¶æ€ã€‚JVMå¯¹å †æ ˆåªè¿›è¡Œä¸¤ç§æ“ä½œ:ä»¥å¸§ä¸ºå•ä½çš„å‹æ ˆå’Œå‡ºæ ˆæ“ä½œã€‚ 

> [å‚è€ƒ: Javaä¸­å †å†…å­˜å’Œæ ˆå†…å­˜è¯¦è§£](http://www.cnblogs.com/whgw/archive/2011/09/29/2194997.html)

#### å †å†…å­˜åˆ†é…ç­–ç•¥
- å¯¹è±¡çš„å†…å­˜åˆ†é…, ç²—ç•¥è®²å°±æ˜¯åœ¨å †ä¸Šåˆ†é…(ä½†ä¹Ÿå¯èƒ½ç»è¿‡JITç¼–è¯‘åè¢«æ‹†æ•£æˆæ ‡é‡ç±»å‹å¹¶é—´æ¥åœ°æ ˆä¸Šåˆ†é…)   
- å¯¹è±¡ä¸»è¦åˆ†é…åœ¨Eden; å¦‚æœå¯åŠ¨äº†æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†², åˆ™ä¼˜å…ˆåœ¨TLABä¸Šåˆ†é…; ä¹Ÿæœ‰ç›´æ¥åˆ†é…åœ¨è€å¹´ä»£çš„ (é•¿å­—ç¬¦ä¸²ä»¥åŠæ•°ç»„)

1. `ç±»å˜é‡`ï¼ˆstaticä¿®é¥°çš„å˜é‡ï¼‰ åœ¨ç¨‹åºåŠ è½½æ—¶ç³»ç»Ÿå°±ä¸ºå®ƒåœ¨å †ä¸­å¼€è¾Ÿäº†å†…å­˜ï¼Œå †ä¸­çš„å†…å­˜åœ°å€å­˜æ”¾äºæ ˆä»¥ä¾¿äºé«˜é€Ÿè®¿é—®ã€‚  
    - ç”Ÿå‘½å‘¨æœŸ: ä»åº”ç”¨è¿›ç¨‹å¯åŠ¨ä¸€ç›´åˆ°è¿›ç¨‹åœæ­¢
2. `å®ä¾‹å˜é‡` å½“ä½ ä½¿ç”¨javaå…³é”®å­—newçš„æ—¶å€™ï¼Œç³»ç»Ÿåœ¨å †ä¸­å¼€è¾Ÿå¹¶ä¸ä¸€å®šæ˜¯è¿ç»­çš„ç©ºé—´åˆ†é…ç»™å˜é‡ï¼ˆæ¯”å¦‚è¯´ç±»å®ä¾‹ï¼‰ï¼Œç„¶åæ ¹æ®é›¶æ•£çš„å †å†…å­˜åœ°å€ï¼Œé€šè¿‡å“ˆå¸Œç®—æ³•æ¢ç®—ä¸ºä¸€é•¿ä¸²æ•°å­—ä»¥è¡¨å¾è¿™ä¸ªå˜é‡åœ¨å †ä¸­çš„"ç‰©ç†ä½ç½®"ã€‚ 
    - ç”Ÿå‘½å‘¨æœŸ: å½“å®ä¾‹å˜é‡çš„å¼•ç”¨ä¸¢å¤±åï¼Œå°†è¢«GCï¼ˆåƒåœ¾å›æ”¶å™¨ï¼‰åˆ—å…¥å¯å›æ”¶â€œåå•â€ä¸­ï¼Œä½†å¹¶ä¸æ˜¯é©¬ä¸Šå°±é‡Šæ”¾å †ä¸­å†…å­˜
3. `å±€éƒ¨å˜é‡` å±€éƒ¨å˜é‡ï¼Œç”±å£°æ˜åœ¨æŸæ–¹æ³•ï¼Œæˆ–æŸä»£ç æ®µé‡Œï¼ˆæ¯”å¦‚forå¾ªç¯ï¼‰ï¼Œæ‰§è¡Œåˆ°å®ƒçš„æ—¶å€™åœ¨æ ˆä¸­å¼€è¾Ÿå†…å­˜
    - ç”Ÿå‘½å‘¨æœŸ: å½“å±€éƒ¨å˜é‡ä¸€ä½†è„±ç¦»ä½œç”¨åŸŸï¼Œå†…å­˜ç«‹å³é‡Šæ”¾

************************    

- å¦‚æœå¯¹è±¡åœ¨ Eden å‡ºç”Ÿ, å¹¶ç»è¿‡ä¸€æ¬¡ MinorGCåå­˜æ´», å¹¶èƒ½è¢« Survivor å®¹çº³, å°†è¢«ç§»å…¥ Survivor ä¸”å¹´é¾„ä¸º1.
    - å¯¹è±¡åœ¨ Survivor æ¯ç»è¿‡ä¸€æ¬¡ MinorGC å¹´é¾„åŠ 1, å½“è¾¾åˆ° MaxTenuringThreshold(é»˜è®¤15) å°±ä¼šç§»å…¥è€å¹´ä»£
- å¦‚æœ Survivor ç©ºé—´ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äº Survivor ç©ºé—´çš„ä¸€åŠ, å¹´é¾„å¤§äºç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡éƒ½å°†è¿›å…¥è€å¹´ä»£, æ— éœ€ç­‰åˆ°è®¾ç½®çš„ MaxTenuringThreshold

> å †å†…å­˜é…ç½®: æ–°ç”Ÿä»£ä¸€èˆ¬è®¾ç½®ä¸ºæ•´ä¸ªå †ç©ºé—´çš„1/3åˆ°1/4å·¦å³æœ€åˆé€‚ã€‚  
æ–°ç”Ÿä»£å†…å­˜ä¸èƒ½è¿‡å¤§ä¹Ÿä¸èƒ½è¿‡å°, è¿‡å¤§åˆ™è€å¹´ä»£å†…å­˜è¿‡å°, å¯¼è‡´é¢‘ç¹ FullGC  
è¿‡å°åˆ™å¯¼è‡´å¯¹è±¡å…¨åœ¨è€å¹´ä»£åˆ†é…,æ–°ç”Ÿä»£ä¸Šæ— æ³•åˆ†é…(Allocation Failure) ä¹Ÿå°†å¯¼è‡´é¢‘ç¹ Full GC 

### æ–¹æ³•åŒº
æ–¹æ³•åŒºå­˜åœ¨äºæ°¸ä¹…ä»£ Perm Gen, å¯¹åº”äºJava8ä¸­çš„MetaSpace

ç”¨äºå­˜æ”¾ Class ç›¸å…³ä¿¡æ¯, å¸¸é‡, é™æ€å˜é‡, è®¿é—®ä¿®é¥°ç¬¦, å­—æ®µæè¿°, æ–¹æ³•æè¿°, JITç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®   
åœ¨ HotSpot è™šæ‹Ÿæœºä¸Š, æ–¹æ³•åŒºä¹Ÿçœ‹åšæ˜¯ æ°¸ä¹…ä»£ Permanent Gen, ä¸¤è€…å…³ç³»æ˜¯: æ–¹æ³•åŒºæ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒ, æ°¸ä¹…ä»£æ˜¯æ–¹æ³•åŒºåœ¨Hotspotä¸Šçš„å®ç°  
ä»Java8å¼€å§‹, æ°¸ä¹…ä»£å·²ç»è¢« MetaSpace(æ“ä½œç³»ç»Ÿçš„ç›´æ¥å†…å­˜) å–ä»£   

JDK7ä¸­ç¬¦å·è¡¨è¢«ç§»åŠ¨åˆ° Native Heapä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å’Œç±»å¼•ç”¨è¢«ç§»åŠ¨åˆ° Java Heapä¸­ã€‚

#### è¿è¡Œæ—¶å¸¸é‡æ± 
è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†, ç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨,è¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åè¿›å…¥æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± å­˜æ”¾.

### Direct Memory ç›´æ¥å†…å­˜
ç›´æ¥å†…å­˜å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†, ä¹Ÿä¸æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸ. ä½†æ˜¯è¿™éƒ¨åˆ†å†…å­˜ä¹Ÿè¢«é¢‘ç¹åœ°ä½¿ç”¨, è€Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´ OutOfMemoryError 

NIO ä¼šç»å¸¸ä½¿ç”¨, æé«˜æ€§èƒ½

### Code Cache
> [Introduction to JVM Code Cache](https://www.baeldung.com/jvm-code-cache)  


************************

## Metaspace å…ƒç©ºé—´
> MetaSpace Java8 å¼•å…¥, å–ä»£äº†ä»¥å¾€çš„ Perm Gen

- å­˜æ”¾å†…å®¹ï¼š
    - Klassç»“æ„
    - åŒ¿åç±»ï¼Œ Lambdaè¡¨è¾¾å¼
    - String.intern çš„å­—ç¬¦ä¸²

> ç‰¹æ€§
- å……åˆ†åˆ©ç”¨äº†Javaè¯­è¨€è§„èŒƒï¼šç±»åŠç›¸å…³çš„å…ƒæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸ç±»åŠ è½½å™¨çš„ä¸€è‡´ã€‚
- æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰å®ƒçš„å†…å­˜åŒºåŸŸ-å…ƒç©ºé—´
- åªè¿›è¡Œçº¿æ€§åˆ†é…
- ä¸ä¼šå•ç‹¬å›æ”¶æŸä¸ªç±»ï¼ˆé™¤äº†é‡å®šä¹‰ç±» RedefineClasses æˆ–ç±»åŠ è½½å¤±è´¥ï¼‰
- æ²¡æœ‰GCæ‰«ææˆ–å‹ç¼©
- å…ƒç©ºé—´é‡Œçš„å¯¹è±¡ä¸ä¼šè¢«è½¬ç§»
- å¦‚æœGCå‘ç°æŸä¸ªç±»åŠ è½½å™¨ä¸å†å­˜æ´»ï¼Œä¼šå¯¹æ•´ä¸ªå…ƒç©ºé—´è¿›è¡Œé›†ä½“å›æ”¶

> [å‚è€ƒ: Metaspace Architecture](https://stuefe.de/posts/metaspace/metaspace-architecture/)  
> [å‚è€ƒ: What is Compressed Class Space?](https://stuefe.de/posts/metaspace/what-is-compressed-class-space/)  
> [æ·±å…¥ç†è§£å †å¤–å†…å­˜ Metaspace](https://www.javadoop.com/post/metaspace)

[Metaspace è§£å¯†](https://heapdump.cn/article/210111)

-XX:MaxMetaspaceSize æŒ‡å®šå…ƒç©ºé—´çš„æœ€å¤§ç©ºé—´ï¼Œé»˜è®¤å€¼æ˜¯æ— é™ï¼ˆ16EBï¼‰ã€‚
-XX:MetaspaceSize æŒ‡å®šå…ƒç©ºé—´é¦–æ¬¡æ‰©å……çš„å¤§å°ï¼Œé»˜è®¤ä¸º20.75M

ç”±äºMaxMetaspaceSizeæœªæŒ‡å®šæ—¶ï¼Œé»˜è®¤æ— ä¸Šé™ï¼Œæ‰€ä»¥éœ€è¦ç‰¹åˆ«å…³æ³¨å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼Œå¦‚æœç¨‹åºåŠ¨æ€çš„åˆ›å»ºäº†å¾ˆå¤šç±»ï¼Œæˆ–å‡ºç°è¿‡java.lang.OutOfMemoryError:Metaspaceï¼Œå»ºè®®æ˜ç¡®æŒ‡å®š-XX:MaxMetaspaceSizeã€‚  
å¦å¤–Metaspaceå®é™…åˆ†é…çš„å¤§å°æ˜¯éšç€éœ€è¦é€æ­¥æ‰©å¤§çš„ï¼Œ**æ¯æ¬¡æ‰©å¤§éœ€è¦ä¸€æ¬¡FGC**ï¼Œ-XX:MetaspaceSizeé»˜è®¤çš„å€¼æ¯”è¾ƒå°ï¼Œéœ€è¦é¢‘ç¹GCæ‰©å……åˆ°éœ€è¦çš„å¤§å°ã€‚ç±»ä¼¼æ—¥å¿—å¯ä»¥çœ‹åˆ°Metaspaceå¼•èµ·çš„FGCï¼š`[Full GC (Metadata GC Threshold) ...]`

å› æ­¤ä¸ºå‡å°‘é¢„çƒ­å½±å“ï¼Œå¯ä»¥å°†-XX:MetaspaceSizeï¼Œ-XX:MaxMetaspaceSizeæŒ‡å®šæˆç›¸åŒçš„å€¼ã€‚

## ç›´æ¥å†…å­˜
ç›´æ¥å†…å­˜ä¸»è¦æ˜¯JNIã€Deflater/Inflaterã€DirectByteBufferï¼ˆnioä¸­ä¼šç”¨åˆ°ï¼‰ä½¿ç”¨çš„ï¼Œ å½“å‘ç°Javaè¿›ç¨‹å †ä½¿ç”¨ç‡ä¸é«˜ï¼Œä½†æ˜¯è¿›ç¨‹å ç”¨å†…å­˜RSSå¾ˆé«˜ï¼Œå°±è¦æ€€ç–‘è¿™å—åŒºåŸŸäº†

- [Github: æµ‹è¯•ä»£ç ](https://github.com/Kuangcp/JavaBase/blob/master/class/src/test/java/jvm/oom/DirectMemoryOOMTest.java)
- [how to see memory useage of nio buffers](https://stackoverflow.com/questions/2689914/how-to-see-the-memory-usage-of-nio-buffers)

> [å‚è€ƒ: èŠèŠJVM å †å¤–å†…å­˜æ³„éœ²çš„BUGæ˜¯å¦‚ä½•æŸ¥æ‰¾çš„](https://cloud.tencent.com/developer/article/1129904)  
> [JAVAå †å¤–å†…å­˜æ’æŸ¥å°ç»“](https://zhuanlan.zhihu.com/p/60976273)  

- `-XX:MaxDirectMemorySize` é™åˆ¶æœ€å¤§å†…å­˜ï¼Œé»˜è®¤å€¼ä¸ºï¼š MaxHeapSize - Survivorã€‚  `é€šè¿‡å·¥å…·æŸ¥çœ‹çš„è¯ï¼Œå€¼ä¸º0`

- å¯ç”¨NMT: java -XX:NativeMemoryTracking=summary æˆ–è€… detail å¼€é”€æ›´å¤§ä¸€äº›
- æŸ¥çœ‹NMT jcmd $pid VM.native_memory `[detail] å¯¹åº”å¯ç”¨æ—¶è®¾ç½®ï¼Œè¾“å‡ºå…·ä½“å†…å­˜åœ°å€ä¿¡æ¯`

> ç¤ºä¾‹
```sh
Native Memory Tracking:

Total: reserved=10019737KB, committed=997089KB reversedä¿ç•™å†…å­˜ commitedå®é™…æäº¤å†…å­˜
-                 Java Heap (reserved=8222720KB, committed=514048KB)
                            (mmap: reserved=8222720KB, committed=514048KB) 
-                     Class (reserved=1081845KB, committed=34165KB) å­˜å‚¨ç±»å…ƒæ•°æ®ä¿¡æ¯
                            (classes #3085)
                            (malloc=14837KB #3960) 
                            (mmap: reserved=1067008KB, committed=19328KB) 
-                    Thread (reserved=54501KB, committed=54501KB)  çº¿ç¨‹å ç”¨çš„ç©ºé—´ å³54çº¿ç¨‹ 54Mï¼šé»˜è®¤æ ˆä¸º1Méœ€-Xssä¿®æ”¹
                            (thread #54)
                            (stack: reserved=54272KB, committed=54272KB)
                            (malloc=178KB #318) 
                            (arena=52KB #95)
-                      Code (reserved=250763KB, committed=9551KB) JITä»£ç ç¼“å­˜
                            (malloc=1163KB #2588) 
                            (mmap: reserved=249600KB, committed=8388KB) 
-                        GC (reserved=316571KB, committed=291487KB) GCç®—æ³•éœ€è¦çš„å†…å­˜ç©ºé—´
                            (malloc=16151KB #155) 
                            (mmap: reserved=300420KB, committed=275336KB) 
-                  Compiler (reserved=183KB, committed=183KB)
                            (malloc=40KB #208) 
                            (arena=142KB #15)
-                  Internal (reserved=84975KB, committed=84975KB)
                            (malloc=84943KB #16310) 
                            (mmap: reserved=32KB, committed=32KB) 
-                    Symbol (reserved=4984KB, committed=4984KB)
                            (malloc=3633KB #26295) 
                            (arena=1351KB #1)
-    Native Memory Tracking (reserved=982KB, committed=982KB) NMTè‡ªèº«å ç”¨å†…å­˜
                            (malloc=163KB #2304) 
                            (tracking overhead=818KB)
-               Arena Chunk (reserved=2214KB, committed=2214KB)
                            (malloc=2214KB) 
```

**********************

# JVMä¸åŒå®ç°
## Hotspot JVM
åŸå…ˆ SUN å…¬å¸å¼€å‘, ç°ä¸º Oracle JDK ä¸­é»˜è®¤JVM

## OpenJ9
IBMä¸»å¯¼å¼€å‘, æèµ ç»™EclipseåŸºé‡‘ä¼š

> [Officail Site](http://www.eclipse.org/openj9/) | [IBMåŸæ–‡](https://www.ibm.com/support/knowledgecenter/SSYKE2_8.0.0/com.ibm.java.vm.80.doc/docs/j9_intro.html) | [æŠ€æœ¯æ–‡æ¡£](https://eclipse.dev/openj9/docs/)

> [å‚è€ƒ: IBMå¼€æºJVMå®ç°OpenJ9ï¼Œå¹¶æäº¤EclipseåŸºé‡‘ä¼šæ‰˜ç®¡)](http://www.infoq.com/cn/news/2017/09/IBM-JVM-OpenJ9-Eclipse)
> [å‚è€ƒ: Eclipse Open J9ï¼šEclipse OMRé¡¹ç›®æä¾›çš„å¼€æºJVM](http://www.infoq.com/cn/news/2018/03/OMR-OpenJ9)

************************

## GraalVM
> [Official Site](https://www.graalvm.org/)  

> [Doc](https://www.graalvm.org/latest/docs/getting-started/)
- å®‰è£… graalvm `sdk install java 17.0.11-graal`
- è·Ÿéšæ ·ä¾‹ä¸­æ‰§è¡Œ native-image HelloWorldï¼Œ å¯ä»¥å‘ç°ä¼šå æ»¡16æ ¸CPU`AMD 3700x`å’Œ1Gå·¦å³å†…å­˜ï¼Œ20sæ‰å¯ä»¥ç¼–è¯‘å®Œæˆ

> [Accelerating Java performance](https://www.graalvm.org/java/advantages/)`åŸºå‡†æµ‹è¯•å®£ç§°å¿«äºopenjdk8å’Œ11 1.55å€`
> [GraalVM Native Image Support](https://docs.spring.io/spring-boot/docs/current/reference/html/native-image.html)

************************

> [å‚è€ƒ: Oracle å‘å¸ƒå¤šè¯­ç§è™šæ‹Ÿæœºå¹³å° GraalVM 1.0](https://www.infoq.cn/article/2018%2F05%2Foracle-graalvm-v1)  
> [å‚è€ƒ: å…¨æ ˆè™šæ‹ŸæœºGraalVMåˆä½“éªŒ](https://zhuanlan.zhihu.com/p/35849246)  

