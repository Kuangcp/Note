---
title: Javaä¹‹GC
date: 2021-05-14 20:36:48
tags: 
categories: 
---

ğŸ’ 

- 1. [GC](#gc)
    - 1.1. [GCç±»å‹](#gcç±»å‹)
    - 1.2. [GCæœ¯è¯­](#gcæœ¯è¯­)
        - 1.2.1. [STW](#stw)
        - 1.2.2. [å®‰å…¨ç‚¹](#å®‰å…¨ç‚¹)
    - 1.3. [å†…å­˜åˆ†ä»£](#å†…å­˜åˆ†ä»£)
    - 1.4. [åˆ¤æ–­å­˜æ´»ç®—æ³•](#åˆ¤æ–­å­˜æ´»ç®—æ³•)
        - 1.4.1. [å¼•ç”¨è®¡æ•°ç®—æ³•](#å¼•ç”¨è®¡æ•°ç®—æ³•)
        - 1.4.2. [å¯è¾¾æ€§åˆ†æç®—æ³•](#å¯è¾¾æ€§åˆ†æç®—æ³•)
    - 1.5. [GCç®—æ³•](#gcç®—æ³•)
        - 1.5.1. [æ ‡è®°æ¸…é™¤ç®—æ³•](#æ ‡è®°æ¸…é™¤ç®—æ³•)
        - 1.5.2. [å¤åˆ¶ç®—æ³•](#å¤åˆ¶ç®—æ³•)
        - 1.5.3. [æ ‡è®°æ•´ç†ç®—æ³•](#æ ‡è®°æ•´ç†ç®—æ³•)
    - 1.6. [GC Callback](#gc-callback)
- 2. [GCå‚æ•°](#gcå‚æ•°)
- 3. [GCæ—¥å¿—](#gcæ—¥å¿—)
- 4. [åƒåœ¾æ”¶é›†å™¨](#åƒåœ¾æ”¶é›†å™¨)
    - 4.1. [é»˜è®¤åƒåœ¾æ”¶é›†å™¨](#é»˜è®¤åƒåœ¾æ”¶é›†å™¨)
    - 4.2. [Serial](#serial)
    - 4.3. [ParNew](#parnew)
    - 4.4. [Parallel Scavenge](#parallel-scavenge)
    - 4.5. [Serial Old](#serial-old)
    - 4.6. [Parallel Old](#parallel-old)
    - 4.7. [CMS](#cms)
    - 4.8. [G1](#g1)
    - 4.9. [ZGC](#zgc)
    - 4.10. [ShenandoahGC](#shenandoahgc)
    - 4.11. [Epsilon](#epsilon)
- 5. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

ğŸ’  2024-07-12 11:40:30
****************************************
# GC
> Java Garbage Collection

GC çš„ç›®çš„æ˜¯è¯†åˆ«å‡ºä¸å†ä½¿ç”¨çš„å†…å­˜ï¼Œå¹¶å°†å…¶å˜ä¸ºå¯ç”¨å†…å­˜ã€‚ç°ä»£åƒåœ¾æ”¶é›†å™¨é€šå¸¸åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µï¼Œæ ¹æ®ä¸åŒçš„åˆ†ä»£ä½¿ç”¨ä¸åŒçš„åƒåœ¾æ”¶é›†å™¨æ¥å®Œæˆå›æ”¶è¿‡ç¨‹

- [ä½ èƒ½ä¸èƒ½è°ˆè°ˆï¼Œjava GCæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œå¯¹ä»€ä¹ˆä¸œè¥¿ï¼Œåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿâ€ ](http://itindex.net/detail/54188-java-gc-%E4%B8%9C%E8%A5%BF) `ä»€ä¹ˆæ—¶å€™, å¯¹ä»€ä¹ˆä¸œè¥¿, åšäº†ä»€ä¹ˆ`
> ä»€ä¹ˆæ—¶å€™
- ç¨‹åºå‘˜ä¸èƒ½å…·ä½“æ§åˆ¶æ—¶é—´ï¼Œç³»ç»Ÿåœ¨ä¸å¯é¢„æµ‹çš„æ—¶é—´è°ƒç”¨System.gc()å‡½æ•°çš„æ—¶å€™ï¼›å¯ä»¥é€šè¿‡è°ƒå‚æ•°ï¼Œç”¨NewRatio æ§åˆ¶newObjectå’ŒoldObjectçš„æ¯”ä¾‹ï¼Œç”¨MaxTenuringThreshold  æ§åˆ¶ è¿›å…¥oldObjectçš„æ¬¡æ•°ï¼Œä½¿å¾—oldObject å­˜å‚¨ç©ºé—´å»¶è¿Ÿè¾¾åˆ°full gc,å»¶è¿Ÿgcæ—¶é—´   
> å¯¹ä»€ä¹ˆä¸œè¥¿
- è¶…å‡ºäº†ä½œç”¨åŸŸæˆ–å¼•ç”¨è®¡æ•°ä¸ºç©ºçš„å¯¹è±¡ï¼›ä»gc rootå¼€å§‹æœç´¢æ‰¾ä¸åˆ°çš„å¯¹è±¡ï¼Œè€Œä¸”ç»è¿‡ä¸€æ¬¡æ ‡è®°ã€æ¸…ç†ï¼Œä»ç„¶æ²¡æœ‰å¤æ´»çš„å¯¹è±¡ã€‚
> åšäº†ä»€ä¹ˆ
- åˆ é™¤ä¸ä½¿ç”¨çš„å¯¹è±¡ï¼Œå›æ”¶å†…å­˜ç©ºé—´ï¼›è¿è¡Œé»˜è®¤çš„finalize,å½“ç„¶ç¨‹åºå‘˜æƒ³ç«‹åˆ»è°ƒç”¨å°±ç”¨diposeè°ƒç”¨ä»¥é‡Šæ”¾èµ„æºå¦‚æ–‡ä»¶å¥æŸ„ï¼ŒJVMç”¨from survivorã€to survivorå¯¹å®ƒè¿›è¡Œæ ‡è®°æ¸…ç†ï¼Œå¯¹è±¡åºåˆ—åŒ–åä¹Ÿå¯ä»¥ä½¿å®ƒå¤æ´»ã€‚

************************
åˆ—è¡¨ï¼š CMS(JDK14ä¸­è¢«ç§»é™¤)ï¼ŒG1ï¼ŒParallelï¼ŒSerialï¼ŒEpsilonï¼ŒShenandoahï¼ŒZGC
> [Github: OpenJDK 12 GC ç®—æ³•æºç ](https://github.com/openjdk/jdk/tree/jdk-12+33/src/hotspot/share/gc)  
************************

## GCç±»å‹
> [RednaxelaFX](https://www.zhihu.com/question/41922036/answer/93079526) | [Major GCå’ŒFull GCçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿè§¦å‘æ¡ä»¶å‘¢ï¼Ÿ](https://www.zhihu.com/question/41922036/answer/93079526)

- `Partial GC`ï¼šæ”¶é›†éƒ¨åˆ†å †
    - `Young GC`ï¼šåªæ”¶é›†young gençš„GC
    - `Old GC`ï¼šåªæ”¶é›†old gençš„GCã€‚åªæœ‰CMSçš„concurrent collectionæ˜¯è¿™ä¸ªæ¨¡å¼
    - `Mixed GC`ï¼šæ”¶é›†æ•´ä¸ªyoung genä»¥åŠéƒ¨åˆ†old gençš„GCã€‚åªæœ‰G1æœ‰è¿™ä¸ªæ¨¡å¼

- `Full GC`ï¼šæ”¶é›†æ•´ä¸ªå †ï¼ŒåŒ…æ‹¬young genã€old genã€perm genï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ï¼Œmetaspaceç­‰æ‰€æœ‰éƒ¨åˆ†çš„æ¨¡å¼ã€‚
    - gcæ—¥å¿—ä¸­ä¼šæœ‰æ˜ç¡®çš„ `[Full GC]` å­—æ ·

`æ–°ç”Ÿä»£GC Minor GC`  
ä¹Ÿç§° Young GCï¼Œä¼šå¼•å‘STWã€‚å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†åŠ¨ä½œ, å› ä¸ºå¤§å¤šæ•°å¯¹è±¡éƒ½æ˜¯å­˜æ´»æ—¶é—´å¾ˆçŸ­, æ‰€ä»¥ Minor GC éå¸¸é¢‘ç¹, ä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«.   
æ‰«æè¿‡åå°† Eden å’Œ ç°åœ¨ä½¿ç”¨çš„ Survivor ä¸¤ä¸ªåŒºä¸­çš„å­˜æ´»å¯¹è±¡ å…¨æ¬å»ç©ºé—²çš„ Survivor.   
å¦‚æœ å­˜æ´»çš„å¯¹è±¡å†…å­˜å¤§å°å¤§äº Survivor åŒºå¤§å°, åˆ™éœ€è¦`åˆ†é…æ‹…ä¿æœºåˆ¶`æå‰å°†å¯¹è±¡è½¬ç§»åˆ°è€å¹´ä»£ä¸­

`è€å¹´ä»£GC Major GC`  
å‘ç”Ÿåœ¨è€å¹´ä»£çš„GC, å‡ºç°äº† Major GC, å¾€å¾€ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡ Minor GC. Major GC çš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯” Minor GC æ…¢10å€ä»¥ä¸Š.

> [What causes a Full GC to run?](https://stackoverflow.com/questions/42226785/what-causes-a-full-gc-to-run)

> [å‚è€ƒ: Major GCå’ŒFull GCçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ](https://www.zhihu.com/question/41922036)
- HotSpotä¸Šçš„ä¸€æ¬¡ Full GC: é’ˆå¯¹ æ–°ç”Ÿä»£ è€ç”Ÿä»£ å…ƒç©ºé—´ çš„å…¨å±€èŒƒå›´çš„GC, å°†ä¼š STW(Stop The World)

> æœ€ç®€å•çš„åˆ†ä»£å¼GCç­–ç•¥ï¼ŒæŒ‰HotSpot VMçš„serial GCçš„å®ç°æ¥çœ‹ï¼Œè§¦å‘æ¡ä»¶æ˜¯ï¼š
- *Young GC*ï¼šå½“young gen ä¸­çš„ eden gen åˆ†é…æ»¡çš„æ—¶å€™è§¦å‘ã€‚æ³¨æ„young GCä¸­æœ‰éƒ¨åˆ†å­˜æ´»å¯¹è±¡ä¼šæ™‹å‡åˆ°old genï¼Œæ‰€ä»¥young GCåold gençš„å ç”¨é‡é€šå¸¸ä¼šæœ‰æ‰€å‡é«˜ã€‚
- *Full GC*ï¼šå½“å‡†å¤‡è¦è§¦å‘ä¸€æ¬¡young GCæ—¶ï¼Œå¦‚æœå‘ç°ç»Ÿè®¡æ•°æ®è¯´ä¹‹å‰young GCçš„å¹³å‡æ™‹å‡å¤§å°æ¯”ç›®å‰old genå‰©ä½™çš„ç©ºé—´å¤§ï¼Œåˆ™ä¸ä¼šè§¦å‘young GCè€Œæ˜¯è½¬ä¸ºè§¦å‘full GC
    - å› ä¸ºHotSpot VMçš„GCé‡Œï¼Œé™¤äº†CMSçš„concurrent collectionä¹‹å¤–ï¼Œå…¶å®ƒèƒ½æ”¶é›†old gençš„GCéƒ½ä¼šåŒæ—¶æ”¶é›†æ•´ä¸ªGCå †ï¼ŒåŒ…æ‹¬young genï¼Œæ‰€ä»¥ä¸éœ€è¦äº‹å…ˆè§¦å‘ä¸€æ¬¡å•ç‹¬çš„young GC
- `perm gen` / `MetaSpace` å†…å­˜ç©ºé—´ä¸è¶³æ—¶ï¼Œä¹Ÿä¼šè§¦å‘ä¸€æ¬¡ Full GCï¼›
- System.gc()ã€heap dumpã€jcmd pid GC.run ç­‰æŒ‡å®šè§¦å‘GCæ—¶ï¼Œé»˜è®¤è§¦å‘ Full GCã€‚

> é»˜è®¤GC

JDK 7ï¼Œé»˜è®¤æ˜¯ Parallel Scavenge + Serial Oldã€‚
JDK 8 åŠ JDK 7u40 ä¹‹åçš„ç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯ Parallel Scavenge + Parallel Oldã€‚
JDK 9 åˆ° JDK 17ï¼Œé»˜è®¤æ˜¯ G1ã€‚

************************

## GCæœ¯è¯­

- `ä¸²è¡Œï¼ˆSerialï¼‰` åªæœ‰å•ä¸ª GC çº¿ç¨‹åœ¨è¿è¡Œã€‚ä¸ä¸Šé¢çš„å¹¶è¡Œé˜¶æ®µä¸€æ ·ï¼Œè§„èŒƒä¸­ä¹Ÿæ²¡æœ‰è¯´æ˜ GC çº¿ç¨‹æ˜¯å¦å¯ä»¥ä¸å½“å‰è¿è¡Œçš„åº”ç”¨ç¨‹åºçº¿ç¨‹é‡å ã€‚
- `å¹¶è¡Œï¼ˆParallelï¼‰` è¿è¡Œä¸­çš„ JVM åŒ…å«åº”ç”¨ç¨‹åºçº¿ç¨‹å’Œ GC çº¿ç¨‹ã€‚åœ¨å¹¶è¡Œé˜¶æ®µï¼Œä¼šè¿è¡Œå¤šä¸ª GC çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»åŠ¡è¢«æ‹†åˆ†ç»™å®ƒä»¬å»å®Œæˆã€‚
    - è‡³äº GC çº¿ç¨‹æ˜¯å¦å¯ä»¥ä¸æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºçº¿ç¨‹é‡å ï¼Œè¿™ä¸ªåœ¨è§„èŒƒä¸­å¹¶æ²¡æœ‰ç‰¹åˆ«è¯´æ˜ã€‚
- `å¹¶å‘ï¼ˆConcurrentï¼‰` GC çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚
- `å¢é‡ï¼ˆIncrementalï¼‰` åœ¨å¢é‡é˜¶æ®µï¼Œå®ƒå¯ä»¥è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œå¹¶åŸºäºæŸäº›æ¡ä»¶æå‰ç»ˆæ­¢ï¼Œä¾‹å¦‚æ—¶é—´é¢„ç®—æˆ–æ‰§è¡Œæ›´é«˜ä¼˜å…ˆçº§çš„ GC é˜¶æ®µã€‚

- `ååé‡ = è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ / (ç”¨æˆ·ä»£ç æ—¶é—´ + åƒåœ¾æ”¶é›†æ—¶é—´)`
- å¹¶è¡Œå’Œå¹¶å‘ : å¹¶è¡Œï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸CPUæ¥ç¼©çŸ­STWçš„æ—¶é—´, å¹¶å‘ï¼šéƒ¨åˆ†å…¶ä»–æ”¶é›†å™¨éœ€è¦åœé¡¿çš„é€»è¾‘ä¹Ÿå’Œç”¨æˆ·è¿›ç¨‹å¹¶å‘æ‰§è¡Œ

### STW 
> [å‚è€ƒ: JVMä¸­çš„STWå’ŒCMS](https://blog.csdn.net/zkkzpp258/article/details/80080764)  

Javaä¸­Stop-The-Worldæœºåˆ¶ç®€ç§°STWï¼Œæ˜¯åœ¨æ‰§è¡Œåƒåœ¾æ”¶é›†ç®—æ³•æ—¶ï¼ŒJavaåº”ç”¨ç¨‹åºçš„å…¶ä»–æ‰€æœ‰çº¿ç¨‹éƒ½è¢«æŒ‚èµ·ï¼ˆé™¤äº†åƒåœ¾æ”¶é›†å¸®åŠ©å™¨ä¹‹å¤–ï¼‰ã€‚   
Javaä¸­ä¸€ç§å…¨å±€æš‚åœç°è±¡ï¼Œå…¨å±€åœé¡¿ï¼Œæ‰€æœ‰Javaä»£ç åœæ­¢ï¼Œnativeä»£ç å¯ä»¥æ‰§è¡Œï¼Œä½†ä¸èƒ½ä¸JVMäº¤äº’ã€‚è¿™äº›ç°è±¡å¤šåŠæ˜¯ç”±äºGCå¼•èµ·ã€‚

é™¤äº†GCï¼ŒJVMä¸‹è¿˜æœ‰å…¶ä»–åŸå› ä¼šè§¦å‘åœé¡¿ç°è±¡ã€‚[JVM Pauses - It's More Than GC ](https://www.reddit.com/r/java/comments/gsp4p4/jvm_pauses_its_more_than_gc/)

### å®‰å…¨ç‚¹

JVMé‡Œæœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹`VM Threads`ï¼Œä¸“é—¨ç”¨æ¥æ‰§è¡Œä¸€äº›ç‰¹æ®Šçš„VM Operationï¼Œæ¯”å¦‚åˆ†æ´¾GCï¼Œthread dumpç­‰ï¼Œè¿™äº›ä»»åŠ¡ï¼Œéƒ½éœ€è¦æ•´ä¸ªHeapï¼Œä»¥åŠæ‰€æœ‰çº¿ç¨‹çš„çŠ¶æ€æ˜¯é™æ­¢çš„ï¼Œä¸€è‡´çš„æ‰èƒ½è¿›è¡Œã€‚  
æ‰€ä»¥JVMå¼•å…¥äº†å®‰å…¨ç‚¹`Safe Point`çš„æ¦‚å¿µï¼Œåœ¨éœ€è¦è¿›è¡ŒVM Operationæ—¶ï¼Œé€šçŸ¥æ‰€æœ‰çš„çº¿ç¨‹è¿›å…¥ä¸€ä¸ªé™æ­¢çš„å®‰å…¨ç‚¹ã€‚

é™¤äº†GCï¼Œå…¶ä»–è§¦å‘å®‰å…¨ç‚¹çš„VM OperationåŒ…æ‹¬ï¼š
```
    1. JITç›¸å…³ï¼Œæ¯”å¦‚Code deoptimization, Flushing code cache ï¼›
    2. Class redefinition (e.g. javaagentï¼ŒAOPä»£ç æ¤å…¥çš„äº§ç”Ÿçš„instrumentation) ï¼›
    3. Biased lock revocation å–æ¶ˆåå‘é” ï¼›
    4. Various debug operation (e.g. thread dump or deadlock check)ï¼›
```

- é€šè¿‡ç›‘æ§å®‰å…¨ç‚¹ï¼Œçœ‹çœ‹JVMåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ
    - æœ€ç®€å•çš„åšæ³•ï¼Œåœ¨JVMå¯åŠ¨å‚æ•°çš„GCå‚æ•°é‡Œè¿½åŠ : `-XX:+PrintGCApplicationStoppedTime` å®ƒå°±ä¼šæŠŠå…¨éƒ¨çš„JVMåœé¡¿æ—¶é—´ï¼ˆä¸åªæ˜¯GCï¼‰ï¼Œæ‰“å°åœ¨GCæ—¥å¿—é‡Œã€‚
- å¦‚ä½•æ‰“å°å‡ºæ˜¯å“ªç§åŸå› å¯¼è‡´çš„åœé¡¿å‘¢ï¼Ÿ
    - å†å¤šåŠ ä¸¤ä¸ªå‚æ•°ï¼š`-XX:+PrintSafepointStatistics -XX: PrintSafepointStatisticsCount=1`
    - æ­¤æ—¥å¿—åˆ†ä¸¤æ®µï¼Œç¬¬ä¸€æ®µæ˜¯æ—¶é—´æˆ³ï¼ŒVM Operation çš„ç±»å‹ï¼Œä»¥åŠçº¿ç¨‹æ¦‚å†µ
        ```
            total: å®‰å…¨ç‚¹é‡Œçš„æ€»çº¿ç¨‹æ•° 
            initially_running: å®‰å…¨ç‚¹æ—¶å¼€å§‹æ—¶æ­£åœ¨è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹æ•° 
            wait_to_block: åœ¨VM Operationå¼€å§‹å‰éœ€è¦ç­‰å¾…å…¶æš‚åœçš„çº¿ç¨‹æ•°
        ```
    - ç¬¬äºŒè¡Œæ˜¯åˆ°è¾¾å®‰å…¨ç‚¹æ—¶çš„å„ä¸ªé˜¶æ®µä»¥åŠæ‰§è¡Œæ“ä½œæ‰€èŠ±çš„æ—¶é—´ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯vmop
        ```
            spin: ç­‰å¾…çº¿ç¨‹å“åº”
            safepointå·å¬çš„æ—¶é—´ 
            block: æš‚åœæ‰€æœ‰çº¿ç¨‹æ‰€ç”¨çš„æ—¶é—´ 
            sync: ç­‰äº spin+blockï¼Œè¿™æ˜¯ä»å¼€å§‹åˆ°è¿›å…¥å®‰å…¨ç‚¹æ‰€è€—çš„æ—¶é—´ï¼Œå¯ç”¨äºåˆ¤æ–­è¿›å…¥å®‰å…¨ç‚¹è€—æ—¶ 
            cleanup: æ¸…ç†æ‰€ç”¨æ—¶é—´ 
            vmop: çœŸæ­£æ‰§è¡ŒVM Operationçš„æ—¶é—´
        ```

å¯è§ï¼Œé‚£äº›å¾ˆå¤šä½†åˆå¾ˆçŸ­çš„å®‰å…¨ç‚¹ï¼Œå…¨éƒ½æ˜¯RevokeBiasï¼Œè¯¦è§ åå‘é”å®ç°åŸç†ï¼Œ é«˜å¹¶å‘çš„åº”ç”¨ä¸€èˆ¬ä¼šå¹²è„†åœ¨å¯åŠ¨å‚æ•°é‡ŒåŠ ä¸€å¥`-XX:-UseBiasedLocking`å–æ¶ˆæ‰å®ƒã€‚
å¦å¤–è¿˜çœ‹åˆ°æœ‰äº›ç±»å‹æ˜¯no vm operationï¼Œ æ–‡æ¡£ä¸Šè¯´æ˜¯ä¿è¯æ¯ç§’éƒ½æœ‰ä¸€æ¬¡è¿›å…¥å®‰å…¨ç‚¹ï¼ˆå¦‚æœè¿™ç§’å·²ç»GCè¿‡å°±ä¸ç”¨äº†ï¼‰ï¼Œç»™ä¸€äº›éœ€è¦åœ¨å®‰å…¨ç‚¹é‡Œè¿›è¡Œï¼Œåˆéç´§æ€¥çš„æ“ä½œä½¿ç”¨ï¼Œæ¯”å¦‚ä¸€äº›é‡‡æ ·å‹çš„Profilerå·¥å…·ï¼Œå¯ç”¨`-DGuaranteedSafepointInterval`æ¥è°ƒæ•´ï¼Œä¸è¿‡å®é™…çœ‹å®ƒå¹¶ä¸æ˜¯æ¯ç§’éƒ½ä¼šå‘ç”Ÿï¼Œæ—¶é—´ä¸å®šã€‚

åœ¨å®æˆ˜ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨å®‰å…¨ç‚¹æ—¥å¿—ï¼Œå‘ç°è¿‡æœ‰ç¨‹åºå®šæ—¶è°ƒç”¨Thread Dumpç­‰ç­‰æƒ…å†µã€‚ä¸è¿‡å› ä¸ºå®‰å…¨ç‚¹æ—¥å¿—é»˜è®¤è¾“å‡ºåˆ°stdoutï¼Œå› ä¸ºæ€§èƒ½åŠstdoutæ—¥å¿—çš„æ•´æ´æ€§ç­‰åŸå› ï¼Œæˆ‘ä»¬å¹³æ—¶é»˜è®¤æ²¡æœ‰å¼€å¯å®ƒã€‚åªæœ‰åœ¨éœ€è¦æ—¶æ‰æ‰“å¼€ã€‚

å†å†å¢åŠ ä¸‹é¢ä¸‰ä¸ªå‚æ•°ï¼Œå¯ä»¥çŸ¥é“æ›´å¤šVMé‡Œå‘ç”Ÿçš„äº‹æƒ…ã€‚å¯æƒœJVMä¸ä¼šå› ä¸ºè®¾äº†è¿™ä¸‰ä¸ªå‚æ•°ï¼Œå°±æŠŠå®‰å…¨ç‚¹æ—¥å¿—è½¬ç§»åˆ°vm.logé‡Œé¢æ¥ï¼Œè€Œæ˜¯ç™½ç™½æ‰“å°äº†ä¸¤æ¬¡ã€‚

`-XX:+UnlockDiagnosticVMOptions -XX:+LogVMOutput -XX:LogFile=/dev/shm/vm.log`

************************

## å†…å­˜åˆ†ä»£

> [Oracle Java8 Doc: Generation](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/generations.html#sthref16)

![](img/003-jvm-generation-design.drawio.svg)

> [å‚è€ƒ: JVMä¸­æ–°ç”Ÿä»£ä¸ºä»€ä¹ˆè¦æœ‰ä¸¤ä¸ªSurvivorï¼ˆform,toï¼‰ï¼Ÿ](https://www.zhihu.com/question/44929481)  
> [å‚è€ƒ: ä¸ºä»€ä¹ˆæ–°ç”Ÿä»£å†…å­˜éœ€è¦æœ‰ä¸¤ä¸ªSurvivoråŒº](https://blog.csdn.net/antony9118/article/details/51425581)  

> [èŠèŠJVMçš„å¹´è½»ä»£](http://ifeve.com/jvm-yong-generation/)  
> æˆ‘æ˜¯ä¸€ä¸ªæ™®é€šçš„javaå¯¹è±¡ï¼Œæˆ‘å‡ºç”Ÿåœ¨EdenåŒºï¼Œåœ¨EdenåŒºæˆ‘è¿˜çœ‹åˆ°å’Œæˆ‘é•¿çš„å¾ˆåƒçš„å°å…„å¼Ÿï¼Œæˆ‘ä»¬åœ¨EdenåŒºä¸­ç©äº†æŒºé•¿æ—¶é—´ã€‚  
æœ‰ä¸€å¤©EdenåŒºä¸­çš„äººå®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œæˆ‘å°±è¢«è¿«å»äº†SurvivoråŒºçš„â€œFromâ€åŒºï¼Œè‡ªä»å»äº†SurvivoråŒºï¼Œæˆ‘å°±å¼€å§‹æ¼‚äº†ï¼Œ  
æœ‰æ—¶å€™åœ¨Survivorçš„â€œFromâ€åŒºï¼Œæœ‰æ—¶å€™åœ¨Survivorçš„â€œToâ€åŒºï¼Œå±…æ— å®šæ‰€ã€‚  
ç›´åˆ°æˆ‘18å²çš„æ—¶å€™ï¼Œçˆ¸çˆ¸è¯´æˆ‘æˆäººäº†ï¼Œè¯¥å»ç¤¾ä¼šä¸Šé—¯é—¯äº†ã€‚äºæ˜¯æˆ‘å°±å»äº†å¹´è€ä»£é‚£è¾¹ï¼Œå¹´è€ä»£é‡Œï¼Œäººå¾ˆå¤šï¼Œå¹¶ä¸”å¹´é¾„éƒ½æŒºå¤§çš„ï¼Œæˆ‘åœ¨è¿™é‡Œä¹Ÿè®¤è¯†äº†å¾ˆå¤šäººã€‚  
åœ¨å¹´è€ä»£é‡Œï¼Œæˆ‘ç”Ÿæ´»äº†20å¹´(æ¯æ¬¡GCåŠ ä¸€å²)ï¼Œç„¶åè¢«å›æ”¶ã€‚  

## åˆ¤æ–­å­˜æ´»ç®—æ³•
### å¼•ç”¨è®¡æ•°ç®—æ³•
> ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨, æ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨è¯¥å¯¹è±¡å°±åŠ ä¸€, å¼•ç”¨å¤±æ•ˆå°±å‡ä¸€; è®¡æ•°å™¨å€¼ä¸ºé›¶çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½è¢«ä½¿ç”¨çš„å¯¹è±¡

ä½†æ˜¯è¯¥ç®—æ³•æ— æ³•è§£å†³ å¯¹è±¡é—´å¾ªç¯å¼•ç”¨çš„é—®é¢˜, ä¾‹å¦‚ï¼šA å¼•ç”¨ B, B å¼•ç”¨ A, æ­¤æ—¶ä¸¤ä¸ªå¯¹è±¡çš„è®¡æ•°å¤§äº0ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå¯¹è±¡éƒ½æ²¡è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ã€‚

å¯å¼•å…¥ Recyclerç®—æ³• è¿›è¡Œè§£å†³ --ã€Šåƒåœ¾å›æ”¶ç®—æ³•æ‰‹å†Œã€‹

`æ€è·¯å¤§è‡´æ˜¯ æ‰¾å‡ºå¾ªç¯å¼•ç”¨çš„ç¯ï¼Œå°è¯•éå†ï¼ˆå¯èƒ½æœ‰å¤šä¸ªç¯æ··åˆï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªå›¾ç»“æ„ï¼‰å¹¶æ‰“ç ´ç¯å¹¶ç§»é™¤ç¯å†…å¯¹è±¡çš„å†…éƒ¨å¼•ç”¨ï¼Œå¦‚æœè®¡æ•°ä»å¤§äº0è¡¨æ˜è¯¥ç¯æœ‰è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œéœ€è¦æ¢å¤ç ´åçš„å¼•ç”¨å…³ç³»ï¼Œå¦åˆ™å…¨éƒ¨æ¸…é™¤`

### å¯è¾¾æ€§åˆ†æç®—æ³•
å½“ä¸€ä¸ªå¯¹è±¡åˆ° GC Roots å¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶(æˆ–è€…è¯´ä» GC Roots åˆ°è¯¥å¯¹è±¡çš„è·¯å¾„ä¸å¯è¾¾), åˆ™è¯æ˜è¯¥å¯¹è±¡æ˜¯å¯å›æ”¶çš„

GC Roots å¯¹è±¡åŒ…å«:
- è™šæ‹Ÿæœºæ ˆ(æ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨)ä¸­å¼•ç”¨çš„å¯¹è±¡
- æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡
- æ–¹æ³•å»ä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡
- æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNI (Native æ–¹æ³•) å¼•ç”¨çš„å¯¹è±¡
- æ‰€æœ‰çº¿ç¨‹å¯¹è±¡
- ç³»ç»Ÿç±»åŠ è½½å™¨åŠè‡ªå®šä¹‰ç±»åŠ è½½å™¨
- é”å¯¹è±¡

> [Guide to Garbage Collector Roots](https://www.baeldung.com/java-gc-roots)`é‡ç‚¹ï¼šæ¯ä¸ªJVMå®ç°åŠGCå®ç°æ²¡æœ‰å¼ºåˆ¶çš„è§„èŒƒï¼Œåªèƒ½é€šè¿‡MATç­‰å·¥å…·åˆ†æï¼Œä»¥ä¸Šä»…ä¸ºå¸¸è§çš„Rootç±»å‹å¯¹è±¡`

************************

## GCç®—æ³•
### æ ‡è®°æ¸…é™¤ç®—æ³•
> Mark-Sweep é¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡, åœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶

 å›æ”¶è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µä¸ºè¿½è¸ªï¼ˆTracingï¼‰é˜¶æ®µï¼Œå³ä» GC Root å¼€å§‹éå†å¯¹è±¡å›¾ï¼Œå¹¶æ ‡è®°ï¼ˆMarkï¼‰æ‰€é‡åˆ°çš„æ¯ä¸ªå¯¹è±¡ï¼Œç¬¬äºŒé˜¶æ®µä¸ºæ¸…é™¤ï¼ˆSweepï¼‰é˜¶æ®µï¼Œå³å›æ”¶å™¨æ£€æŸ¥å †ä¸­æ¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å°†æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸ä¼šå‘ç”Ÿå¯¹è±¡ç§»åŠ¨ã€‚æ•´ä¸ªç®—æ³•åœ¨ä¸åŒçš„å®ç°ä¸­ä¼šä½¿ç”¨ä¸‰è‰²æŠ½è±¡ï¼ˆTricolour Abstractionï¼‰ã€ä½å›¾æ ‡è®°ï¼ˆBitMapï¼‰ç­‰æŠ€æœ¯æ¥æé«˜ç®—æ³•çš„æ•ˆç‡ï¼Œå­˜æ´»å¯¹è±¡è¾ƒå¤šæ—¶è¾ƒé«˜æ•ˆã€‚

`ç¼ºç‚¹`
1. æ•ˆç‡é—®é¢˜: æ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªè¿‡ç¨‹çš„æ•ˆç‡ä¸é«˜
1. ç©ºé—´é—®é¢˜: å®¹æ˜“å¼•èµ·å†…å­˜ç¢ç‰‡åŒ–é—®é¢˜, ç¢ç‰‡å¤ªå¤šå¯èƒ½å¯¼è‡´åæœŸéœ€è¦åˆ†é…è¾ƒå¤§å¯¹è±¡æ—¶æ‰¾ä¸åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜
    - å¹¶å› æ­¤è§¦å‘ä¸€æ¬¡åƒåœ¾æ”¶é›†åŠ¨ä½œ

### å¤åˆ¶ç®—æ³•
> Copying å°†å†…å­˜æŒ‰å®¹é‡åˆ’åˆ†ä¸ºç­‰å¤§çš„ä¸¤å—, æ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—, å½“è¿™å—çš„å†…å­˜ç”¨åˆ°éœ€è¦å›æ”¶äº†, å°±å°†éœ€è¦å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ä¸Šå», å°†è¯¥å—å…¨éƒ¨æ¸…ç†æ‰  
> è½¬è€Œåªä½¿ç”¨å¦ä¸€ä¸ªå— è¿™æ ·å°±ä¸ä¼šæœ‰å†…å­˜ç¢ç‰‡åŒ–é—®é¢˜, ä½†æ˜¯å¯ä½¿ç”¨çš„å†…å­˜åªæœ‰åŸæ¥çš„ä¸€åŠ

å°†ç©ºé—´åˆ†ä¸ºä¸¤ä¸ªå¤§å°ç›¸åŒçš„ From å’Œ To ä¸¤ä¸ªåŠåŒºï¼ŒåŒä¸€æ—¶é—´åªä¼šä½¿ç”¨å…¶ä¸­ä¸€ä¸ªï¼Œæ¯æ¬¡è¿›è¡Œå›æ”¶æ—¶å°†ä¸€ä¸ªåŠåŒºçš„å­˜æ´»å¯¹è±¡é€šè¿‡å¤åˆ¶çš„æ–¹å¼è½¬ç§»åˆ°å¦ä¸€ä¸ªåŠåŒºã€‚æœ‰é€’å½’ï¼ˆRobert R. Fenichel å’Œ Jerome C. Yochelsonæå‡ºï¼‰å’Œè¿­ä»£ï¼ˆCheney æå‡ºï¼‰ç®—æ³•ï¼Œä»¥åŠè§£å†³äº†å‰ä¸¤è€…é€’å½’æ ˆã€ç¼“å­˜è¡Œç­‰é—®é¢˜çš„è¿‘ä¼¼ä¼˜å…ˆæœç´¢ç®—æ³•ã€‚å¤åˆ¶ç®—æ³•å¯ä»¥é€šè¿‡ç¢°æ’æŒ‡é’ˆçš„æ–¹å¼è¿›è¡Œå¿«é€Ÿåœ°åˆ†é…å†…å­˜ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ç€ç©ºé—´åˆ©ç”¨ç‡ä¸é«˜çš„ç¼ºç‚¹ï¼Œå¦å¤–å°±æ˜¯å­˜æ´»å¯¹è±¡æ¯”è¾ƒå¤§æ—¶å¤åˆ¶çš„æˆæœ¬æ¯”è¾ƒé«˜ã€‚

é€‚ç”¨äºæ–°ç”Ÿä»£, å› ä¸ºæ–°ç”Ÿä»£å¯¹è±¡å¤§éƒ¨åˆ†æ˜¯å­˜æ´»æ—¶é—´çŸ­çš„

æ ‡è®°-å¤åˆ¶ç®—æ³•å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

æ ‡è®°é˜¶æ®µï¼Œå³ä»GC Rootsé›†åˆå¼€å§‹ï¼Œæ ‡è®°æ´»è·ƒå¯¹è±¡ï¼›
è½¬ç§»é˜¶æ®µï¼Œå³æŠŠæ´»è·ƒå¯¹è±¡å¤åˆ¶åˆ°æ–°çš„å†…å­˜åœ°å€ä¸Šï¼›
é‡å®šä½é˜¶æ®µï¼Œå› ä¸ºè½¬ç§»å¯¼è‡´å¯¹è±¡çš„åœ°å€å‘ç”Ÿäº†å˜åŒ–ï¼Œåœ¨é‡å®šä½é˜¶æ®µï¼Œæ‰€æœ‰æŒ‡å‘å¯¹è±¡æ—§åœ°å€çš„æŒ‡é’ˆéƒ½è¦è°ƒæ•´åˆ°å¯¹è±¡æ–°çš„åœ°å€ä¸Šã€‚

### æ ‡è®°æ•´ç†ç®—æ³•
> Mark-Compact æ ‡è®°è¿‡ç¨‹å’Œæ ‡è®°æ¸…é™¤ç®—æ³•æ˜¯ä¸€è‡´çš„, ä½†æ˜¯åç»­æ˜¯è®©å­˜æ´»çš„å¯¹è±¡å¾€ä¸€ç«¯ç§»åŠ¨, æ¸…ç†æ‰ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜.

è¿™ä¸ªç®—æ³•çš„ä¸»è¦ç›®çš„å°±æ˜¯è§£å†³åœ¨éç§»åŠ¨å¼å›æ”¶å™¨ä¸­éƒ½ä¼šå­˜åœ¨çš„ç¢ç‰‡åŒ–é—®é¢˜ï¼Œä¹Ÿåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µä¸ Mark-Sweep ç±»ä¼¼ï¼Œç¬¬äºŒé˜¶æ®µåˆ™ä¼šå¯¹å­˜æ´»å¯¹è±¡æŒ‰ç…§æ•´ç†é¡ºåºï¼ˆCompaction Orderï¼‰è¿›è¡Œæ•´ç†ã€‚ä¸»è¦å®ç°æœ‰åŒæŒ‡é’ˆï¼ˆTwo-Fingerï¼‰å›æ”¶ç®—æ³•ã€æ»‘åŠ¨å›æ”¶ï¼ˆLisp2ï¼‰ç®—æ³•å’Œå¼•çº¿æ•´ç†ï¼ˆThreaded Compactionï¼‰ç®—æ³•ç­‰ã€‚

é€‚ç”¨äºè€å¹´ä»£

************************

## GC Callback
> [Letting the Garbage Collector Do Callbacks](https://dzone.com/articles/letting-garbage-collector-do-c)  
> [Garbage Collection JMX Notifications](http://www.fasterj.com/articles/gcnotifs.shtml)

************************
# GCå‚æ•°
- `-Xloggc:/app/logs/gc_%t_%p.log` æŒ‡å®šGCæ—¥å¿— å¹¶ è®¾ç½®æ–‡ä»¶æ ¼å¼ **æ³¨æ„ç›®å½•è¦å·²å­˜åœ¨**
    - %t æ—¥æœŸæ—¶é—´
    - %p è¿›ç¨‹å·
- `-verbose:gc`
- `-XX:+PrintGCDetails`
- `-XX:+PrintGCDateStamps`
- `-XX:+UseGCLogFileRotation `
- `-XX:NumberOfGCLogFiles=< number of log files > `
- `-XX:GCLogFileSize=< file size >[ unit ]`
- `-XX:MaxTenuringThreshold=15` å¹´è½»ä»£å¯¹è±¡æ™‹å‡å¹´é¾„é˜ˆå€¼ é»˜è®¤å€¼15

************************

# GCæ—¥å¿—
1. é»˜è®¤ç¬¬ä¸€åˆ—æ˜¯**JVMå¯åŠ¨çš„ç§’æ•°**ï¼Œä¸ºäº†å¯è¯»æ€§ä¸€èˆ¬ä¼šåŠ é…ç½® `-XX:+PrintGCDateStamps`, 
1. è·¯å¾„å¯è¿½åŠ è¿›ç¨‹id `-Xloggc:/apps/logs/gc-%p.log` ä»¥åŠ `%t` JVMå¯åŠ¨æ—¶é—´
1. æ—¥å¿—æ»šåŠ¨ç­–ç•¥ `-XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=14 -XX:GCLogFileSize=100M` **ä½†æ˜¯å®é™…ä¸Šä¸å®ç”¨**ï¼Œå¹¶éæŒ‰Logbackç­‰æ¡†æ¶çš„æ€è·¯æ»šåŠ¨ã€‚é‡å¯åä¼šé‡æ–°ä»0è®¡æ•°è¦†ç›–æ‰æœ€æ—§çš„gcæ—¥å¿— [Try to Avoid -XX:+UseGCLogFileRotation](https://dzone.com/articles/try-to-avoid-xxusegclogfilerotation)

> [Github: GCViewer](https://github.com/chewiebug/GCViewer)  
> [GCViewçº¿æ¡å›¾è§£](https://blog.csdn.net/chy2z/article/details/88651810)  

************************

# åƒåœ¾æ”¶é›†å™¨
> JVMåƒåœ¾æ”¶é›†å™¨å‘å±•å†ç¨‹ 

- ç¬¬ä¸€é˜¶æ®µï¼ŒSerialï¼ˆä¸²è¡Œï¼‰æ”¶é›†å™¨
    - åœ¨jdk1.3.1ä¹‹å‰ï¼Œjavaè™šæ‹Ÿæœºä»…ä»…èƒ½ä½¿ç”¨Serialæ”¶é›†å™¨ã€‚ Serialæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œä½†å®ƒçš„â€œå•çº¿ç¨‹â€çš„æ„ä¹‰å¹¶ä¸ä»…ä»…æ˜¯è¯´æ˜å®ƒåªä¼šä½¿ç”¨ä¸€ä¸ªCPUæˆ–ä¸€æ¡æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯åœ¨å®ƒè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚
- ç¬¬äºŒé˜¶æ®µï¼ŒParallelï¼ˆå¹¶è¡Œï¼‰æ”¶é›†å™¨
    - Parallelæ”¶é›†å™¨ä¹Ÿç§°ååé‡æ”¶é›†å™¨ï¼Œç›¸æ¯”Serialæ”¶é›†å™¨ï¼ŒParallelæœ€ä¸»è¦çš„ä¼˜åŠ¿åœ¨äºä½¿ç”¨å¤šçº¿ç¨‹å»å®Œæˆåƒåœ¾æ¸…ç†å·¥ä½œï¼Œè¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸çš„ç‰¹æ€§ï¼Œå¤§å¹…é™ä½gcæ—¶é—´ã€‚
- ç¬¬ä¸‰é˜¶æ®µï¼ŒCMSï¼ˆå¹¶å‘ï¼‰æ”¶é›†å™¨
    - CMSæ”¶é›†å™¨åœ¨Minor GCæ—¶ä¼šæš‚åœæ‰€æœ‰çš„åº”ç”¨çº¿ç¨‹ï¼Œå¹¶ä»¥å¤šçº¿ç¨‹çš„æ–¹å¼è¿›è¡Œåƒåœ¾å›æ”¶ã€‚åœ¨Full GCæ—¶ä¸å†æš‚åœåº”ç”¨çº¿ç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨è‹¥å¹²ä¸ªåå°çº¿ç¨‹å®šæœŸçš„å¯¹è€å¹´ä»£ç©ºé—´è¿›è¡Œæ‰«æï¼ŒåŠæ—¶å›æ”¶å…¶ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚
- ç¬¬å››é˜¶æ®µï¼ŒG1ï¼ˆå¹¶å‘ï¼‰æ”¶é›†å™¨
    - G1æ”¶é›†å™¨ï¼ˆæˆ–è€…åƒåœ¾ä¼˜å…ˆæ”¶é›†å™¨ï¼‰çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†å°½é‡ç¼©çŸ­å¤„ç†è¶…å¤§å †ï¼ˆå¤§äº4GBï¼‰æ—¶äº§ç”Ÿçš„åœé¡¿ã€‚ç›¸å¯¹äºCMSçš„ä¼˜åŠ¿è€Œè¨€æ˜¯å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿç‡å¤§å¤§é™ä½ã€‚

> `java -XX:+PrintCommandLineFlags -version` å¯ä»¥é€šè¿‡è¯¥å‘½ä»¤å¿«é€ŸçŸ¥é“å½“å‰ç‰ˆæœ¬JDKé»˜è®¤åƒåœ¾æ”¶é›†å™¨

*******************

> JVMåƒåœ¾æ”¶é›†å™¨ç§ç±»

æ ¹æ®è®¾è®¡, å¾€å¾€æ˜¯æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä½¿ç”¨ä¸åŒçš„åƒåœ¾æ”¶é›†å™¨å¹¶ç»„åˆä½¿ç”¨, å› ä¸ºå„åˆ†ä»£çš„å¯¹è±¡åˆ†é…å’Œé‡Šæ”¾ç‰¹æ€§ä¸åŒ  

> æ–°ç”Ÿä»£  

| ç±»å‹ | è¯´æ˜ |
|:----|:----|
| Serial (ç¬¬ä¸€ä»£)            | å•çº¿ç¨‹STW å¤åˆ¶ç®—æ³• |
| PraNew (ç¬¬äºŒä»£)            | å¤šçº¿ç¨‹å¹¶è¡ŒSTW å¤åˆ¶ç®—æ³•|
| Parallel Scavenge (ç¬¬ä¸‰ä»£) | å¤šçº¿ç¨‹å¹¶è¡ŒSTW ååé‡ä¼˜åŒ–ï¼Œå¤åˆ¶ç®—æ³•|
| G1 (ç¬¬å››ä»£)            | å¤šçº¿ç¨‹å¹¶å‘ï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶STWæ—¶é—´ï¼Œæ•´ç†ç®—æ³• |

> è€å¹´ä»£

| ç±»å‹ | è¯´æ˜ |
|:----|:----|
| Serial Old (ç¬¬ä¸€ä»£) | |
| Parallel Old (ç¬¬äºŒä»£) | |
| CMS (ç¬¬ä¸‰ä»£) | |
| G1 (ç¬¬å››ä»£) | |
| ZGC/ShenandoahGC | | 

> æ”¶é›†å™¨æ­é…æ—¶çš„é™åˆ¶æ¡ä»¶: 
- CMS ä¸èƒ½å’Œ Parallel Scavenge ä¸€èµ·ç”¨
- Parallel Old åªèƒ½å’Œ Parallel Scavenge ä¸€èµ·ç”¨
- G1 ZGC ShenandoahGC åªèƒ½å•ç‹¬ä½¿ç”¨(ç‹¬è‡ªå¤„ç†æ–°ç”Ÿä»£å’Œè€å¹´ä»£)

************************

## é»˜è®¤åƒåœ¾æ”¶é›†å™¨
- `-XX:+PrintCommandLineFlags` æˆ–è€…æŸ¥çœ‹GCæ—¥å¿—ä¸­ä»£çš„åç§° `-XX:+PrintGCDetails`
- JDK 1.7 1.8 é»˜è®¤åƒåœ¾æ”¶é›†å™¨Parallel Scavengeï¼ˆæ–°ç”Ÿä»£ï¼‰+Parallel Oldï¼ˆè€å¹´ä»£ï¼‰
- JDK1.9+ é»˜è®¤åƒåœ¾æ”¶é›†å™¨G1

************************

## Serial
> å•çº¿ç¨‹åƒåœ¾æ”¶é›†å™¨ JDK1.3.1ä¹‹å‰å”¯ä¸€é€‰æ‹©, ä»…ç”¨äºæ–°ç”Ÿä»£

å•çº¿ç¨‹çš„æ”¶é›†å™¨, é‡‡ç”¨å¤åˆ¶ç®—æ³•, clientæ¨¡å¼ä¸‹é»˜è®¤æ”¶é›†å™¨, å› ä¸ºclientçš„å†…å­˜ä¸€èˆ¬ä¸ä¼šå¾ˆå¤§, å•çº¿ç¨‹åè€Œæ•ˆç‡æ›´é«˜, STWçš„æ—¶é—´ä¹Ÿä¸ä¼šå¾ˆé•¿

************************

## ParNew
> Serial æ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬, ä»…ç”¨äºæ–°ç”Ÿä»£

ä»…æœ‰è¯¥æ”¶é›†å™¨å’ŒSerialæ”¶é›†å™¨èƒ½å’ŒCMSæ”¶é›†å™¨ä¸€èµ·ä½¿ç”¨, å½“ä½¿ç”¨CMSçš„æ—¶å€™é»˜è®¤æ–°ç”Ÿä»£ä½¿ç”¨ParNew

> æ³¨: å•æ ¸æœåŠ¡å™¨æ—¶, è¯¥æ”¶é›†å™¨æ€§èƒ½å¿…ç„¶æ¯”Serialå·®, å› ä¸ºçº¿ç¨‹è°ƒåº¦å¼€é”€

************************

## Parallel Scavenge
> å¹¶è¡Œå¤šçº¿ç¨‹æ”¶é›†å™¨, åŒæ ·ä½¿ç”¨æ ‡è®°å¤åˆ¶ç®—æ³• ç€é‡ç‚¹æ˜¯å¯æ§åˆ¶çš„ååé‡, å¯ä»¥é«˜æ•ˆç‡åˆ©ç”¨CPUæ—¶é—´, ä»…ç”¨äºæ–°ç”Ÿä»£

`-XX:+UseParallelGC`

- æ§åˆ¶æœ€å¤§åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´ `-XX:MaxGCPauseMillis` (å¤§äº0çš„æ•´æ•° å•ä½millis)
    - è¯¥å€¼å¹¶ä¸æ˜¯è¶Šå°è¶Šå¥½, GCåœé¡¿æ—¶é—´ç¼©çŸ­æ˜¯ç‰ºç‰²ååé‡å’Œæ–°ç”Ÿä»£ç©ºé—´æ¥æ¢å–çš„ 
    - æ–°ç”Ÿä»£ç©ºé—´è¶Šå°åˆ™åƒåœ¾æ”¶é›†å™¨å›æ”¶æ—¶é—´åˆ™æ›´çŸ­, ä½†æ˜¯ä¹Ÿæ›´é¢‘ç¹, åœé¡¿æ—¶é—´é™ä¸‹æ¥äº†,ä½†æ˜¯ååé‡å°±ä¸‹é™äº†
- ç›´æ¥è®¾ç½®ååé‡å¤§å° `-XX:GCTimeRatio` å€¼èŒƒå›´ï¼š(0,100)
    - æ”¶é›†å™¨å°†å°½å¯èƒ½ä¿è¯å†…å­˜å›æ”¶çš„æ—¶é—´ä¸è¶…è¿‡è®¾ç½®å€¼, å€¼ä¸ºåƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ç‡, ç›¸å½“äºååé‡çš„å€’æ•°
    - å¦‚æœè®¾ç½®ä¸º 49 åˆ™å…è®¸çš„æœ€å¤§GCæ—¶é—´å æ€»æ—¶é—´çš„ 1/(1+49)
- GCè‡ªé€‚åº”ç­–ç•¥ `-XX:+UseAdaptiveSizePolicy`
    - è¯¥å‚æ•°å¯ç”¨å, å°±æ— éœ€æ‰‹åŠ¨è®¾ç½®æ–°ç”Ÿä»£çš„å¤§å°(-Xmn)å’ŒEdenå’ŒSurvivorçš„æ¯”ä¾‹(-XX:SurvivorRatio) æ™‹å‡è€å¹´ä»£å¯¹è±¡å¤§å°(-XX:PretenureSizeThreshold) , è™šæ‹Ÿæœºå°†åŠ¨æ€è°ƒæ•´è¿™äº›å‚æ•°

************************

## Serial Old
> Serialæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬, å•çº¿ç¨‹æ”¶é›†å™¨ 

ä¸»è¦ç”¨äº client æ¨¡å¼ä¸‹ , server æ¨¡å¼ä¸‹çš„è¯ï¼Œ 1.5ä¹‹å‰çš„ç‰ˆæœ¬ä¸Parallel Scavengeæ­é…ä½¿ç”¨, æˆ–è€…ä½œä¸ºCMSçš„å¤‡é€‰æ–¹æ¡ˆ

************************

## Parallel Old
> æ˜¯Parallel Scavenge æ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬

`-XX:+UseParallelOldGC`

************************

## CMS
> Concurrent Mark Sweep ç€é‡ç‚¹æ˜¯å°½å¯èƒ½ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ [Oracle Doc](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html)

`-XX:+UseConcMarkSweepGC`

å·¥ä½œæµç¨‹ï¼š
1. `åˆå§‹æ ‡è®°` CMS initial mark  **STW**
1. å¹¶å‘æ ‡è®° CMS concurrent mark
1. `æœ€ç»ˆæ ‡è®°` CMS final remark  **STW**
1. å¹¶å‘æ¸…é™¤ CMS concurrent sweep

> ä¾‹å¦‚ï¼š
```log
4936.782: [GC (CMS Initial Mark) [1 CMS-initial-mark: 747140K(1494272K)] 752384K(1800960K), 0.0043788 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
4936.787: [CMS-concurrent-mark-start]
4936.942: [CMS-concurrent-mark: 0.156/0.156 secs] [Times: user=0.23 sys=0.01, real=0.16 secs] 
4936.942: [CMS-concurrent-preclean-start]
4936.948: [CMS-concurrent-preclean: 0.005/0.005 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
4936.948: [CMS-concurrent-abortable-preclean-start]
4938.832: [GC (Allocation Failure) 2020-11-23T17:06:01.905+0800: 4938.832: [ParNew: 277821K->4257K(306688K), 0.0088608 secs] 1024961K->751463K(1800960K), 0.0089994 secs] [Times: user=
4939.249: [CMS-concurrent-abortable-preclean: 0.774/2.301 secs] [Times: user=1.32 sys=0.09, real=2.31 secs] 
4939.250: [GC (CMS Final Remark) [YG occupancy: 142153 K (306688 K)]2020-11-23T17:06:02.323+0800: 4939.250: [Rescan (parallel) , 0.0225236 secs]2020-11-23T17:06:02.346+0800: 4939.273:
4939.382: [CMS-concurrent-sweep-start]
4939.627: [CMS-concurrent-sweep: 0.235/0.245 secs] [Times: user=0.43 sys=0.03, real=0.24 secs] 
4939.627: [CMS-concurrent-reset-start]
4939.631: [CMS-concurrent-reset: 0.004/0.004 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]
```

ä¼˜ç‚¹: å¹¶å‘ä½åœé¡¿  
ç¼ºç‚¹:  
1. å› ä¸ºä¼šå’Œç”¨æˆ·è¿›ç¨‹æŠ¢å CPUèµ„æº, ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢, é€ æˆæ€»ååé‡çš„ä¸‹é™. é»˜è®¤å¯åŠ¨çš„çº¿ç¨‹æ•°ä¸º (CPUæ•°é‡+3)/4
1. æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾, å¯èƒ½å‡ºç° Concurrent Mode Failure ä»è€Œå¼•èµ·æ–°ä¸€æ¬¡FullGC
    - å¹¶å‘æ¸…ç†é˜¶æ®µç”¨æˆ·çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œè¿™æ®µæ—¶é—´å°±å¯èƒ½äº§ç”Ÿæ–°çš„åƒåœ¾ï¼Œæ–°çš„åƒåœ¾åœ¨æ­¤æ¬¡GCæ— æ³•æ¸…é™¤ï¼Œåªèƒ½ç­‰åˆ°ä¸‹æ¬¡æ¸…ç†
1. ç”±äºä½¿ç”¨çš„æ˜¯æ ‡è®°æ¸…é™¤ç®—æ³•, å®¹æ˜“å¯¼è‡´å¤§é‡ç©ºé—´ç¢ç‰‡, è¿™æ ·çš„åæœæ˜¯åˆ†é…å¤§å†…å­˜å¯¹è±¡ä¼šå¾ˆéº»çƒ¦, å¾€å¾€å‡ºç°è€å¹´ä»£æ€»ç©ºé—´è¿˜æœ‰å¤§é‡å‰©ä½™, ä½†æ˜¯æ²¡æœ‰è¶³å¤Ÿå¤§çš„è¿ç»­ç©ºé—´
    - ä¸ºäº†è§£å†³è¯¥é—®é¢˜, æä¾›äº†å‚æ•° `-XX:+UseCMSCompactAtFullCollection` é»˜è®¤å¼€å¯, ç”¨äºåœ¨FullGCæ—¶è¿›è¡Œå†…å­˜ç¢ç‰‡çš„åˆå¹¶, è¯¥è¿‡ç¨‹æ— æ³•å¹¶å‘è¿˜æ˜¯è¦ STW
    - è¿˜æœ‰ä¸€ä¸ªå‚æ•° `-XX:CMSFullGCsBeforeCompaction` é»˜è®¤ä¸º0, è®¾ç½®å¤šå°‘æ¬¡ä¸å‹ç¼©çš„FullGCåè¿›è¡Œä¸€æ¬¡å‹ç¼©çš„FullGC(å†…å­˜åˆå¹¶çš„FullGC)

CMS åƒåœ¾æ”¶é›†å™¨çš„å¦ä¸€ä¸ªæŒ‘æˆ˜æ˜¯å¦‚ä½•å¤„ç†è€å¹´ä»£ä¸­çš„ç©ºé—´ç¢ç‰‡ï¼Œä¹Ÿå°±æ˜¯å½“è€å¹´ä»£ä¸­å¯¹è±¡é—´çš„ç©ºé—´ç¢ç‰‡å¤ªå°ï¼Œä»¥è‡³äºæ— æ³•å®¹çº³ä»å¹´è½»ä»£æ™‹å‡ä¸Šæ¥çš„å¯¹è±¡ï¼Œå› ä¸ºåœ¨CMS çš„å¹¶å‘æ”¶é›†å¾ªç¯ä¸­å¹¶ä¸æ‰§è¡Œå‹ç¼©ï¼Œå“ªæ€•æ˜¯å¢é‡æˆ–å±€éƒ¨å‹ç¼©ã€‚
ä¸€æ—¦æ— æ³•æ‰¾åˆ°å¯ç”¨ç©ºé—´ï¼Œå°±ä¼šä½¿CMS å›è¿‡æ¥ä½¿ç”¨**Serial Old**ï¼Œè§¦å‘ä¸€æ¬¡fullæ”¶é›†ï¼Œå¯¼è‡´ä¸€ä¸ªæ¼«é•¿çš„æš‚åœã€‚ä¼´éšCMS ç¢ç‰‡çš„å¦ä¸€ä¸ªå¾ˆä¸å¹¸çš„æŒ‘æˆ˜å°±æ˜¯ä¸Šè¿°é—®é¢˜å®Œå…¨æ— æ³•é¢„æµ‹ã€‚åŒæ ·éƒ½æ˜¯è€å¹´ä»£ç¢ç‰‡ï¼ŒæŸäº›åº”ç”¨å¯èƒ½æ²¡æœ‰ç»å†è¿‡ä¸€æ¬¡ full GCï¼Œè€Œæœ‰äº›å¯èƒ½æ—¶ä¸æ—¶å°±è¦ç»å†ä¸€æ¬¡ã€‚  

å…¶ä¸­ åˆå§‹æ ‡è®° å’Œ é‡æ–°æ ‡è®° ä»ç„¶éœ€è¦ STW, ä¸¤ä¸ªå¹¶å‘çš„è¿‡ç¨‹æ˜¯å’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„å¯¹ååé‡æœ‰ä¸€å®šå½±å“  
ä¸”ç”±äºæ˜¯å¹¶å‘æ‰§è¡Œçš„, é‚£ä¹ˆå¹¶å‘çš„ä¸¤ä¸ªé˜¶æ®µç”¨æˆ·è¿›ç¨‹æ˜¯éœ€è¦æ‰§è¡Œçš„, å°±éœ€è¦ç»™è¿™äº›çº¿ç¨‹é¢„ç•™è¶³å¤Ÿçš„å†…å­˜ç©ºé—´, é»˜è®¤è§¦å‘GCçš„é˜ˆå€¼æ˜¯ è€å¹´ä»£ä½¿ç”¨äº†68%å(1.5) 1.6æ˜¯92%   
å¯é€šè¿‡ `-XXCMSInitiatingOccupancyFraction` è¿›è¡Œè®¾ç½®. å¦‚æœCMSæ‰§è¡ŒæœŸé—´å‘ç°å‰©ä½™å†…å­˜ä¸è¶³ä»¥è®©ç¨‹åºæ­£å¸¸è¿è¡Œ, å°±ä¼šä¸´æ—¶å¯ç”¨ **Serial Old**  
æ‰€ä»¥è¯¥å‚æ•°ä¸å¯è®¾ç½®è¿‡é«˜, å¦åˆ™å®¹æ˜“å¯¼è‡´é¢‘ç¹é‡‡ç”¨ **Serial Old**, å¤§å¤§å»¶é•¿ STW æ—¶é—´  

> [å‚è€ƒ: JVM æºç è§£è¯»ä¹‹ CMS GC è§¦å‘æ¡ä»¶ ](https://club.perfma.com/article/190389)  
> [å‚è€ƒ: JVM æºç è§£è¯»ä¹‹ CMS ä½•æ—¶ä¼šè¿›è¡Œ Full GC](https://club.perfma.com/article/244846)  

CMSè¿›å…¥ full GC çš„æƒ…å†µæ˜¯å¹¶å‘æ”¶é›†æ¨¡å¼è·Ÿä¸ä¸Šåº”ç”¨åˆ†é…å†…å­˜çš„é€Ÿåº¦äº†ï¼Œæˆ–è€…æ˜¯ç¢ç‰‡åŒ–å¼€å§‹å˜ä¸¥é‡äº†ã€‚  
ä¸»è¦ä½“ç°æ˜¯GCæ—¥å¿—é‡Œå¯ä»¥çœ‹åˆ° concurrent mode failure å­—æ ·ï¼Œç„¶åå°±å¼€å§‹å¯ä»¥çœ‹åˆ° `[Full GC ... ]` çš„æ—¥å¿—äº†  
è¿™æ ·å°±å¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœCMSå¹¶å‘GCå‘ç”Ÿäº†ï¼Œæ­¤æ—¶æ˜¯æ— æ³•åˆ©ç”¨ `-XX:+HeapDumpBeforeFullGC` å‚æ•°ç”Ÿæˆdumpæ–‡ä»¶ï¼Œå› ä¸ºä¸æ˜¯å‘ç”Ÿ FullGC  

## G1
> Garbage First é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„åƒåœ¾æ”¶é›†å™¨, JDK7å‘å¸ƒ, JDK9ä½œä¸ºé»˜è®¤GC [Oracle Doc](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/g1_gc.html#garbage_first_garbage_collection)

`-XX:+UseG1GC`

- åˆ†ä»£æ”¶é›†
    - è™½ç„¶G1å¯ä»¥ç‹¬ç«‹ç®¡ç†æ•´ä¸ªå †, ä½†åŒæ ·å…·æœ‰åˆ†ä»£çš„æ¦‚å¿µ
- ç©ºé—´æ•´åˆ
    - ä»æ•´ä½“ä¸Šçœ‹æ˜¯åŸºäºæ ‡è®°æ•´ç†ç®—æ³•, å±€éƒ¨(ä¸¤ä¸ªRegionä¹‹é—´)ä¸ŠåŸºäºæ ‡è®°å¤åˆ¶ç®—æ³•, ç›¸æ¯”äºCMSä¸å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡
- å¯é¢„æµ‹çš„åœé¡¿
    - G1é™¤äº†è¿½æ±‚ä½åœé¡¿, è¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹, èƒ½è®©ä½¿ç”¨è€…æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸ºMæ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…, æ¶ˆè€—åœ¨åƒåœ¾æ”¶é›†ä¸Šçš„æ—¶é—´ä¸å¾—è¶…è¿‡Næ¯«ç§’
    - å‡ ä¹æ˜¯RTSJçš„ç‰¹å¾
- [JEP: å†…å­˜è¿”è¿˜](https://openjdk.org/jeps/346)`JDK12å‘å¸ƒ`

> [å‚è€ƒ: JVMç³»åˆ—ç¯‡ï¼šæ·±å…¥å‰–æG1æ”¶é›†å™¨](https://my.oschina.net/u/3959491/blog/3029276)

> å­—ç¬¦ä¸²å¸¸é‡æ± å»é‡ ç‰¹æ€§(8u20å¼•å…¥)  [UseStringDeduplication - ä¼˜ç¼ºç‚¹](https://gceasy.ycrash.cn/gc-recommendations/stringdeduplication-solution.jsp)
- `-XX:+UseStringDeduplication` é€‚ç”¨äºå¤§é‡ç›¸ä¼¼å­—ç¬¦ä¸²çš„åœºæ™¯é™ä½å†…å­˜å ç”¨ï¼Œä½†ä¼šå¢åŠ GCè´Ÿæ‹…ï¼Œé»˜è®¤ä¸å¼€å¯
    - æŸ¥çœ‹å­—ç¬¦ä¸²å»é‡ç»Ÿè®¡ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰ `-XX:+PrintStringDeduplicationStatistics` `-XX:+PrintStringTableStatistics`
    - è¾¾åˆ°è¯¥å¹´é¾„(ç»è¿‡GCæ¬¡æ•°)çš„Stringå¯¹è±¡è¢«è®¤ä¸ºæ˜¯å»é‡çš„å€™é€‰å¯¹è±¡ `-XX:StringDeDuplicationAgeThreshold`
- è¯¥ç­–ç•¥ä¸ä¼šæ¸…é™¤é‡å¤å­—ç¬¦ä¸²å¯¹è±¡æœ¬èº«ã€‚å…¶åªä¼šæ›¿æ¢åº•å±‚ char[ ] è¾¾åˆ°å¤ç”¨å†…å­˜çš„ç›®çš„ [Gitee æµ‹è¯•ä»£ç ](https://gitee.com/gin9/JavaBase/blob/master/class/src/main/java/jvm/gc/g1/StringDeduplication.java)

> JDK1.8æ—¶FullGCæ˜¯å•çº¿ç¨‹çš„ï¼Œ JDK10å¼€å§‹æ”¯æŒå¹¶è¡Œ

> [å‚è€ƒ: Java Hotspot G1 GCçš„ä¸€äº›å…³é”®æŠ€æœ¯](https://tech.meituan.com/2016/09/23/g1.html)  
> [Welcome 20% less memory usage for G1 remembered sets](https://tschatzl.github.io/2021/02/26/early-prune.html)  

G1æä¾›äº†ä¸¤ç§GCæ¨¡å¼ï¼ŒYoung GCå’ŒMixed GCï¼Œä¸¤ç§éƒ½æ˜¯å®Œå…¨Stop The Worldçš„
- Young GCï¼šé€‰å®šæ‰€æœ‰å¹´è½»ä»£é‡Œçš„Regionã€‚é€šè¿‡æ§åˆ¶å¹´è½»ä»£çš„regionä¸ªæ•°ï¼Œå³å¹´è½»ä»£å†…å­˜å¤§å°ï¼Œæ¥æ§åˆ¶young GCçš„æ—¶é—´å¼€é”€ã€‚ 
- Mixed GCï¼šé€‰å®šæ‰€æœ‰å¹´è½»ä»£é‡Œçš„Regionï¼Œå¤–åŠ æ ¹æ® global concurrent marking ç»Ÿè®¡å¾—å‡ºæ”¶é›†æ”¶ç›Šé«˜çš„è‹¥å¹²è€å¹´ä»£Regionã€‚åœ¨ç”¨æˆ·æŒ‡å®šçš„å¼€é”€ç›®æ ‡èŒƒå›´å†…å°½å¯èƒ½é€‰æ‹©æ”¶ç›Šé«˜çš„è€å¹´ä»£Regionã€‚

ç”±ä¸Šé¢çš„æè¿°å¯çŸ¥ï¼ŒMixed GCä¸æ˜¯full GCï¼Œå®ƒåªèƒ½å›æ”¶éƒ¨åˆ†è€å¹´ä»£çš„Regionï¼Œå¦‚æœmixed GCå®åœ¨æ— æ³•è·Ÿä¸Šç¨‹åºåˆ†é…å†…å­˜çš„é€Ÿåº¦ï¼Œå¯¼è‡´è€å¹´ä»£å¡«æ»¡æ— æ³•ç»§ç»­è¿›è¡ŒMixed GCï¼Œå°±ä¼šä½¿ç”¨serial old GCï¼ˆfull GCï¼‰æ¥æ”¶é›†æ•´ä¸ªGC heapã€‚  
æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒG1æ˜¯ä¸æä¾›full GCçš„ã€‚  

ä¸Šæ–‡ä¸­ï¼Œå¤šæ¬¡æåˆ°äº†global concurrent markingï¼Œå®ƒçš„æ‰§è¡Œè¿‡ç¨‹ç±»ä¼¼CMSï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯ï¼Œåœ¨G1 GCä¸­ï¼Œå®ƒä¸»è¦æ˜¯ä¸ºMixed GCæä¾›æ ‡è®°æœåŠ¡çš„ï¼Œå¹¶ä¸æ˜¯ä¸€æ¬¡GCè¿‡ç¨‹çš„ä¸€ä¸ªå¿…é¡»ç¯èŠ‚ã€‚  
global concurrent marking çš„æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š  
- **åˆå§‹æ ‡è®°**ï¼ˆinitial markï¼Œ`STW`ï¼‰: å®ƒæ ‡è®°äº†ä»GC Rootå¼€å§‹ç›´æ¥å¯è¾¾çš„å¯¹è±¡ã€‚
- **å¹¶å‘æ ‡è®°**ï¼ˆConcurrent Markingï¼‰: è¿™ä¸ªé˜¶æ®µä»GC Rootå¼€å§‹å¯¹heapä¸­çš„å¯¹è±¡æ ‡è®°ï¼Œæ ‡è®°çº¿ç¨‹ä¸åº”ç”¨ç¨‹åºçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œå¹¶ä¸”æ”¶é›†å„ä¸ªRegionçš„å­˜æ´»å¯¹è±¡ä¿¡æ¯ã€‚ 
- **æœ€ç»ˆæ ‡è®°**ï¼ˆRemarkï¼Œ`STW`ï¼‰: æ ‡è®°é‚£äº›åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µå‘ç”Ÿå˜åŒ–çš„å¯¹è±¡ï¼Œå°†è¢«å›æ”¶ã€‚
- **æ¸…é™¤åƒåœ¾**ï¼ˆCleanupï¼‰: æ¸…é™¤ç©ºRegionï¼ˆæ²¡æœ‰å­˜æ´»å¯¹è±¡çš„ï¼‰ï¼ŒåŠ å…¥åˆ°free listã€‚

ç¬¬ä¸€é˜¶æ®µinitial markæ˜¯å…±ç”¨äº†Young GCçš„æš‚åœï¼Œè¿™æ˜¯å› ä¸ºä»–ä»¬å¯ä»¥å¤ç”¨root scanæ“ä½œï¼Œæ‰€ä»¥å¯ä»¥è¯´global concurrent markingæ˜¯ä¼´éšYoung GCè€Œå‘ç”Ÿçš„ã€‚
ç¬¬å››é˜¶æ®µCleanupåªæ˜¯å›æ”¶äº†æ²¡æœ‰å­˜æ´»å¯¹è±¡çš„Regionï¼Œæ‰€ä»¥å®ƒå¹¶ä¸éœ€è¦STWã€‚

Young GCå‘ç”Ÿçš„æ—¶æœºå¤§å®¶éƒ½çŸ¥é“ï¼Œé‚£ä»€ä¹ˆæ—¶å€™å‘ç”ŸMixed GCå‘¢ï¼Ÿå…¶å®æ˜¯ç”±ä¸€äº›å‚æ•°æ§åˆ¶ç€çš„ï¼Œå¦å¤–ä¹Ÿæ§åˆ¶ç€å“ªäº›è€å¹´ä»£Regionä¼šè¢«é€‰å…¥CSetã€‚ 
- `G1HeapWastePercent`ï¼š åœ¨global concurrent markingç»“æŸä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“old gen regionsä¸­æœ‰å¤šå°‘ç©ºé—´è¦è¢«å›æ”¶ï¼Œåœ¨æ¯æ¬¡YGCä¹‹åå’Œå†æ¬¡å‘ç”ŸMixed GCä¹‹å‰ï¼Œä¼šæ£€æŸ¥åƒåœ¾å æ¯”æ˜¯å¦è¾¾åˆ°æ­¤å‚æ•°ï¼Œåªæœ‰è¾¾åˆ°äº†ï¼Œä¸‹æ¬¡æ‰ä¼šå‘ç”ŸMixed GCã€‚ 
- `G1MixedGCLiveThresholdPercent`ï¼š old generation regionä¸­çš„å­˜æ´»å¯¹è±¡çš„å æ¯”ï¼Œåªæœ‰åœ¨æ­¤å‚æ•°ä¹‹ä¸‹ï¼Œæ‰ä¼šè¢«é€‰å…¥CSetã€‚ 
- `G1MixedGCCountTarget`ï¼š ä¸€æ¬¡global concurrent markingä¹‹åï¼Œæœ€å¤šæ‰§è¡ŒMixed GCçš„æ¬¡æ•°ã€‚ 
- `G1OldCSetRegionThresholdPercent`ï¼š ä¸€æ¬¡Mixed GCä¸­èƒ½è¢«é€‰å…¥CSetçš„æœ€å¤šold generation regionæ•°é‡ã€‚

> G1 ç›¸å…³çš„é‡è¦å‚æ•°

| å‚æ•° | æè¿° |
|:----|:----|
| `-XX:MaxGCPauseMillis=200`  |  	è®¾ç½®æœ€å¤§åœé¡¿æ—¶é—´å€¼ã€‚é»˜è®¤å€¼ä¸º 200 æ¯«ç§’ã€‚|
| `-XX:G1HeapRegionSize=n`  |  	è®¾ç½® G1 åŒºåŸŸå¤§å°ã€‚å€¼å¿…é¡»ä¸º 2 çš„ N æ¬¡å¹‚ï¼Œå¦‚ï¼š256ã€512ã€1024...èŒƒå›´æ˜¯ 1MB è‡³ 32MBã€‚|
| `-XX:GCTimeRatio=12`  |  	    è®¾ç½®åº”ç”¨äº GC çš„æ€»ç›®æ ‡æ—¶é—´ä¸å¤„ç†å®¢æˆ·äº‹åŠ¡çš„æ€»æ—¶é—´ã€‚|
| `-XX:ParallelGCThreads=n`  |  	è®¾ç½® Stop-the-world å·¥ä½œçº¿ç¨‹çš„æ•°é‡ã€‚|
| `-XX:ConcGCThreads=n`  |  	    è®¾ç½®å¹¶è¡Œæ ‡è®°çº¿ç¨‹çš„æ•°é‡ã€‚å°† n å€¼è®¾ä¸ºå¹¶è¡Œåƒåœ¾å›æ”¶çº¿ç¨‹ï¼ˆParallelGCThreadsï¼‰æ•°çš„å¤§çº¦ 1/4ã€‚|
| `-XX:InitiatingHeapOccupancyPercent=45`  |  	å½“å †å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡æ­¤ç™¾åˆ†æ¯”æ—¶ä¼šè§¦å‘ GC æ ‡è®°å‘¨æœŸã€‚é»˜è®¤å€¼ä¸º 45%ã€‚|
| `-XX:G1NewSizePercent=5`  |  	è®¾ç½®ç”¨ä½œ Young ä»£ç©ºé—´å¤§å°çš„æœ€ä½å †å†…å­˜ç™¾åˆ†æ¯”ã€‚é»˜è®¤å€¼ä¸º Java å †å†…å­˜çš„ 5%ã€‚|
| `-XX:G1MaxNewSizePercent=60`  | è®¾ç½®ç”¨ä½œ Young ä»£ç©ºé—´å¤§å°çš„æœ€é«˜å †å†…å­˜ç™¾åˆ†æ¯”ã€‚é»˜è®¤å€¼ä¸º Java å †å†…å­˜çš„ 60%ã€‚|
| `-XX:G1OldCSetRegionThresholdPercent=10`  |  	è®¾ç½®æ··åˆåƒåœ¾å›æ”¶å‘¨æœŸä¸­è¦æ”¶é›†çš„ Old åŒºåŸŸæ•°é‡ä¸Šé™ã€‚é»˜è®¤ä¸º Java å †å†…å­˜çš„ 10%ã€‚|
| `-XX:G1ReservePercent=10`  |  	è®¾ç½®éœ€ä¿ç•™çš„å†…å­˜ç™¾åˆ†æ¯”ã€‚é»˜è®¤ä¸º 10%ã€‚G1 åƒåœ¾å›æ”¶å™¨ä¼šå§‹ç»ˆå°è¯•ä¿ç•™ 10% çš„å †å†…å­˜ç©ºé—´ç©ºé—²ã€‚|


GCTimeRatioï¼š ç¡®å®šç›®æ ‡ GC æ—¶é—´çš„å®é™…å…¬å¼ä¸º [1 / (1 + GCTimeRatio)]ã€‚é»˜è®¤å€¼ 12 è¡¨ç¤ºç›®æ ‡ GC æ—¶é—´ä¸º [1 / (1 + 12)]ï¼Œå³ 7.69%ã€‚
è¿™æ„å‘³ç€ JVM å¯å°† 7.69ï¼… çš„æ—¶é—´ç”¨äº GC æ´»åŠ¨ï¼Œå…¶ä½™ 92.3ï¼… ç”¨äºå¤„ç†å®¢æˆ·æ´»åŠ¨ã€‚

ParallelGCThreadsï¼š å¦‚æœé€»è¾‘å¤„ç†å™¨çš„æ•°é‡Må°äºæˆ–ç­‰äº 8 ä¸ªï¼Œåˆ™å°† n å€¼è®¾ç½®ä¸ºMã€‚å¦‚æœMä¸º5ï¼Œåˆ™å°† n è®¾ä¸º 5.å¦‚æœMä¸º 8 ä¸ªä»¥ä¸Šï¼Œè¯·å°†è¯¥å€¼è®¾ç½®ä¸ºå¤§çº¦ 5/8 * Mã€‚
è¿™ç§è®¾ç½®åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æœ‰æ•ˆï¼Œé™¤äº†è¾ƒå¤§è§„æ¨¡çš„ SPARC ç³»ç»Ÿâ€”â€”å…¶ä¸­ n å€¼å¯ä»¥å¤§çº¦æ˜¯ `5/16 * M`ã€‚

MaxGCPauseMillisï¼šG1å°†æ ¹æ®å…ˆå‰æ”¶é›†çš„ä¿¡æ¯ä»¥åŠæ£€æµ‹åˆ°çš„åƒåœ¾å¯¹è±¡é‡é¢„ä¼°å¯ä»¥æ‰§è¡Œå›æ”¶çš„åƒåœ¾åŒºåŸŸï¼Œå°½é‡ä¿è¯GCæ—¶é—´ä¸è¶…è¿‡è®¾ç½®çš„å€¼ã€‚

ParallelGCThreads: ä½¿ç”¨é»˜è®¤å€¼å°±å¯ä»¥äº†ã€‚ä½†æ˜¯åœ¨JREç‰ˆæœ¬1.8.0_131ä¹‹å‰ï¼ŒJVMæ— æ³•æ„ŸçŸ¥Dockerçš„CPUé™åˆ¶ï¼Œä¼šä½¿ç”¨å®¿ä¸»æœºçš„é€»è¾‘æ ¸æ•°è®¡ç®—é»˜è®¤å€¼ã€‚  
è¿™é€šå¸¸ä¼šè¿œè¶…è¿‡å®¹å™¨çš„æ ¸æ•°, è¿‡å¤šçš„GCçº¿ç¨‹æ•°æŠ¢å äº†ä¸šåŠ¡çº¿ç¨‹çš„CPUæ—¶é—´ï¼ŒåŠ ä¸Šçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œè¾ƒå¤§çš„é™ä½äº†ååé‡ã€‚å› æ­¤JRE 1.8.0_131ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œæœªæ˜ç¡®æŒ‡å®šParallelGCThreadsä¼šæœ‰è¾ƒå¤§çš„é£é™©ã€‚

ConcGCThreads ä¸€èˆ¬ç§°ä¸ºå¹¶å‘æ ‡è®°çº¿ç¨‹æ•°ï¼Œä¸ºäº†å‡å°‘GCçš„STWçš„æ—¶é—´ï¼ŒCMSå’ŒG1éƒ½æœ‰å¹¶å‘æ ‡è®°çš„è¿‡ç¨‹ï¼Œæ­¤æ—¶ä¸šåŠ¡çº¿ç¨‹ä»åœ¨å·¥ä½œï¼Œåªæ˜¯å¹¶å‘æ ‡è®°æ˜¯CPUå¯†é›†å‹ä»»åŠ¡ï¼Œä¸šåŠ¡çš„ååé‡ä¼šä¸‹é™ï¼ŒRTä¼šå˜é•¿ã€‚
ConcGCThreadsçš„é»˜è®¤å€¼ä¸åŒGCç­–ç•¥ç•¥æœ‰ä¸åŒï¼ŒCMSä¸‹æ˜¯(ParallelGCThreads + 3) / 4 å‘ä¸‹å–æ•´ï¼ŒG1ä¸‹æ˜¯ParallelGCThreads / 4 å››èˆäº”å…¥ã€‚ä¸€èˆ¬æ¥è¯´é‡‡ç”¨é»˜è®¤å€¼å°±å¯ä»¥äº†ï¼Œä½†æ˜¯è¿˜æ˜¯ç”±äºåœ¨JREç‰ˆæœ¬1.8.0_131ä¹‹å‰ï¼ŒJVMæ— æ³•æ„ŸçŸ¥Dockerçš„èµ„æºé™åˆ¶çš„é—®é¢˜ï¼ŒConcGCThreadsçš„é»˜è®¤å€¼ä¼šæ¯”è¾ƒå¤§ï¼ˆ20å·¦å³ï¼‰ï¼Œå¯¹ä¸šåŠ¡ä¼šæœ‰å½±å“ã€‚

************************

## ZGC
> [wiki: ZGC](https://wiki.openjdk.java.net/display/zgc/Main) | [JEP 377 ZGC](https://openjdk.org/jeps/377) | [ZGC Release note](https://www.oracle.com/technetwork/java/javase/11-relnote-issues-5012449.html#JDK-8197831)

- `-XX:+UseZGC` JDK11å¼•å…¥ï¼ŒJDK15æ­£å¼ä½¿ç”¨ï¼Œå› æ­¤JDK11-14éœ€è¦è¿½åŠ å‚æ•°`-XX:+UnlockExperimentalVMOptions`

> [å‚è€ƒ: Oracle å³å°†å‘å¸ƒçš„å…¨æ–° Java åƒåœ¾æ”¶é›†å™¨ ZGC](https://www.infoq.cn/article/oracle-release-java-gc-zgc)
> [å‚è€ƒ: ç¾å›¢ï¼šæ–°ä¸€ä»£åƒåœ¾å›æ”¶å™¨ZGCçš„æ¢ç´¢ä¸å®è·µ](https://tech.meituan.com/2020/08/06/new-zgc-practice-in-meituan.html)  

- [JDK21 ZGC æ”¯æŒå†…å­˜åˆ†ä»£](https://openjdk.org/jeps/439)
- [JDK13 ZGC æ”¯æŒå†…å­˜è¿”è¿˜](https://openjdk.org/jeps/351)

************************

## ShenandoahGC
> JDK12  [wiki: ShenandoahGC](https://wiki.openjdk.java.net/display/shenandoah/Main)

> [å‚è€ƒ: JDK12 ShenandoahGCå°è¯•ç‰›åˆ€](https://juejin.im/post/5c934a5d5188252dad05d82a)  

-XX:+UnlockExperimentalVMOptions  -XX:+UseShenandoahGC

## Epsilon
> JDK11 [A No-Op Garbage Collector](https://openjdk.org/jeps/318)

- `-XX:+UseEpsilonGC -XX:+UnlockExperimentalVMOptions` ç›´è‡³22å°šæœªGA

ä¸åšGCçš„GCï¼Œå³ä¸åšåƒåœ¾å›æ”¶ï¼Œé€šå¸¸ç”¨äºç›®æ ‡æµ‹è¯•GCçš„å¯¹ç…§ç»„

************************

# æœ€ä½³å®è·µ
[Choosing a GC Algorithm in Java](https://www.baeldung.com/java-choosing-gc-algorithm)  
[Tuning Garbage Collection with Oracle JDK](https://docs.oracle.com/cd/E55119_01/doc.71/e55122/cnf_jvmgc.htm#WSEAD414)  

